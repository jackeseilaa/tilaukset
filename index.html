<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Absolut 37 ‚Äî Tilausten hallinta | J Sailing 2026</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0e4a7a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="J Sailing Tilaukset">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚õµ</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,400&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --navy: #0e4a7a; --navy-light: #1a6fb5; --navy-dark: #0b3d6b;
    --green: #22c55e; --green-dark: #15803d; --yellow: #f59e0b; --red: #ef4444;
    --slate-50: #f8fafc; --slate-100: #f1f5f9; --slate-200: #e2e8f0; --slate-300: #cbd5e1;
    --slate-400: #94a3b8; --slate-500: #64748b; --slate-600: #475569; --slate-700: #334155;
    --slate-800: #1e293b; --slate-900: #0f172a;
    --radius: 14px; --radius-sm: 8px; --radius-xs: 6px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.06); --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
    --shadow-lg: 0 25px 50px -12px rgba(0,0,0,0.25);
    --font: 'DM Sans', -apple-system, sans-serif;
    --font-display: 'Playfair Display', serif;
  }
  body { font-family: var(--font); background: #f0f4f8; color: var(--slate-900); min-height: 100vh; -webkit-font-smoothing: antialiased; }
  input, select, textarea, button { font-family: var(--font); }
  ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: var(--slate-300); border-radius: 3px; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

  /* Header */
  .header { background: linear-gradient(135deg, var(--navy-dark) 0%, var(--navy) 50%, var(--navy-light) 100%); padding: 20px 24px 16px; position: relative; overflow: hidden; }
  .header-wave { position: absolute; inset: 0; opacity: 0.06; background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 30 Q15 20 30 30 Q45 40 60 30' fill='none' stroke='white' stroke-width='1'/%3E%3C/svg%3E"); background-size: 60px 60px; }
  .header-inner { position: relative; z-index: 1; display: flex; align-items: center; gap: 12; }
  .header-icon { width: 38px; height: 38px; border-radius: 10px; background: rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; }
  .header h1 { font-family: var(--font-display); font-size: 22px; font-weight: 800; color: #fff; letter-spacing: -0.01em; }
  .header p { font-size: 11px; color: rgba(255,255,255,0.65); font-weight: 500; letter-spacing: 0.08em; }

  /* Nav */
  .nav { display: flex; background: #fff; border-bottom: 1px solid var(--slate-200); box-shadow: var(--shadow-sm); overflow-x: auto; position: sticky; top: 0; z-index: 100; }
  .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px; padding: 12px 8px 10px; border: none; cursor: pointer; background: transparent; color: var(--slate-400); border-bottom: 2.5px solid transparent; font-weight: 600; font-size: 11px; letter-spacing: 0.02em; transition: all 0.15s; min-width: 80px; }
  .nav-btn.active { background: #f0f7ff; color: var(--navy); border-bottom-color: var(--navy-light); }
  .nav-btn:hover:not(.active) { background: var(--slate-50); color: var(--slate-600); }
  .nav-btn svg { width: 18px; height: 18px; }

  /* Content */
  .content { padding: 16px; max-width: 960px; margin: 0 auto; animation: fadeIn 0.2s ease; }

  /* Cards */
  .card { background: #fff; border-radius: var(--radius); padding: 16px; margin-bottom: 10px; box-shadow: var(--shadow-sm); }
  .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }

  /* KPI Grid */
  .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .kpi-card { background: #fff; border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow-sm); }
  .kpi-label { font-size: 11px; font-weight: 600; color: var(--slate-400); letter-spacing: 0.04em; margin-bottom: 4px; }
  .kpi-value { font-size: 22px; font-weight: 800; color: var(--slate-900); }
  .kpi-sub { font-size: 11px; color: var(--slate-500); margin-top: 2px; }

  /* Status badge */
  .badge { display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; letter-spacing: 0.02em; white-space: nowrap; }
  .badge-avoin { background: #e0f2fe; color: #0369a1; border: 1px solid #7dd3fc; }
  .badge-taynn√§ { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
  .badge-peruutettu { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
  .badge-toteutunut { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
  .badge-varaus { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
  .badge-ilmoittautunut { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
  .badge-laskutettu { background: #ffedd5; color: #9a3412; border: 1px solid #fdba74; }
  .badge-maksettu { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }

  /* Source badge */
  .src-badge { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 999px; }
  .src-aaltosail { background: #dbeafe; color: #1e40af; }
  .src-kes√§purje { background: #fef3c7; color: #92400e; }
  .src-oma { background: #d1fae5; color: #065f46; }
  .src-muut { background: #f3e8ff; color: #7c3aed; }

  /* Capacity bar */
  .cap-bar { display: flex; align-items: center; gap: 8px; }
  .cap-track { flex: 1; height: 6px; border-radius: 3px; background: #e5e7eb; overflow: hidden; min-width: 48px; }
  .cap-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
  .cap-text { font-size: 12px; font-weight: 600; white-space: nowrap; }

  /* Buttons */
  .btn { padding: 10px 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: 700; font-size: 14px; transition: transform 0.1s, box-shadow 0.15s; display: inline-flex; align-items: center; gap: 6px; }
  .btn:active { transform: scale(0.97); }
  .btn-primary { background: linear-gradient(135deg, var(--navy), var(--navy-light)); color: #fff; box-shadow: 0 2px 8px rgba(14,74,122,0.3); }
  .btn-secondary { background: var(--slate-100); color: var(--slate-600); box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
  .btn-success { background: linear-gradient(135deg, var(--green-dark), var(--green)); color: #fff; box-shadow: 0 2px 6px rgba(21,128,61,0.3); }
  .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: var(--radius-sm); }
  .btn-xs { padding: 5px 8px; font-size: 10px; border-radius: var(--radius-sm); }
  .btn-icon { background: none; border: 1px solid var(--slate-300); border-radius: var(--radius-sm); padding: 5px 8px; cursor: pointer; color: var(--slate-500); display: inline-flex; align-items: center; }
  .btn-icon:hover { background: var(--slate-50); }
  .btn-icon.danger { border-color: #fecaca; color: var(--red); }
  .btn-icon.success { border-color: #86efac; color: var(--green-dark); }
  .btn-icon.warn { border-color: #fcd34d; color: #d97706; }

  /* Form */
  .form-field { margin-bottom: 14px; }
  .form-label { display: block; font-size: 12px; font-weight: 600; color: var(--slate-600); margin-bottom: 5px; letter-spacing: 0.03em; }
  .form-label .req { color: var(--red); }
  .form-input { width: 100%; padding: 9px 12px; border-radius: var(--radius-sm); border: 1.5px solid var(--slate-300); font-size: 14px; outline: none; transition: border 0.15s; background: #fff; }
  .form-input:focus { border-color: var(--navy-light); box-shadow: 0 0 0 3px rgba(26,111,181,0.12); }
  .form-input:disabled { background: var(--slate-100); color: var(--slate-400); }
  .form-row { display: grid; gap: 0 12px; }
  .form-row-2 { grid-template-columns: 1fr 1fr; }
  .form-row-3 { grid-template-columns: 1fr 1fr 1fr; }

  /* Modal */
  .modal-overlay { position: fixed; inset: 0; z-index: 1000; background: rgba(2,6,23,0.45); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; animation: fadeIn 0.15s ease; }
  .modal-box { background: #fff; border-radius: 16px; width: 90%; max-width: 540px; max-height: 90vh; overflow: auto; box-shadow: var(--shadow-lg); animation: slideUp 0.2s ease; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px 16px; border-bottom: 1px solid var(--slate-200); }
  .modal-header h3 { font-size: 17px; font-weight: 700; color: var(--slate-900); }
  .modal-body { padding: 20px 24px 24px; }
  .modal-close { background: none; border: none; cursor: pointer; color: var(--slate-400); padding: 4px; }

  /* Misc */
  .flex { display: flex; } .flex-between { justify-content: space-between; } .flex-center { align-items: center; }
  .gap-4 { gap: 4px; } .gap-6 { gap: 6px; } .gap-8 { gap: 8px; } .gap-10 { gap: 10px; } .gap-16 { gap: 16px; }
  .flex-wrap { flex-wrap: wrap; } .flex-1 { flex: 1; } .shrink-0 { flex-shrink: 0; }
  .text-right { text-align: right; } .text-center { text-align: center; }
  .mt-4 { margin-top: 4px; } .mt-8 { margin-top: 8px; } .mt-10 { margin-top: 10px; }
  .mb-4 { margin-bottom: 4px; } .mb-8 { margin-bottom: 8px; } .mb-12 { margin-bottom: 12px; } .mb-16 { margin-bottom: 16px; }
  .fw-500 { font-weight: 500; } .fw-600 { font-weight: 600; } .fw-700 { font-weight: 700; }
  .fs-11 { font-size: 11px; } .fs-12 { font-size: 12px; } .fs-13 { font-size: 13px; } .fs-14 { font-size: 14px; } .fs-15 { font-size: 15px; }
  .color-muted { color: var(--slate-500); } .color-light { color: var(--slate-400); } .color-dark { color: var(--slate-900); } .color-red { color: var(--red); }
  .border-left-blue { border-left: 4px solid var(--navy-light); }
  .border-left-green { border-left: 4px solid var(--green); }
  .border-left-yellow { border-left: 4px solid var(--yellow); }
  .border-left-red { border-left: 4px solid var(--red); }
  .opacity-50 { opacity: 0.5; }
  .divider { border-bottom: 1px solid var(--slate-100); }
  .divider-strong { border-top: 2px solid var(--slate-200); }
  .empty-state { text-align: center; padding: 40px; color: var(--slate-400); }
  .empty-state .icon { font-size: 40px; margin-bottom: 8px; }
  .filter-bar { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
  .filter-bar .form-input { min-width: 100px; }

  /* Data export */
  .export-bar { display: flex; gap: 8px; margin-bottom: 16px; padding: 12px 16px; background: #fff; border-radius: var(--radius); box-shadow: var(--shadow-sm); align-items: center; }
  .export-bar .info { flex: 1; font-size: 12px; color: var(--slate-500); }

  @media (max-width: 480px) {
    .kpi-grid { grid-template-columns: 1fr; }
    .form-row-3 { grid-template-columns: 1fr; }
    .filter-bar { flex-direction: column; }
  }
</style>
</head>
<body>

<div id="app"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ABSOLUT 37 ‚Äî BOOKING MANAGEMENT SYSTEM
// J Sailing ‚Äî Kausi 2026
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const STORAGE_KEY = 'absolut37_booking_v1';
const MAX_CAPACITY = 6;
const SAILING_TYPES = ['Iltapurjehdus', 'P√§iv√§purjehdus', 'Charter', 'Kurssi', 'Yritystilaisuus', 'Muu'];
const SOURCES = ['Aaltosail', 'Kes√§purje', 'Muut', 'Oma'];
const CUSTOMER_STATUSES = ['Varaus', 'Ilmoittautunut', 'Laskutettu', 'Maksettu', 'Peruutettu'];
const SAILING_STATUSES = ['Avoin', 'T√§ynn√§', 'Peruutettu', 'Toteutunut'];

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
let state = {
  activeTab: 'dashboard',
  sailings: [],
  customers: [],
  filterSource: 'Kaikki',
  filterSailing: 'Kaikki',
  searchTerm: '',
  modal: null, // null | 'sailing' | 'customer'
  editingId: null,
  form: {},
};

// ‚îÄ‚îÄ‚îÄ Storage ‚îÄ‚îÄ‚îÄ
function loadState() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const data = JSON.parse(saved);
      state.sailings = data.sailings || [];
      state.customers = data.customers || [];
    }
  } catch(e) { console.warn('Load failed:', e); }
  if (state.sailings.length === 0 && state.customers.length === 0) {
    state.sailings = [{
      id: 'E001', date: '2026-05-21', time: '17:00', type: 'Kurssi',
      name: 'Purjehduskurssi', pricePerPerson: 560, minPersons: 2, maxPersons: 5,
      status: 'Avoin', notes: ''
    }];
    state.customers = [{
      id: 'V001', name: 'Sauli Ketola', phone: '', email: '',
      source: 'Aaltosail', sailingId: 'E001', agreedPrice: 476,
      commissionPct: 15, status: 'Varaus', invoiced: 0, paid: 0, paidDate: null, notes: ''
    }];
  }
}

function saveState() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      sailings: state.sailings,
      customers: state.customers,
    }));
  } catch(e) { console.warn('Save failed:', e); }
}

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ
function genId(prefix, list) {
  const nums = list.map(i => parseInt(i.id.replace(prefix, ''))).filter(n => !isNaN(n));
  const next = nums.length ? Math.max(...nums) + 1 : 1;
  return prefix + String(next).padStart(3, '0');
}

function fmtDate(d) {
  if (!d) return '';
  const dt = new Date(d + 'T00:00:00');
  return dt.toLocaleDateString('fi-FI', { day: 'numeric', month: 'numeric', year: 'numeric' });
}

function fmtCur(v) { return Number(v || 0).toFixed(2) + ' ‚Ç¨'; }

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function getBookings(sailingId) {
  const custs = state.customers.filter(c => c.sailingId === sailingId && c.status !== 'Peruutettu');
  return {
    booked: custs.length,
    paid: custs.filter(c => c.status === 'Maksettu').length,
    invoiced: custs.reduce((a,c) => a + (c.invoiced||0), 0),
    totalPaid: custs.reduce((a,c) => a + (c.paid||0), 0),
  };
}

function getFree(sailing) {
  const b = getBookings(sailing.id);
  return Math.max(0, (sailing.maxPersons || MAX_CAPACITY) - b.booked);
}

function badgeClass(status) {
  const map = {
    'Avoin':'avoin','T√§ynn√§':'taynn√§','Peruutettu':'peruutettu','Toteutunut':'toteutunut',
    'Varaus':'varaus','Ilmoittautunut':'ilmoittautunut','Laskutettu':'laskutettu','Maksettu':'maksettu'
  };
  return 'badge badge-' + (map[status] || 'avoin');
}

function srcClass(source) {
  const map = {'Aaltosail':'aaltosail','Kes√§purje':'kes√§purje','Oma':'oma','Muut':'muut'};
  return 'src-badge src-' + (map[source] || 'muut');
}

function borderClass(status) {
  if (status === 'Maksettu' || status === 'Toteutunut') return 'border-left-green';
  if (status === 'Laskutettu' || status === 'Ilmoittautunut' || status === 'T√§ynn√§') return 'border-left-yellow';
  if (status === 'Peruutettu') return 'border-left-red';
  return 'border-left-blue';
}

function capBar(booked, max) {
  const pct = max > 0 ? (booked / max) * 100 : 0;
  const color = pct >= 100 ? 'var(--red)' : pct >= 66 ? 'var(--yellow)' : 'var(--green)';
  return `<div class="cap-bar">
    <div class="cap-track"><div class="cap-fill" style="width:${Math.min(pct,100)}%;background:${color}"></div></div>
    <span class="cap-text" style="color:${color}">${booked}/${max}</span>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ SVG Icons ‚îÄ‚îÄ‚îÄ
const icons = {
  dashboard: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>',
  anchor: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"/><line x1="12" y1="22" x2="12" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></svg>',
  users: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
  invoice: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
  plus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  edit: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
  trash: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
  check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20,6 9,17 4,12"/></svg>',
  x: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  download: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
  upload: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
};

function icon(name, size=18) {
  return `<span style="display:inline-flex;width:${size}px;height:${size}px">${icons[name]||''}</span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function render() {
  const app = document.getElementById('app');
  app.innerHTML = renderHeader() + renderNav() + `<div class="content">${renderContent()}</div>` + renderModal();
  bindEvents();
}

function renderHeader() {
  return `<div class="header">
    <div class="header-wave"></div>
    <div class="header-inner">
      <div class="header-icon">‚õµ</div>
      <div>
        <h1>ABSOLUT 37</h1>
        <p>J SAILING ‚Äî KAUSI 2026</p>
      </div>
    </div>
  </div>`;
}

function renderNav() {
  const tabs = [
    { id: 'dashboard', label: 'Dashboard', icon: 'dashboard' },
    { id: 'sailings', label: 'Purjehdukset', icon: 'anchor' },
    { id: 'customers', label: 'Asiakkaat', icon: 'users' },
    { id: 'invoicing', label: 'Laskutus', icon: 'invoice' },
  ];
  return `<div class="nav">${tabs.map(t =>
    `<button class="nav-btn ${state.activeTab===t.id?'active':''}" data-tab="${t.id}">
      ${icon(t.icon)} ${esc(t.label)}
    </button>`
  ).join('')}</div>`;
}

function renderContent() {
  switch(state.activeTab) {
    case 'dashboard': return renderDashboard();
    case 'sailings': return renderSailings();
    case 'customers': return renderCustomers();
    case 'invoicing': return renderInvoicing();
    default: return '';
  }
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ
function renderDashboard() {
  const active = state.sailings.filter(s => s.status !== 'Peruutettu');
  const activeCust = state.customers.filter(c => c.status !== 'Peruutettu');
  const paidCust = activeCust.filter(c => c.status === 'Maksettu');
  const totalInv = activeCust.reduce((a,c) => a+(c.invoiced||0), 0);
  const totalPaid = activeCust.reduce((a,c) => a+(c.paid||0), 0);
  const totalComm = activeCust.filter(c => c.source==='Aaltosail'||c.source==='Kes√§purje')
    .reduce((a,c) => a + (c.agreedPrice*(c.commissionPct||0)/100), 0);
  const totalCap = active.reduce((a,s) => a+(s.maxPersons||MAX_CAPACITY), 0);
  const fillRate = totalCap > 0 ? (activeCust.length / totalCap * 100) : 0;
  const openRec = totalInv - totalPaid;

  let html = `<div class="kpi-grid">
    <div class="kpi-card" style="border-left:4px solid var(--navy)">
      <div class="kpi-label">PURJEHDUKSIA</div>
      <div class="kpi-value">${active.length}</div>
      <div class="kpi-sub">${active.filter(s=>s.status==='Avoin').length} avointa</div>
    </div>
    <div class="kpi-card" style="border-left:4px solid #0d9488">
      <div class="kpi-label">OSALLISTUJIA</div>
      <div class="kpi-value">${activeCust.length}</div>
      <div class="kpi-sub">${paidCust.length} maksanut</div>
    </div>
    <div class="kpi-card" style="border-left:4px solid #d97706">
      <div class="kpi-label">LASKUTETTU</div>
      <div class="kpi-value">${fmtCur(totalInv)}</div>
      <div class="kpi-sub">Maksettu ${fmtCur(totalPaid)}</div>
    </div>
    <div class="kpi-card" style="border-left:4px solid var(--red)">
      <div class="kpi-label">AVOIN SAATAVA</div>
      <div class="kpi-value">${fmtCur(openRec)}</div>
      <div class="kpi-sub">Provisiot ${fmtCur(totalComm)}</div>
    </div>
  </div>`;

  // Fill rate
  html += `<div class="card mb-16">
    <div class="fs-12 fw-600 color-muted mb-8">T√§ytt√∂aste</div>
    <div style="height:10px;border-radius:5px;background:#e5e7eb;overflow:hidden">
      <div style="height:100%;border-radius:5px;width:${fillRate.toFixed(0)}%;background:linear-gradient(90deg,var(--green),var(--green-dark));transition:width 0.5s"></div>
    </div>
    <div class="fs-12 color-muted mt-4">${fillRate.toFixed(0)}%</div>
  </div>`;

  // By source
  html += `<div class="card">
    <div class="fs-12 fw-600 color-muted mb-12">Asiakkaat l√§hteitt√§in</div>`;
  SOURCES.forEach(src => {
    const sc = activeCust.filter(c => c.source === src);
    const paid = sc.reduce((a,c) => a+(c.paid||0), 0);
    const comm = (src==='Aaltosail'||src==='Kes√§purje') ? sc.reduce((a,c)=>a+(c.agreedPrice*(c.commissionPct||0)/100),0) : 0;
    html += `<div class="flex flex-between flex-center divider" style="padding:8px 0">
      <div><span class="fw-600 fs-13 color-dark">${esc(src)}</span> <span class="fs-12 color-light">${sc.length} hl√∂</span></div>
      <div class="text-right">
        <div class="fs-13 fw-600 color-dark">${fmtCur(paid)}</div>
        ${comm > 0 ? `<div class="fs-11 color-red">Provisio: ${fmtCur(comm)}</div>` : ''}
      </div>
    </div>`;
  });
  html += `</div>`;

  // Export bar
    // Export bar
  html += `<div class="export-bar mt-10">
    <div class="info">üíæ Data tallentuu automaattisesti t√§h√§n laitteeseen (offline). Tee varmuuskopio s√§√§nn√∂llisesti iCloudiin.</div>
    <button class="btn btn-secondary btn-sm" onclick="exportData()">${icon('download',14)} Varmuuskopio (JSON)</button>
    <label class="btn btn-secondary btn-sm" style="cursor:pointer">${icon('upload',14)} Tuo (JSON)
      <input type="file" accept=".json" style="display:none" onchange="importData(event)">
    </label>
    <button class="btn btn-secondary btn-sm" onclick="exportCustomersCSV()">CSV Asiakkaat</button>
    <button class="btn btn-secondary btn-sm" onclick="exportSailingsCSV()">CSV Purjehdukset</button>
    <button class="btn btn-secondary btn-sm" onclick="exportAccountingCSV()">Kirjanpito CSV</button>
    <button class="btn btn-secondary btn-sm" onclick="saveToFileDirect()">Tallenna tiedostoon</button>
  </div>`;
</div>`;

  return html;
}

// ‚îÄ‚îÄ‚îÄ SAILINGS ‚îÄ‚îÄ‚îÄ
function renderSailings() {
  let html = `<div class="flex flex-between flex-center mb-12">
    <h2 class="fs-15 fw-700 color-dark" style="font-size:17px">Purjehdukset</h2>
    <button class="btn btn-primary btn-sm" data-action="new-sailing">${icon('plus',16)} Uusi</button>
  </div>`;

  if (state.sailings.length === 0) {
    html += `<div class="empty-state"><div class="icon">‚õµ</div><p>Ei purjehduksia viel√§. Luo ensimm√§inen!</p></div>`;
    return html;
  }

  // Sort by date
  const sorted = [...state.sailings].sort((a,b) => (a.date||'').localeCompare(b.date||''));

  sorted.forEach(s => {
    const b = getBookings(s.id);
    const max = s.maxPersons || MAX_CAPACITY;
    const free = Math.max(0, max - b.booked);
    const isFull = b.booked >= max;
    const displayStatus = isFull && s.status === 'Avoin' ? 'T√§ynn√§' : s.status;

    html += `<div class="card ${borderClass(displayStatus)} ${s.status==='Peruutettu'?'opacity-50':''}">
      <div class="card-header">
        <div>
          <div class="flex flex-center gap-8 flex-wrap">
            <span class="fw-700 fs-15 color-dark">${esc(s.name)}</span>
            <span class="${badgeClass(displayStatus)}">${esc(displayStatus)}</span>
          </div>
          <div class="fs-12 color-muted mt-4">
            ${esc(s.id)} ‚Ä¢ ${fmtDate(s.date)} ${s.time ? 'klo '+esc(s.time) : ''} ‚Ä¢ ${esc(s.type)} ‚Ä¢ ${fmtCur(s.pricePerPerson)}/hl√∂
          </div>
        </div>
        <div class="flex gap-6 shrink-0">
          <button class="btn-icon" data-action="edit-sailing" data-id="${s.id}" title="Muokkaa">${icon('edit',14)}</button>
          <button class="btn-icon danger" data-action="delete-sailing" data-id="${s.id}" title="Poista">${icon('trash',14)}</button>
        </div>
      </div>
      ${capBar(b.booked, max)}
      <div class="flex gap-16 mt-8 fs-11 color-muted">
        <span>Varatut: ${b.booked}</span>
        <span>Maksetut: ${b.paid}</span>
        <span>Vapaana: ${free}</span>
      </div>
      ${s.status !== 'Peruutettu' && free > 0 ? `<button class="btn btn-secondary btn-sm mt-10" data-action="add-customer-to" data-sailing="${s.id}">${icon('plus',14)} Lis√§√§ asiakas</button>` : ''}
    </div>`;
  });

  return html;
}

// ‚îÄ‚îÄ‚îÄ CUSTOMERS ‚îÄ‚îÄ‚îÄ
function renderCustomers() {
  let html = `<div class="flex flex-between flex-center mb-12">
    <h2 class="fs-15 fw-700 color-dark" style="font-size:17px">Asiakkaat & Varaukset</h2>
    <button class="btn btn-primary btn-sm" data-action="new-customer">${icon('plus',16)} Uusi</button>
  </div>`;

  // Filters
  html += `<div class="filter-bar">
    <input class="form-input flex-1" placeholder="Haku nimell√§..." value="${esc(state.searchTerm)}" data-filter="search">
    <select class="form-input" style="width:auto;min-width:110px" data-filter="source">
      <option value="Kaikki" ${state.filterSource==='Kaikki'?'selected':''}>Kaikki l√§hteet</option>
      ${SOURCES.map(s => `<option value="${s}" ${state.filterSource===s?'selected':''}>${s}</option>`).join('')}
    </select>
    <select class="form-input" style="width:auto;min-width:130px" data-filter="sailing">
      <option value="Kaikki" ${state.filterSailing==='Kaikki'?'selected':''}>Kaikki purjehdukset</option>
      ${state.sailings.map(s => `<option value="${s.id}" ${state.filterSailing===s.id?'selected':''}>${esc(s.name)} (${fmtDate(s.date)})</option>`).join('')}
    </select>
  </div>`;

  // Filter customers
  let filtered = state.customers.filter(c => {
    if (state.filterSource !== 'Kaikki' && c.source !== state.filterSource) return false;
    if (state.filterSailing !== 'Kaikki' && c.sailingId !== state.filterSailing) return false;
    if (state.searchTerm && !c.name.toLowerCase().includes(state.searchTerm.toLowerCase())) return false;
    return true;
  });

  if (filtered.length === 0) {
    html += `<div class="empty-state"><p>Ei asiakkaita haulle.</p></div>`;
    return html;
  }

  filtered.forEach(c => {
    const sailing = state.sailings.find(s => s.id === c.sailingId);
    html += `<div class="card ${borderClass(c.status)} ${c.status==='Peruutettu'?'opacity-50':''}">
      <div class="flex flex-between" style="align-items:flex-start">
        <div>
          <div class="flex flex-center gap-8 flex-wrap">
            <span class="fw-700 fs-14 color-dark">${esc(c.name)}</span>
            <span class="${badgeClass(c.status)}">${esc(c.status)}</span>
            <span class="${srcClass(c.source)}">${esc(c.source)}</span>
          </div>
          <div class="fs-12 color-muted" style="margin-top:3px">
            ${esc(c.id)} ‚Ä¢ ${sailing ? esc(sailing.name)+' ('+fmtDate(sailing.date)+')' : esc(c.sailingId)}
          </div>
          <div class="fs-12 mt-4" style="color:var(--slate-600)">
            Hinta: <strong>${fmtCur(c.agreedPrice)}</strong>
            ${c.commissionPct > 0 ? `<span class="color-red"> ‚Ä¢ Provisio: ${c.commissionPct}% = ${fmtCur(c.agreedPrice*c.commissionPct/100)}</span>` : ''}
          </div>
          ${(c.phone||c.email) ? `<div class="fs-11 color-light mt-4">${c.phone?esc(c.phone):''}${c.phone&&c.email?' ‚Ä¢ ':''}${c.email?esc(c.email):''}</div>` : ''}
        </div>
        <div class="flex gap-4 shrink-0">
          ${c.status==='Varaus' ? `<button class="btn-icon warn" data-action="invoice-customer" data-id="${c.id}" title="Laskuta">${icon('invoice',14)}</button>` : ''}
          ${(c.status==='Laskutettu'||c.status==='Ilmoittautunut') ? `<button class="btn-icon success" data-action="pay-customer" data-id="${c.id}" title="Maksettu">${icon('check',14)}</button>` : ''}
          <button class="btn-icon" data-action="edit-customer" data-id="${c.id}" title="Muokkaa">${icon('edit',14)}</button>
          <button class="btn-icon danger" data-action="delete-customer" data-id="${c.id}" title="Poista">${icon('trash',14)}</button>
        </div>
      </div>
    </div>`;
  });

  return html;
}

// ‚îÄ‚îÄ‚îÄ INVOICING ‚îÄ‚îÄ‚îÄ
function renderInvoicing() {
  let html = `<h2 class="fw-700 color-dark mb-4" style="font-size:17px">Laskutus</h2>
    <p class="fs-12 color-muted mb-16">Asiakkaat ryhmitelty laskutettavaksi. Sama asiakas voi maksaa useamman purjehduksen yhdell√§ laskulla.</p>`;

  // Group by customer name + source
  const groups = {};
  state.customers.filter(c => c.status !== 'Peruutettu').forEach(c => {
    const key = c.name + '___' + c.source;
    if (!groups[key]) groups[key] = { name: c.name, source: c.source, items: [] };
    groups[key].items.push(c);
  });
  const groupList = Object.values(groups);

  if (groupList.length === 0) {
    html += `<div class="empty-state">Ei laskutettavia.</div>`;
    return html;
  }

  groupList.forEach((group, gi) => {
    const totalAgreed = group.items.reduce((a,c) => a + c.agreedPrice, 0);
    const allPaid = group.items.every(c => c.status === 'Maksettu');
    const anyUnpaid = group.items.some(c => c.status !== 'Maksettu' && c.status !== 'Peruutettu');
    const totalComm = (group.source==='Aaltosail'||group.source==='Kes√§purje')
      ? group.items.reduce((a,c) => a + (c.agreedPrice*(c.commissionPct||0)/100), 0) : 0;

    html += `<div class="card ${allPaid?'border-left-green':'border-left-yellow'}" style="margin-bottom:12px">
      <div class="flex flex-between flex-center mb-10">
        <div class="flex flex-center gap-8">
          <span class="fw-700 fs-15 color-dark">${esc(group.name)}</span>
          <span class="${srcClass(group.source)}">${esc(group.source)}</span>
        </div>
        ${allPaid ? '<span class="fs-11 fw-700" style="color:var(--green-dark)">‚úì MAKSETTU</span>' : ''}
      </div>`;

    group.items.forEach(item => {
      const sailing = state.sailings.find(s => s.id === item.sailingId);
      html += `<div class="flex flex-between flex-center divider" style="padding:8px 0;font-size:13px">
        <div>
          <div class="color-dark fw-500">${sailing ? esc(sailing.name) : esc(item.sailingId)} ‚Äî ${sailing ? fmtDate(sailing.date) : ''}</div>
          <span class="${badgeClass(item.status)}">${esc(item.status)}</span>
        </div>
        <div class="text-right">
          <div class="fw-700 color-dark">${fmtCur(item.agreedPrice)}</div>
          ${item.commissionPct > 0 ? `<div class="fs-11 color-red">Provisio ${item.commissionPct}%: ${fmtCur(item.agreedPrice*item.commissionPct/100)}</div>` : ''}
        </div>
      </div>`;
    });

    html += `<div class="flex flex-between flex-center mt-10 divider-strong" style="padding-top:10px">
      <div class="fs-13 fw-700 color-dark">
        Yhteens√§: ${fmtCur(totalAgreed)}
        ${totalComm > 0 ? `<span class="fw-500 color-red fs-12"> (provisio: ${fmtCur(totalComm)})</span>` : ''}
      </div>
      <div class="flex gap-6">
        ${anyUnpaid ? `
          <button class="btn btn-secondary btn-sm" data-action="invoice-group" data-group="${gi}">Laskuta kaikki</button>
          <button class="btn btn-success btn-sm" data-action="pay-group" data-group="${gi}">Kuittaa maksetuksi</button>
        ` : ''}
      </div>
    </div></div>`;
  });

  return html;
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ
function renderModal() {
  if (!state.modal) return '';

  let title, body;
  if (state.modal === 'sailing') {
    title = state.editingId ? 'Muokkaa purjehdusta' : 'Uusi purjehdus';
    body = renderSailingForm();
  } else if (state.modal === 'customer') {
    title = state.editingId ? 'Muokkaa asiakasta' : 'Uusi asiakas';
    body = renderCustomerForm();
  } else return '';

  return `<div class="modal-overlay" data-action="close-modal">
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3>${title}</h3>
        <button class="modal-close" data-action="close-modal">${icon('x',20)}</button>
      </div>
      <div class="modal-body">${body}</div>
    </div>
  </div>`;
}

function renderSailingForm() {
  const f = state.form;
  return `
    <div class="form-row form-row-2">
      <div class="form-field">
        <label class="form-label">P√§iv√§m√§√§r√§ <span class="req">*</span></label>
        <input type="date" class="form-input" value="${f.date||''}" data-form="date">
      </div>
      <div class="form-field">
        <label class="form-label">Kellonaika</label>
        <input type="time" class="form-input" value="${f.time||''}" data-form="time">
      </div>
    </div>
    <div class="form-field">
      <label class="form-label">Tyyppi <span class="req">*</span></label>
      <select class="form-input" data-form="type">
        ${SAILING_TYPES.map(t => `<option value="${t}" ${f.type===t?'selected':''}>${t}</option>`).join('')}
      </select>
    </div>
    <div class="form-field">
      <label class="form-label">Tapahtuman nimi <span class="req">*</span></label>
      <input class="form-input" value="${esc(f.name||'')}" data-form="name" placeholder="esim. Iltapurjehdus Suomenlinna">
    </div>
    <div class="form-row form-row-3">
      <div class="form-field">
        <label class="form-label">Hinta/hl√∂ (‚Ç¨)</label>
        <input type="number" class="form-input" value="${f.pricePerPerson||''}" data-form="pricePerPerson">
      </div>
      <div class="form-field">
        <label class="form-label">Min hl√∂</label>
        <input type="number" class="form-input" value="${f.minPersons||''}" min="1" max="${MAX_CAPACITY}" data-form="minPersons">
      </div>
      <div class="form-field">
        <label class="form-label">Max hl√∂</label>
        <input type="number" class="form-input" value="${f.maxPersons||''}" min="1" max="${MAX_CAPACITY}" data-form="maxPersons">
      </div>
    </div>
    <div class="form-field">
      <label class="form-label">Tila</label>
      <select class="form-input" data-form="status">
        ${SAILING_STATUSES.map(s => `<option value="${s}" ${f.status===s?'selected':''}>${s}</option>`).join('')}
      </select>
    </div>
    <div class="form-field">
      <label class="form-label">Huomiot</label>
      <textarea class="form-input" data-form="notes" style="min-height:60px;resize:vertical">${esc(f.notes||'')}</textarea>
    </div>
    <div class="flex gap-10" style="justify-content:flex-end;margin-top:8px">
      <button class="btn btn-secondary btn-sm" data-action="close-modal">Peruuta</button>
      <button class="btn btn-primary btn-sm" data-action="save-sailing">${state.editingId?'Tallenna':'Lis√§√§ purjehdus'}</button>
    </div>`;
}

function renderCustomerForm() {
  const f = state.form;
  const commissionAmount = (f.agreedPrice||0) * (f.commissionPct||0) / 100;
  const netAmount = (f.agreedPrice||0) - commissionAmount;
  const showCommission = f.source === 'Aaltosail' || f.source === 'Kes√§purje';

  return `
    <div class="form-field">
      <label class="form-label">Nimi <span class="req">*</span></label>
      <input class="form-input" value="${esc(f.name||'')}" data-form="name" placeholder="Etunimi Sukunimi">
    </div>
    <div class="form-row form-row-2">
      <div class="form-field">
        <label class="form-label">Puhelin</label>
        <input class="form-input" value="${esc(f.phone||'')}" data-form="phone" placeholder="0401234567">
      </div>
      <div class="form-field">
        <label class="form-label">S√§hk√∂posti</label>
        <input type="email" class="form-input" value="${esc(f.email||'')}" data-form="email" placeholder="nimi@esimerkki.fi">
      </div>
    </div>
    <div class="form-field">
      <label class="form-label">Purjehdus <span class="req">*</span></label>
      <select class="form-input" data-form="sailingId">
        <option value="">‚Äî Valitse purjehdus ‚Äî</option>
        ${state.sailings.filter(s=>s.status!=='Peruutettu').map(s => {
          const free = getFree(s);
          const disabled = free <= 0 && f.sailingId !== s.id;
          return `<option value="${s.id}" ${f.sailingId===s.id?'selected':''} ${disabled?'disabled':''}>${esc(s.name)} ‚Äî ${fmtDate(s.date)} (${free>0?free+' paikkaa':'T√ÑYNN√Ñ'})</option>`;
        }).join('')}
      </select>
    </div>
    <div class="form-field">
      <label class="form-label">Tilaaja / L√§hde <span class="req">*</span></label>
      <select class="form-input" data-form="source">
        ${SOURCES.map(s => `<option value="${s}" ${f.source===s?'selected':''}>${s}</option>`).join('')}
      </select>
    </div>
    <div class="form-row form-row-2">
      <div class="form-field">
        <label class="form-label">Sovittu hinta (‚Ç¨) <span class="req">*</span></label>
        <input type="number" class="form-input" value="${f.agreedPrice||''}" data-form="agreedPrice">
      </div>
      <div class="form-field">
        <label class="form-label">Provisio-%</label>
        <input type="number" class="form-input" value="${f.commissionPct||''}" min="0" max="100" data-form="commissionPct" ${!showCommission?'disabled':''}>
        ${showCommission && f.commissionPct > 0 && f.agreedPrice > 0 ?
          `<div class="fs-11 color-red mt-4">Provisio: ${fmtCur(commissionAmount)} ‚Üí Netto: ${fmtCur(netAmount)}</div>` : ''}
      </div>
    </div>
    <div class="form-field">
      <label class="form-label">Tila</label>
      <select class="form-input" data-form="status">
        ${CUSTOMER_STATUSES.map(s => `<option value="${s}" ${f.status===s?'selected':''}>${s}</option>`).join('')}
      </select>
    </div>
    <div class="form-field">
      <label class="form-label">Huomiot</label>
      <textarea class="form-input" data-form="notes" style="min-height:50px;resize:vertical">${esc(f.notes||'')}</textarea>
    </div>
    <div class="flex gap-10" style="justify-content:flex-end;margin-top:8px">
      <button class="btn btn-secondary btn-sm" data-action="close-modal">Peruuta</button>
      <button class="btn btn-primary btn-sm" data-action="save-customer">${state.editingId?'Tallenna':'Lis√§√§ asiakas'}</button>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVENT BINDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function bindEvents() {
  // Nav tabs
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      state.activeTab = btn.dataset.tab;
      render();
    });
  });

  // All action buttons
  document.querySelectorAll('[data-action]').forEach(el => {
    el.addEventListener('click', (e) => {
      const action = el.dataset.action;
      handleAction(action, el.dataset);
      e.stopPropagation();
    });
  });

  // Filters
  const searchInput = document.querySelector('[data-filter="search"]');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => { state.searchTerm = e.target.value; render(); setTimeout(() => { const inp = document.querySelector('[data-filter="search"]'); if(inp) { inp.focus(); inp.selectionStart = inp.selectionEnd = inp.value.length; }}, 0); });
  }
  const srcFilter = document.querySelector('[data-filter="source"]');
  if (srcFilter) srcFilter.addEventListener('change', (e) => { state.filterSource = e.target.value; render(); });
  const sailFilter = document.querySelector('[data-filter="sailing"]');
  if (sailFilter) sailFilter.addEventListener('change', (e) => { state.filterSailing = e.target.value; render(); });

  // Form inputs
  document.querySelectorAll('[data-form]').forEach(el => {
    const key = el.dataset.form;
    const handler = () => {
      let val = el.value;
      if (el.type === 'number') val = parseFloat(val) || 0;
      state.form[key] = val;

      // Auto-set commission when source changes
      if (key === 'source') {
        if (val === 'Aaltosail' || val === 'Kes√§purje') {
          state.form.commissionPct = state.form.commissionPct || 15;
        } else {
          state.form.commissionPct = 0;
        }
        render();
      }
      // Auto-set price from sailing
      if (key === 'sailingId' && val && !state.editingId) {
        const s = state.sailings.find(s => s.id === val);
        if (s && s.pricePerPerson && !state.form.agreedPrice) {
          state.form.agreedPrice = s.pricePerPerson;
        }
        render();
      }
      // Re-render for commission display
      if (key === 'commissionPct' || key === 'agreedPrice') {
        render();
      }
    };
    el.addEventListener('input', handler);
    el.addEventListener('change', handler);
  });
}

function handleAction(action, dataset) {
  switch(action) {
    case 'new-sailing':
      state.form = {
        id: genId('E', state.sailings), date: '', time: '', type: 'Iltapurjehdus',
        name: '', pricePerPerson: 0, minPersons: 1, maxPersons: MAX_CAPACITY,
        status: 'Avoin', notes: ''
      };
      state.editingId = null;
      state.modal = 'sailing';
      render();
      break;

    case 'edit-sailing': {
      const s = state.sailings.find(s => s.id === dataset.id);
      if (s) { state.form = {...s}; state.editingId = s.id; state.modal = 'sailing'; render(); }
      break;
    }

    case 'delete-sailing': {
      const hasBookings = state.customers.some(c => c.sailingId === dataset.id && c.status !== 'Peruutettu');
      const msg = hasBookings ? 'Purjehduksella on varauksia. Haluatko silti poistaa?' : 'Poistetaanko purjehdus?';
      if (confirm(msg)) {
        state.sailings = state.sailings.filter(s => s.id !== dataset.id);
        state.customers = state.customers.map(c => c.sailingId === dataset.id ? {...c, status: 'Peruutettu'} : c);
        saveState(); render();
      }
      break;
    }

    case 'save-sailing': {
      readForm();
      if (!state.form.date || !state.form.name) { alert('T√§yt√§ pakolliset kent√§t (p√§iv√§m√§√§r√§, nimi)'); return; }
      state.form.maxPersons = Math.min(state.form.maxPersons || MAX_CAPACITY, MAX_CAPACITY);
      if (state.editingId) {
        state.sailings = state.sailings.map(s => s.id === state.editingId ? {...state.form} : s);
      } else {
        state.sailings.push({...state.form});
      }
      state.modal = null;
      saveState(); render();
      break;
    }

    case 'new-customer':
      state.form = {
        id: genId('V', state.customers), name: '', phone: '', email: '',
        source: 'Oma', sailingId: '', agreedPrice: 0, commissionPct: 0,
        status: 'Varaus', invoiced: 0, paid: 0, paidDate: null, notes: ''
      };
      state.editingId = null;
      state.modal = 'customer';
      render();
      break;

    case 'add-customer-to':
      state.form = {
        id: genId('V', state.customers), name: '', phone: '', email: '',
        source: 'Oma', sailingId: dataset.sailing, agreedPrice: 0, commissionPct: 0,
        status: 'Varaus', invoiced: 0, paid: 0, paidDate: null, notes: ''
      };
      // Set price from sailing
      const sail = state.sailings.find(s => s.id === dataset.sailing);
      if (sail) state.form.agreedPrice = sail.pricePerPerson || 0;
      state.editingId = null;
      state.modal = 'customer';
      state.activeTab = 'customers';
      render();
      break;

    case 'edit-customer': {
      const c = state.customers.find(c => c.id === dataset.id);
      if (c) { state.form = {...c}; state.editingId = c.id; state.modal = 'customer'; render(); }
      break;
    }

    case 'delete-customer':
      if (confirm('Poistetaanko asiakas?')) {
        state.customers = state.customers.filter(c => c.id !== dataset.id);
        saveState(); render();
      }
      break;

    case 'save-customer': {
      readForm();
      if (!state.form.name || !state.form.sailingId) { alert('T√§yt√§ pakolliset kent√§t (nimi, purjehdus)'); return; }
      // Check capacity
      const sailing = state.sailings.find(s => s.id === state.form.sailingId);
      if (sailing) {
        const current = state.customers.filter(c => c.sailingId === state.form.sailingId && c.status !== 'Peruutettu' && c.id !== state.form.id).length;
        if (current >= (sailing.maxPersons || MAX_CAPACITY)) {
          alert(`Purjehdus ${sailing.name} on t√§ynn√§!`); return;
        }
      }
      if (state.editingId) {
        state.customers = state.customers.map(c => c.id === state.editingId ? {...state.form} : c);
      } else {
        state.customers.push({...state.form});
      }
      state.modal = null;
      saveState(); render();
      break;
    }

    case 'invoice-customer': {
      state.customers = state.customers.map(c =>
        c.id === dataset.id ? {...c, status: 'Laskutettu', invoiced: c.agreedPrice} : c
      );
      saveState(); render();
      break;
    }

    case 'pay-customer': {
      const today = new Date().toISOString().split('T')[0];
      state.customers = state.customers.map(c =>
        c.id === dataset.id ? {...c, status: 'Maksettu', paid: c.invoiced || c.agreedPrice, paidDate: today} : c
      );
      saveState(); render();
      break;
    }

    case 'invoice-group':
    case 'pay-group': {
      const groups = {};
      state.customers.filter(c => c.status !== 'Peruutettu').forEach(c => {
        const key = c.name + '___' + c.source;
        if (!groups[key]) groups[key] = { items: [] };
        groups[key].items.push(c);
      });
      const groupList = Object.values(groups);
      const gi = parseInt(dataset.group);
      if (groupList[gi]) {
        const today = new Date().toISOString().split('T')[0];
        const ids = new Set(groupList[gi].items.map(i => i.id));
        state.customers = state.customers.map(c => {
          if (!ids.has(c.id)) return c;
          if (action === 'invoice-group' && c.status === 'Varaus') {
            return {...c, status: 'Laskutettu', invoiced: c.agreedPrice};
          }
          if (action === 'pay-group' && c.status !== 'Maksettu' && c.status !== 'Peruutettu') {
            return {...c, status: 'Maksettu', paid: c.invoiced || c.agreedPrice, paidDate: today};
          }
          return c;
        });
        saveState(); render();
      }
      break;
    }

    case 'close-modal':
      state.modal = null;
      render();
      break;
  }
}

function readForm() {
  document.querySelectorAll('[data-form]').forEach(el => {
    const key = el.dataset.form;
    let val = el.value;
    if (el.type === 'number') val = parseFloat(val) || 0;
    state.form[key] = val;
  });
}

// ‚îÄ‚îÄ‚îÄ Export / Import ‚îÄ‚îÄ‚îÄ
function exportData() {
  const data = JSON.stringify({ sailings: state.sailings, customers: state.customers, exportDate: new Date().toISOString() }, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'absolut37_varmuuskopio_' + new Date().toISOString().split('T')[0] + '.json';
  a.click(); URL.revokeObjectURL(url);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.sailings && data.customers) {
        if (confirm(`Tuodaan ${data.sailings.length} purjehdusta ja ${data.customers.length} asiakasta. Nykyinen data korvataan. Jatketaanko?`)) {
          state.sailings = data.sailings;
          state.customers = data.customers;
          saveState(); render();
          alert('Data tuotu onnistuneesti!');
        }
      } else {
        alert('Virheellinen tiedosto.');
      }
    } catch(err) { alert('Tiedoston lukeminen ep√§onnistui: ' + err.message); }
  };
  reader.readAsText(file);
}

// ‚îÄ‚îÄ‚îÄ CSV export helpers ‚îÄ‚îÄ‚îÄ
function downloadTextFile(filename, text, mime='text/plain;charset=utf-8') {
  const blob = new Blob([text], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function csvEscape(v) {
  if (v === null || v === undefined) return '';
  const s = String(v).replace(/\r?\n/g, ' ');
  return /[",;]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
}

function toCSV(rows, headers) {
  const sep = ';'; // Excel/Finland
  const head = headers.map(h => csvEscape(h)).join(sep);
  const body = rows.map(r => headers.map(h => csvEscape(r[h])).join(sep)).join('\n');
  return head + '\n' + body + '\n';
}

function exportCustomersCSV() {
  const rows = state.customers.map(c => {
    const s = state.sailings.find(x => x.id === c.sailingId) || {};
    const commissionAmt = (c.agreedPrice||0) * (c.commissionPct||0) / 100;
    return {
      id: c.id,
      nimi: c.name,
      puhelin: c.phone || '',
      s√§hk√∂posti: c.email || '',
      l√§hde: c.source,
      purjehdus_id: c.sailingId,
      purjehdus_nimi: s.name || '',
      pvm: s.date || '',
      aika: s.time || '',
      tyyppi: s.type || '',
      sovittu_hinta: (c.agreedPrice||0).toFixed(2),
      provisio_pct: (c.commissionPct||0),
      provisio_eur: commissionAmt.toFixed(2),
      status: c.status,
      laskutettu: (c.invoiced||0).toFixed(2),
      maksettu: (c.paid||0).toFixed(2),
      maksupvm: c.paidDate || '',
      huomiot: c.notes || ''
    };
  });
  const headers = Object.keys(rows[0] || {id:''});
  const csv = toCSV(rows, headers);
  downloadTextFile('absolut37_asiakkaat_' + new Date().toISOString().split('T')[0] + '.csv', csv, 'text/csv;charset=utf-8');
}

function exportSailingsCSV() {
  const rows = state.sailings.map(s => {
    const b = getBookings(s.id);
    const max = s.maxPersons || MAX_CAPACITY;
    return {
      id: s.id,
      pvm: s.date || '',
      aika: s.time || '',
      tyyppi: s.type || '',
      nimi: s.name || '',
      hinta_hl√∂: (s.pricePerPerson||0).toFixed(2),
      min_hl√∂: s.minPersons || '',
      max_hl√∂: max,
      status: s.status,
      varatut: b.booked,
      vapaa: Math.max(0, max - b.booked),
      maksetut_hl√∂: b.paid,
      laskutettu_yht: (b.invoiced||0).toFixed(2),
      maksettu_yht: (b.totalPaid||0).toFixed(2),
      huomiot: s.notes || ''
    };
  });
  const headers = Object.keys(rows[0] || {id:''});
  const csv = toCSV(rows, headers);
  downloadTextFile('absolut37_purjehdukset_' + new Date().toISOString().split('T')[0] + '.csv', csv, 'text/csv;charset=utf-8');
}

function exportAccountingCSV() {
  const rows = state.customers
    .filter(c => c.status !== 'Peruutettu')
    .map(c => {
      const s = state.sailings.find(x => x.id === c.sailingId) || {};
      const commission = (c.source==='Aaltosail'||c.source==='Kes√§purje') ? (c.agreedPrice||0) * (c.commissionPct||0)/100 : 0;
      const net = (c.agreedPrice||0) - commission;
      return {
        pvm: s.date || '',
        purjehdus: s.name || c.sailingId,
        asiakas: c.name,
        l√§hde: c.source,
        status: c.status,
        sovittu_hinta: (c.agreedPrice||0).toFixed(2),
        laskutettu: (c.invoiced||0).toFixed(2),
        maksettu: (c.paid||0).toFixed(2),
        provisio: commission.toFixed(2),
        netto: net.toFixed(2),
        maksupvm: c.paidDate || ''
      };
    });

  // Totals row
  const sum = (k) => rows.reduce((a,r)=>a + (parseFloat(r[k])||0), 0);
  rows.push({
    pvm: '',
    purjehdus: 'YHTEENS√Ñ',
    asiakas: '',
    l√§hde: '',
    status: '',
    sovittu_hinta: sum('sovittu_hinta').toFixed(2),
    laskutettu: sum('laskutettu').toFixed(2),
    maksettu: sum('maksettu').toFixed(2),
    provisio: sum('provisio').toFixed(2),
    netto: sum('netto').toFixed(2),
    maksupvm: ''
  });

  const headers = Object.keys(rows[0] || {pvm:''});
  const csv = toCSV(rows, headers);
  downloadTextFile('absolut37_kirjanpito_' + new Date().toISOString().split('T')[0] + '.csv', csv, 'text/csv;charset=utf-8');
}

// ‚îÄ‚îÄ‚îÄ Save directly to file (jos selaimen File Picker on k√§yt√∂ss√§) ‚îÄ‚îÄ‚îÄ
async function saveToFileDirect() {
  try {
    if (!window.showSaveFilePicker) {
      alert('Tallenna tiedostoon: ei tuettu t√§ll√§ iPadOS/Safari-versiolla. K√§yt√§ Varmuuskopio (JSON) -nappia ja tallenna iCloud Driveen.');
      return;
    }
    const handle = await window.showSaveFilePicker({
      suggestedName: 'absolut37_data_' + new Date().toISOString().split('T')[0] + '.json',
      types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
    });
    const writable = await handle.createWritable();
    await writable.write(JSON.stringify({
      sailings: state.sailings,
      customers: state.customers,
      saved: new Date().toISOString()
    }, null, 2));
    await writable.close();
    alert('Tallennettu tiedostoon.');
  } catch (err) {
    alert('Tallennus peruttiin tai ep√§onnistui: ' + err.message);
  }
}


}
// ‚îÄ‚îÄ‚îÄ DEBUG: n√§yt√§ virheet ruudulla ‚îÄ‚îÄ‚îÄ
window.onerror = function (msg, src, line, col, err) {
  const el = document.getElementById('app');
  if (el) el.innerHTML = '<pre style="padding:16px;color:#b00020;white-space:pre-wrap">' +
    'JS ERROR:\n' + msg + '\n' + (src || '') + ':' + line + ':' + col + '\n\n' +
    (err && err.stack ? err.stack : '') +
    '</pre>';
};

window.onunhandledrejection = function (e) {
  const el = document.getElementById('app');
  if (el) el.innerHTML = '<pre style="padding:16px;color:#b00020;white-space:pre-wrap">' +
    'PROMISE ERROR:\n' + (e.reason && e.reason.stack ? e.reason.stack : String(e.reason)) +
    '</pre>';
};

try {
  loadState();
  render();
} catch (e) {
  const el = document.getElementById('app');
  if (el) el.innerHTML = '<pre style="padding:16px;color:#b00020;white-space:pre-wrap">' +
    'INIT ERROR:\n' + (e && e.stack ? e.stack : String(e)) +
    '</pre>';
}
</script>
</body>
</html>
