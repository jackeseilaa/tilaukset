<!-- STABLE v1.1 ‚Äì customers & sailings search + toggle customers per sailing -->
<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Absolut 37 ‚Äî Tilaukset</title>

<style>
:root{
  --navy:#234c78;
  --bg:#f3f5f7;
  --card:#ffffff;
  --muted:#6b7280;
  --line:#e5e7eb;
  --btn:#1f4b7a;
  --btn2:#eef2f7;
  --danger-bg:#fde2e2;
  --danger:#991b1b;
  --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111827}
header{background:var(--navy);color:#fff;padding:18px 20px}
header h1{margin:0;font-size:32px}
header .sub{margin-top:6px;opacity:.85;font-size:14px}
nav{background:#fff;border-bottom:1px solid var(--line);display:flex}
nav button{
  flex:1;padding:12px;border:0;background:#fff;font-weight:600;
  border-bottom:3px solid transparent;cursor:pointer
}
nav button.active{border-bottom-color:var(--navy)}
main{max-width:980px;margin:0 auto;padding:18px}
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:18px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.row.between{justify-content:space-between}
.btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.primary{background:var(--btn);color:#fff}
.btn.secondary{background:var(--btn2)}
.btn.danger{background:var(--danger-bg);color:var(--danger)}
.muted{color:var(--muted)}
.hr{border-top:1px solid var(--line);margin:14px 0}
input,select{
  width:100%;padding:10px;border:1px solid var(--line);
  border-radius:10px;font-size:15px
}
label{display:block;font-size:13px;font-weight:700;margin-bottom:6px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:800px){.grid2{grid-template-columns:1fr}}
.item{display:flex;justify-content:space-between;gap:12px;padding:12px 0;border-top:1px solid var(--line)}
.item:first-child{border-top:0}
.item h3{margin:0 0 4px 0}
.meta{font-size:14px;color:var(--muted)}
.pill{background:#eef2ff;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;margin-left:8px}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:18px}
.modal{background:#fff;border-radius:16px;border:1px solid var(--line);width:min(680px,100%)}
.modal header{background:#fff;color:#111;border-bottom:1px solid var(--line);padding:16px}
.modal .body{padding:18px}
  /* T√§ytt√∂aste */
.fillrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:6px}
.fillbar{flex:1;min-width:140px;height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
.fillbar > div{height:100%}
.filltext{font-size:13px;color:var(--muted);font-weight:700;white-space:nowrap}

/* Kurssip√§iv√§t */
.sessionbox{margin:10px 0 16px 0;padding:12px;background:#f8fafc;border-radius:12px;border:1px solid var(--line)}
.sessionhead{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.sessionitem{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;padding:8px 0;border-top:1px dashed #dbe2ea}
.sessionitem:first-child{border-top:0;padding-top:0}
.sessionmeta{font-size:13px;color:var(--muted)}
</style>
</head>
<body>

<div id="app"></div>

<script>
(() => {
  // N√§yt√§ virheet ruudulla (helpottaa iPadilla)
  window.onerror = function(msg, src, line, col, err){
    const el = document.getElementById("app");
    if (!el) return;
    el.innerHTML =
      "<pre style='padding:16px;color:#b00020;white-space:pre-wrap'>" +
      "JS ERROR:\n" + msg + "\n" +
      (src || "") + ":" + line + ":" + col + "\n\n" +
      (err && err.stack ? err.stack : "") +
      "</pre>";
  };

  const STORAGE_KEY="absolut37_stable_v1_1";
  const SAILING_TYPES=["Iltapurjehdus","P√§iv√§purjehdus","Charter","Kurssi","Yritystilaisuus","Muu"];

  const state={
    tab:"dashboard",
    customers:[],
    sailings:[],
    modal:null,
    form:{},
    searchCustomers:"",
    searchSailings:"",
    openSailingId: null,
  };

  function load(){
    try{
      const raw=localStorage.getItem(STORAGE_KEY);
      if(raw){
        const data=JSON.parse(raw);
        state.customers=Array.isArray(data.customers)?data.customers:[];
        state.sailings=Array.isArray(data.sailings)?data.sailings:[];
      }
    }catch(e){}

    // Seed jos tyhj√§
    if(state.customers.length===0 && state.sailings.length===0){
      const sid = id("S");
      state.sailings.push({id:sid,name:"Iltapurjehdus Suomenlinna",date:today(),type:"Iltapurjehdus",maxPersons:6,pricePerPerson:120});
      state.customers.push({id:id("C"),name:"Testi Seppo",phone:"04012345678",email:"joku@joku.net",sailingId:sid});
    }
  }

  function save(){
    localStorage.setItem(STORAGE_KEY,JSON.stringify({
      customers:state.customers,
      sailings:state.sailings
    }));
  }

  function id(p){return p+Math.random().toString(16).slice(2,8).toUpperCase()}
  function esc(s){return String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}
  function today(){return new Date().toISOString().slice(0,10)}
  function fmtDate(d){return d?new Date(d+"T00:00:00").toLocaleDateString("fi-FI"):""}
  function enrolledCount(sailingId){
  return state.customers.filter(c => c.sailingId === sailingId).length;
}

function fillUI(booked, max){
  const m = Math.max(1, Number(max || 0) || 1);
  const b = Math.max(0, Number(booked || 0) || 0);
  const pct = Math.max(0, Math.min(100, Math.round((b / m) * 100)));

  // V√§rit ilman CSS-muuttujas√§√§t√∂√§: vihre√§->keltainen->punainen
  const color = pct >= 100 ? "#ef4444" : (pct >= 67 ? "#f59e0b" : "#22c55e");

  return `
    <div class="fillrow">
      <div class="fillbar"><div style="width:${pct}%;background:${color}"></div></div>
      <div class="filltext">${b} / ${m} (${pct}%)</div>
    </div>
  `;
}

  function render(){
    // s√§ilyt√§ fokus+kursori kun render√∂id√§√§n (iPad/Safari)
    const ae=document.activeElement;
    const keep={
      action: ae && ae.dataset ? ae.dataset.action : null,
      field:  ae && ae.dataset ? ae.dataset.field  : null,
      pos:    (ae && typeof ae.selectionStart==="number") ? ae.selectionStart : null
    };

    document.getElementById("app").innerHTML =
      renderHeader()+renderNav()+
      "<main>"+renderTab()+"</main>"+
      renderModal();

    bind();

    const sel = keep.action ? `[data-action="${keep.action}"]` :
                keep.field  ? `[data-field="${keep.field}"]`  : null;

    if(sel){
      const el=document.querySelector(sel);
      if(el && typeof el.focus==="function"){
        el.focus();
        if(keep.pos!==null && typeof el.setSelectionRange==="function"){
          el.setSelectionRange(keep.pos, keep.pos);
        }
      }
    }
  }

  function renderHeader(){
    return `<header>
      <h1>Absolut 37</h1>
      <div class="sub">Tilauksen hallinta</div>
    </header>`;
  }

  function renderNav(){
    const tabs=[["dashboard","Dashboard"],["sailings","Purjehdukset"],["customers","Asiakkaat"]];
    return `<nav>`+
      tabs.map(([id,label])=>
        `<button data-tab="${id}" class="${state.tab===id?"active":""}">${label}</button>`
      ).join("")+
      `</nav>`;
  }

  function renderTab(){
    if(state.tab==="dashboard")return renderDashboard();
    if(state.tab==="customers")return renderCustomers();
    if(state.tab==="sailings")return renderSailings();
    return "";
  }

  function renderDashboard(){
    return `<div class="card">
      <div class="row between">
        <h2>Dashboard</h2>
        <button class="btn secondary" data-action="backup-json">üíæ Varmuuskopio</button>
      </div>
      <div class="hr"></div>
      <div>Asiakkaita: <b>${state.customers.length}</b></div>
      <div>Purjehduksia: <b>${state.sailings.length}</b></div>
      <div class="muted" style="margin-top:10px">Tallennus: localStorage (t√§h√§n laitteeseen)</div>
    </div>`;
  }

  function renderCustomers(){
    const term=(state.searchCustomers||"").toLowerCase();
    const list=state.customers.filter(c =>
      !term ||
      (c.name||"").toLowerCase().includes(term) ||
      (c.phone||"").toLowerCase().includes(term) ||
      (c.email||"").toLowerCase().includes(term)
    );

    return `<div class="card">
      <div class="row between">
        <h2>Asiakkaat</h2>
        <button class="btn primary" data-action="new-customer">+ Lis√§√§</button>
      </div>

      <div class="hr"></div>
      <label>Haku</label>
      <input data-action="search-customers" value="${esc(state.searchCustomers)}" placeholder="Hae nimell√§ / puhelin / email">

      <div class="hr"></div>

      ${list.length===0 ? `<div class="muted">Ei osumia.</div>` : `
        ${list.map(c=>`
          <div class="item">
            <div>
              <h3>
                ${esc(c.name||"")}
                ${c.sailingId ? `
                  <span class="pill">
                    ${esc(state.sailings.find(s=>s.id===c.sailingId)?.name || "")}
                  </span>` : ""}
              </h3>
              <div class="meta">${esc(c.phone||"")}${(c.phone&&c.email)?" ‚Ä¢ ":""}${esc(c.email||"")}</div>
            </div>
            <button class="btn danger" data-action="delete-customer" data-id="${c.id}">Poista</button>
          </div>
        `).join("")}
      `}
    </div>`;
  }

  function renderSailings(){
  const term = (state.searchSailings || "").toLowerCase().trim();

  const list = state.sailings.filter(s =>
    !term ||
    (s.name||"").toLowerCase().includes(term) ||
    (s.type||"").toLowerCase().includes(term) ||
    (s.date||"").includes(term)
  );

  return `<div class="card">
    <div class="row between">
      <h2>Purjehdukset</h2>
      <button class="btn primary" data-action="new-sailing">+ Lis√§√§</button>
    </div>

    <div class="hr"></div>

    <label>Haku</label>
    <input data-action="search-sailings" value="${esc(state.searchSailings||"")}">

    <div class="hr"></div>

    ${list.map(s => {
      const booked = enrolledCount(s.id);
      const max = Number(s.maxPersons || 0) || 0;

      // Kurssip√§iv√§t (vain Kurssi-tyypille)
      const sessions = Array.isArray(s.sessions) ? s.sessions : [];
      const sessionsUI = (s.type === "Kurssi")
        ? `
          <div class="sessionbox">
            <div class="sessionhead">
              <div style="font-weight:900">Kurssip√§iv√§t</div>
              <button class="btn secondary" data-action="add-session" data-id="${s.id}">+ Lis√§√§ p√§iv√§</button>
            </div>

            ${sessions.length === 0 ? `<div class="muted">Ei p√§ivi√§ lis√§ttyn√§.</div>` : `
              ${sessions.map((x, idx) => `
                <div class="sessionitem">
                  <div>
                    <div style="font-weight:800">${esc(x.date || "")} ${x.start ? "klo "+esc(x.start) : ""}${x.end ? "‚Äì"+esc(x.end) : ""}</div>
                    ${x.note ? `<div class="sessionmeta">${esc(x.note)}</div>` : ``}
                  </div>
                  <button class="btn danger" data-action="delete-session" data-id="${s.id}" data-idx="${idx}">Poista</button>
                </div>
              `).join("")}
            `}
          </div>
        `
        : "";

      // N√§yt√§ asiakkaat -laatikko
      const attendeesUI = (state.openSailingId === s.id)
        ? `
          <div style="margin:8px 0 16px 0;padding:12px;background:#f8fafc;border-radius:12px;border:1px solid var(--line)">
            ${state.customers
              .filter(c => c.sailingId === s.id)
              .map(c => `<div style="padding:6px 0;border-top:1px dashed #dbe2ea">${esc(c.name||"")}</div>`)
              .join("") || `<div class="muted">Ei ilmoittautuneita</div>`}
          </div>
        `
        : "";

      return `
        <div class="item">
          <div style="flex:1">
            <h3>
              ${esc(s.name||"")}
              <span class="pill">${esc(s.type||"")}</span>
            </h3>

            <div class="meta">
              ${fmtDate(s.date)} ‚Ä¢ Max ${Number(s.maxPersons||0)} hl√∂ ‚Ä¢ ${Number(s.pricePerPerson||0).toFixed(2)} ‚Ç¨/hl√∂
            </div>

            ${fillUI(booked, max)}

            ${sessionsUI}
          </div>

          <div class="row" style="align-items:flex-start">
            <button class="btn secondary" data-action="toggle-sailing" data-id="${s.id}">
              ${state.openSailingId === s.id ? "Piilota asiakkaat" : "N√§yt√§ asiakkaat"}
            </button>
            <button class="btn danger" data-action="delete-sailing" data-id="${s.id}">Poista</button>
          </div>
        </div>

        ${attendeesUI}
      `;
    }).join("")}
  </div>`;
}

  function renderModal(){
    if(!state.modal)return "";

    if(state.modal==="customer"){
      return `<div class="overlay" data-action="close-modal">
        <div class="modal" onclick="event.stopPropagation()">
          <header><h2>Uusi asiakas</h2></header>
          <div class="body">
            <label>Nimi *</label>
            <input data-field="name" value="">
            <label>Puhelin</label>
            <input data-field="phone" value="">
            <label>Email</label>
            <input data-field="email" value="">
            <label>Purjehdus</label>
            <select data-field="sailingId">
              <option value="">-- Ei valittu --</option>
              ${state.sailings.map(s=>`
                <option value="${s.id}">${esc(s.name)} (${fmtDate(s.date)})</option>
              `).join("")}
            </select>
            <div class="row" style="justify-content:flex-end;margin-top:12px">
              <button class="btn primary" data-action="save-customer">Tallenna</button>
            </div>
          </div>
        </div>
      </div>`;
    }

    if(state.modal==="sailing"){
      return `<div class="overlay" data-action="close-modal">
        <div class="modal" onclick="event.stopPropagation()">
          <header><h2>Uusi purjehdus</h2></header>
          <div class="body">
            <label>Nimi *</label>
            <input data-field="name" value="">
            <label>P√§iv√§ *</label>
            <input type="date" data-field="date" value="${today()}">
            <label>Tyyppi *</label>
            <select data-field="type">
              ${SAILING_TYPES.map(t=>`<option>${esc(t)}</option>`).join("")}
            </select>
            <label>Max hl√∂ *</label>
            <input type="number" data-field="maxPersons" value="6" min="1" step="1">
            <label>Hinta/hl√∂ (‚Ç¨) *</label>
            <input type="number" data-field="pricePerPerson" value="0" min="0" step="0.01">
            <div class="row" style="justify-content:flex-end;margin-top:12px">
              <button class="btn primary" data-action="save-sailing">Tallenna</button>
            </div>
          </div>
        </div>
      </div>`;
    }

    return "";
  }

  function bind(){
    // tabit
    document.querySelectorAll("[data-tab]").forEach(b=>{
      b.onclick=()=>{ state.tab=b.dataset.tab; render(); };
    });

    // click-actionit
    document.querySelectorAll("[data-action]").forEach(el=>{
      el.onclick=()=>{
        const a = el.dataset.action;
        const id = el.dataset.id;

        if(a==="new-customer"){ state.modal="customer"; render(); }
        if(a==="new-sailing"){ state.modal="sailing"; render(); }
        if(a==="close-modal"){ state.modal=null; render(); }
        if(a==="toggle-sailing"){
  state.openSailingId = (state.openSailingId === id) ? null : id;
  render();
  return;
}

if(a==="add-session"){
  const date = prompt("Kurssip√§iv√§ (YYYY-MM-DD):", today());
  if(!date) return;

  const start = prompt("Aloitusaika (HH:MM), tyhj√§ sallittu:", "17:00") || "";
  const end = prompt("Lopetusaika (HH:MM), tyhj√§ sallittu:", "20:00") || "";
  const note = prompt("Lis√§huomio (valinnainen):", "") || "";

  const s = state.sailings.find(x => x.id === id);
  if(!s) return;

  if(!Array.isArray(s.sessions)) s.sessions = [];
  s.sessions.push({ date, start, end, note });

  save();
  render();
  return;
}

if(a==="delete-session"){
  const idx = Number(el.dataset.idx);
  const s = state.sailings.find(x => x.id === id);
  if(!s || !Array.isArray(s.sessions)) return;

  if(!confirm("Poistetaanko kurssip√§iv√§?")) return;

  s.sessions.splice(idx, 1);
  save();
  render();
  return;
}

        if(a==="toggle-sailing"){
          const sid = el.dataset.id;
          state.openSailingId = (state.openSailingId===sid) ? null : sid;
          render();
        }

        if(a==="save-customer"){
          const name = (document.querySelector('[data-field="name"]')?.value || "").trim();
          if(!name) return alert("Nimi pakollinen");

          const phone = (document.querySelector('[data-field="phone"]')?.value || "").trim();
          const email = (document.querySelector('[data-field="email"]')?.value || "").trim();
          const sailingId = (document.querySelector('[data-field="sailingId"]')?.value || "");

          state.customers.push({ id:id("C"), name, phone, email, sailingId });
          save();
          state.modal=null;
          render();
        }

        if(a==="save-sailing"){
          const name = (document.querySelector('[data-field="name"]')?.value || "").trim();
          const date = (document.querySelector('[data-field="date"]')?.value || "").trim();
          const type = (document.querySelector('[data-field="type"]')?.value || "").trim();
          const maxPersons = parseInt(document.querySelector('[data-field="maxPersons"]')?.value, 10) || 1;
          const pricePerPerson = parseFloat(document.querySelector('[data-field="pricePerPerson"]')?.value) || 0;

          if(!name || !date || !type) return alert("T√§yt√§ pakolliset kent√§t (nimi, p√§iv√§, tyyppi).");

          state.sailings.push({id:id("S"),name,date,type,maxPersons,pricePerPerson, sessions: []});
          save();
          state.modal=null;
          render();
        }

        if(a==="delete-customer"){
          const cid = el.dataset.id;
          state.customers = state.customers.filter(c=>c.id!==cid);
          save();
          render();
        }

        if(a==="delete-sailing"){
          const sid = el.dataset.id;
          state.sailings = state.sailings.filter(s=>s.id!==sid);
          // jos oli auki, sulje
          if(state.openSailingId===sid) state.openSailingId=null;
          // asiakkaiden sailingId:t j√§tet√§√§n ennalleen (n√§kyy pilliss√§ tyhj√§n√§ jos purjehdus poistuu)
          save();
          render();
        }

        if(a==="backup-json"){
          const blob = new Blob([JSON.stringify({customers:state.customers,sailings:state.sailings},null,2)],{type:"application/json"});
          const url = URL.createObjectURL(blob);
          const x = document.createElement("a");
          x.href=url; x.download="absolut37_backup.json"; x.click();
          URL.revokeObjectURL(url);
        }
      };
    });

    // hakukent√§t
    const sc=document.querySelector('[data-action="search-customers"]');
    if(sc){
      sc.oninput=e=>{ state.searchCustomers=e.target.value; render(); };
      sc.onkeydown=e=>{ if(e.key==="Enter") e.preventDefault(); };
    }

    const ss=document.querySelector('[data-action="search-sailings"]');
    if(ss){
      ss.oninput=e=>{ state.searchSailings=e.target.value; render(); };
      ss.onkeydown=e=>{ if(e.key==="Enter") e.preventDefault(); };
    }
  }

  // init
  load();
  render();

})();
</script>
</body>
</html>
