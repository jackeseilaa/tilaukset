<!-- STABLE v2.0 ‚Äì groups + edit + enrollments + capacity check + invoicing (VAT split) + backup/restore -->
<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Absolut 37 ‚Äî Tilaukset</title>

<style>
:root{
  --navy:#234c78;
  --bg:#f3f5f7;
  --card:#ffffff;
  --muted:#6b7280;
  --line:#e5e7eb;
  --btn:#1f4b7a;
  --btn2:#eef2f7;
  --danger-bg:#fde2e2;
  --danger:#991b1b;
  --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111827}
header{background:var(--navy);color:#fff;padding:18px 20px}
header h1{margin:0;font-size:32px}
header .sub{margin-top:6px;opacity:.85;font-size:14px}
nav{background:#fff;border-bottom:1px solid var(--line);display:flex}
nav button{flex:1;padding:12px;border:0;background:#fff;font-weight:700;border-bottom:3px solid transparent;cursor:pointer;color:#374151}
nav button.active{border-bottom-color:var(--navy);color:#111827}
main{max-width:980px;margin:0 auto;padding:18px}
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:18px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.row.between{justify-content:space-between}
.btn{border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--btn);color:#fff}
.btn.secondary{background:var(--btn2);color:#111827}
.btn.danger{background:var(--danger-bg);color:var(--danger)}
.muted{color:var(--muted)}
.small{font-size:12px}
.hr{border-top:1px solid var(--line);margin:14px 0}
input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;font-size:15px;background:#fff}
label{display:block;font-size:13px;font-weight:800;margin-bottom:6px;color:#374151}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@media (max-width:800px){.grid2,.grid3{grid-template-columns:1fr}}

.item{display:flex;justify-content:space-between;gap:12px;padding:12px 0;border-top:1px solid var(--line)}
.item:first-child{border-top:0}
.item h3{margin:0 0 4px 0}
.meta{font-size:14px;color:var(--muted)}
.pill{background:#eef2ff;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;margin-left:8px;color:#1e3a8a;display:inline-block;vertical-align:middle}

.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:18px}
.modal{background:#fff;border-radius:16px;border:1px solid var(--line);width:min(720px,100%);overflow:hidden}
.modal header{background:#fff;color:#111;border-bottom:1px solid var(--line);padding:16px}
.modal header h2{margin:0;font-size:18px}
.modal .body{padding:18px}
.note{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:12px 14px}

.fillrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:6px}
.fillbar{flex:1;min-width:160px;height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
.fillbar>div{height:100%}
.filltext{font-size:13px;color:var(--muted);font-weight:900;white-space:nowrap}

.sessionbox{margin:10px 0 16px 0;padding:12px;background:#f8fafc;border-radius:12px;border:1px solid var(--line)}
.sessionhead{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.sessionitem{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;padding:8px 0;border-top:1px dashed #dbe2ea}
.sessionitem:first-child{border-top:0;padding-top:0}
.sessionmeta{font-size:13px;color:var(--muted)}

.groupbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.groupbtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;font-weight:900;cursor:pointer}
.groupbtn.active{border-color:var(--navy);box-shadow:0 0 0 2px rgba(35,76,120,.10)}
</style>
</head>

<body>
<div id="app"></div>

<script>
(() => {
  // Virheet ruudulle (helpottaa iPadilla)
  window.onerror = function(msg, src, line, col, err){
    const el = document.getElementById("app");
    if (!el) return;
    el.innerHTML =
      "<pre style='padding:16px;color:#b00020;white-space:pre-wrap'>" +
      "JS ERROR:\\n" + msg + "\\n" +
      (src || "") + ":" + line + ":" + col + "\\n\\n" +
      (err && err.stack ? err.stack : "") +
      "</pre>";
  };

  const STORAGE_KEY = "absolut37_stable_v2_0";

  const SAILING_TYPES = [
    "Iltapurjehdus","P√§iv√§purjehdus","Charter","Kurssi","Yritystilaisuus","Purjehdusretki","Muu"
  ];

  // Ryhm√§t (UI-otsikot) -> mitk√§ type-kent√§t kuuluvat ryhm√§√§n
  const SAILING_GROUPS = [
    { id:"all", label:"Kaikki", types:null },
    { id:"courses", label:"Purjehduskurssit", types:["Kurssi"] },
    { id:"charter", label:"Charter", types:["Charter"] },
    { id:"evening", label:"Iltapurjehdukset", types:["Iltapurjehdus"] },
    { id:"trips", label:"Purjehdusretket", types:["Purjehdusretki"] },
    { id:"training", label:"Muu koulutus", types:["Yritystilaisuus","Muu"] },
  ];

  const state = {
    tab:"dashboard",
    sailingGroup:"all",

    customers:[],     // {id,name,phone,email}
    sailings:[],      // {id,name,date,type,maxPersons,pricePerPerson,sessions:[]}
    enrollments:[],   // {id,customerId,eventId,qty,unitPriceGross,payerType,payerCompanyId,commission:{type,value},vatRate?}
    companies:[],     // {id,name,vatId?,email?}

    modal:null,       // "customer" | "sailing" | null
    editCustomerId:null,
    editSailingId:null,

    searchCustomers:"",
    searchSailings:"",
    openSailingId:null,

    invoicingEventId:""
  };

  function makeId(p){ return p + Math.random().toString(16).slice(2,8).toUpperCase(); }
  function esc(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }
  function today(){ return new Date().toISOString().slice(0,10); }
  function fmtDate(d){ return d ? new Date(d+"T00:00:00").toLocaleDateString("fi-FI") : ""; }
  function round2(n){ const x=Number(n||0); return Math.round(x*100)/100; }

  function getVatRateByType(type){
    // Charter 13,5% -> 0.135, muut 25,5% -> 0.255
    return (String(type||"").toLowerCase()==="charter") ? 0.135 : 0.255;
  }

  function splitVatFromGross(gross, vatRate){
    const g = Number(gross || 0);
    const r = Number(vatRate || 0);
    const net = g / (1 + r);
    const vat = g - net;
    return { net: round2(net), vat: round2(vat), gross: round2(g) };
  }

  function enrolledQty(eventId){
    return state.enrollments
      .filter(e => e.eventId === eventId)
      .reduce((sum,e)=> sum + (Number(e.qty||1)||1), 0);
  }

  function calcCommissionGross(enrollment){
    const qty = Number(enrollment.qty || 1) || 1;
    const g = Number(enrollment.unitPriceGross || 0) * qty;
    const c = enrollment.commission || { type:"percent", value:0 };

    let comm = 0;
    if (c.type === "fixed") comm = Number(c.value || 0);
    else comm = g * (Number(c.value || 0) / 100);

    comm = Math.max(0, Math.min(g, comm));
    return round2(comm);
  }

  function payerKey(enrollment){
    if (enrollment.payerType === "company" && enrollment.payerCompanyId) return "company:" + enrollment.payerCompanyId;
    return "customer:" + enrollment.customerId;
  }

  function payerLabel(enrollment){
    if (enrollment.payerType === "company" && enrollment.payerCompanyId) {
      const co = state.companies.find(x=>x.id===enrollment.payerCompanyId);
      return co ? co.name : "(Yritys puuttuu)";
    }
    const c = state.customers.find(x=>x.id===enrollment.customerId);
    return c ? c.name : "(Asiakas puuttuu)";
  }

  function fillUI(booked, max){
    const m = Math.max(1, Number(max || 0) || 1);
    const b = Math.max(0, Number(booked || 0) || 0);
    const pct = Math.max(0, Math.min(100, Math.round((b / m) * 100)));
    const color = pct >= 100 ? "#ef4444" : (pct >= 67 ? "#f59e0b" : "#22c55e");
    return `
      <div class="fillrow">
        <div class="fillbar"><div style="width:${pct}%;background:${color}"></div></div>
        <div class="filltext">${b} / ${m} (${pct}%)</div>
      </div>
    `;
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const data = JSON.parse(raw);
        state.customers   = Array.isArray(data.customers)   ? data.customers   : [];
        state.sailings    = Array.isArray(data.sailings)    ? data.sailings    : [];
        state.enrollments = Array.isArray(data.enrollments) ? data.enrollments : [];
        state.companies   = Array.isArray(data.companies)   ? data.companies   : [];
      }
    }catch(e){}

    // Seed jos tyhj√§
    if(state.customers.length===0 && state.sailings.length===0 && state.enrollments.length===0){
      const sid = makeId("S");
      state.sailings.push({
        id:sid,
        name:"Iltapurjehdus Suomenlinna",
        date:today(),
        type:"Iltapurjehdus",
        maxPersons:6,
        pricePerPerson:120,
        sessions:[]
      });

      const cid = makeId("C");
      state.customers.push({ id:cid, name:"Testi Seppo", phone:"04012345678", email:"joku@joku.net" });

      state.enrollments.push({
        id: makeId("E"),
        customerId: cid,
        eventId: sid,
        qty: 1,
        unitPriceGross: 120,
        payerType: "customer",
        payerCompanyId: "",
        commission: { type:"percent", value: 0 }
      });

      state.companies.push({ id: makeId("CO"), name:"V√§litt√§j√§ Oy" });
    }
  }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      customers: state.customers,
      sailings: state.sailings,
      enrollments: state.enrollments,
      companies: state.companies
    }));
  }

  function render(){
    // fokus+kursori talteen (Safari/iPad)
    const ae = document.activeElement;
    const keep = {
      action: ae && ae.dataset ? ae.dataset.action : null,
      field:  ae && ae.dataset ? ae.dataset.field  : null,
      pos:    (ae && typeof ae.selectionStart==="number") ? ae.selectionStart : null
    };

    const app = document.getElementById("app");
    app.innerHTML = `
      ${renderHeader()}
      ${renderNav()}
      <main>${renderTab()}</main>
      ${renderModal()}
    `;

    bind();

    const sel = keep.action ? `[data-action="${keep.action}"]` :
                keep.field  ? `[data-field="${keep.field}"]`  : null;

    if(sel){
      const el = document.querySelector(sel);
      if(el && typeof el.focus==="function"){
        el.focus();
        if(keep.pos!==null && typeof el.setSelectionRange==="function"){
          el.setSelectionRange(keep.pos, keep.pos);
        }
      }
    }
  }

  function renderHeader(){
    return `
      <header>
        <h1>Absolut 37</h1>
        <div class="sub">Tilauksen hallinta</div>
      </header>
    `;
  }

  function renderNav(){
    const tabs = [
      ["dashboard","Dashboard"],
      ["sailings","Purjehdukset"],
      ["customers","Asiakkaat"],
      ["invoicing","Laskutus"]
    ];
    return `
      <nav>
        ${tabs.map(([id,label])=>`
          <button data-tab="${id}" class="${state.tab===id?"active":""}">${label}</button>
        `).join("")}
      </nav>
    `;
  }

  function renderTab(){
    if(state.tab==="dashboard") return renderDashboard();
    if(state.tab==="sailings")  return renderSailings();
    if(state.tab==="customers") return renderCustomers();
    if(state.tab==="invoicing") return renderInvoicing();
    return "";
  }

  function renderDashboard(){
    return `
      <div class="card">
        <div class="row between">
          <div>
            <h2 style="margin:0 0 6px 0">Dashboard</h2>
            <div class="muted">Tallennus: localStorage (t√§h√§n laitteeseen)</div>
          </div>
          <div class="row">
            <button class="btn secondary" data-action="backup-json">üíæ Varmuuskopio (JSON)</button>
            <label class="btn secondary" style="display:inline-flex;align-items:center;gap:8px">
              ‚ôªÔ∏è Palauta
              <input type="file" accept="application/json" style="display:none" data-action="restore-json">
            </label>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid3">
          <div class="note">
            <div style="font-weight:900">Asiakkaita</div>
            <div style="font-size:28px;font-weight:900">${state.customers.length}</div>
          </div>
          <div class="note">
            <div style="font-weight:900">Purjehduksia</div>
            <div style="font-size:28px;font-weight:900">${state.sailings.length}</div>
          </div>
          <div class="note">
            <div style="font-weight:900">Ilmoittautumisia</div>
            <div style="font-size:28px;font-weight:900">${state.enrollments.length}</div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="muted small">
          ALV: Charter 13,5% ‚Ä¢ Muut 25,5% ‚Ä¢ Hinnat sis√§lt√§v√§t ALV:n (laskutuksessa erotellaan netto/ALV).
        </div>
      </div>
    `;
  }

  function renderCustomers(){
    const term = (state.searchCustomers||"").toLowerCase().trim();

    const list = state.customers
      .slice()
      .sort((a,b)=>(a.name||"").localeCompare(b.name||""))
      .filter(c =>
        !term ||
        (c.name||"").toLowerCase().includes(term) ||
        (c.phone||"").toLowerCase().includes(term) ||
        (c.email||"").toLowerCase().includes(term)
      );

    return `
      <div class="card">
        <div class="row between">
          <div>
            <h2 style="margin:0 0 6px 0">Asiakkaat</h2>
            <div class="muted">Lis√§√§ / muokkaa / poista.</div>
          </div>
          <button class="btn primary" data-action="new-customer">+ Lis√§√§ asiakas</button>
        </div>

        <div class="hr"></div>

        <label>Haku</label>
        <input data-action="search-customers" value="${esc(state.searchCustomers)}" placeholder="Hae nimell√§ / puhelin / email">

        <div class="hr"></div>

        ${list.length===0 ? `<div class="muted">Ei osumia.</div>` : `
          ${list.map(c=>{
            const custEnrolls = state.enrollments.filter(e=>e.customerId===c.id);
            const last = custEnrolls
              .map(e=>({ e, s: state.sailings.find(x=>x.id===e.eventId) }))
              .filter(x=>x.s)
              .sort((a,b)=>(b.s.date||"").localeCompare(a.s.date||""))[0];

            return `
              <div class="item">
                <div style="flex:1">
                  <h3 style="margin:0 0 4px 0">
                    ${esc(c.name||"")}
                    ${last ? `<span class="pill">${esc(last.s.name)} (${fmtDate(last.s.date)})</span>` : ``}
                  </h3>
                  <div class="meta">
                    ${esc(c.phone||"")}${(c.phone&&c.email)?" ‚Ä¢ ":""}${esc(c.email||"")}
                    ${custEnrolls.length ? ` ‚Ä¢ Ilmoittautumisia: ${custEnrolls.length}` : ``}
                  </div>
                </div>
                <div class="row" style="align-items:flex-start">
                  <button class="btn secondary" data-action="edit-customer" data-id="${c.id}">Muokkaa</button>
                  <button class="btn danger" data-action="delete-customer" data-id="${c.id}">Poista</button>
                </div>
              </div>
            `;
          }).join("")}
        `}
      </div>
    `;
  }

  function renderSailings(){
    const term = (state.searchSailings||"").toLowerCase().trim();

    const group = SAILING_GROUPS.find(g=>g.id===state.sailingGroup) || SAILING_GROUPS[0];
    const allowedTypes = group.types; // null = kaikki

    const list = state.sailings
      .slice()
      .sort((a,b)=>(a.date||"").localeCompare(b.date||""))
      .filter(s=>{
        const okGroup = !allowedTypes ? true : allowedTypes.includes(s.type);
        if(!okGroup) return false;

        return !term ||
          (s.name||"").toLowerCase().includes(term) ||
          (s.type||"").toLowerCase().includes(term) ||
          (s.date||"").includes(term);
      });

    const countsByGroup = {};
    SAILING_GROUPS.forEach(g=>{
      if(!g.types){ countsByGroup[g.id]=state.sailings.length; return; }
      countsByGroup[g.id]=state.sailings.filter(s=>g.types.includes(s.type)).length;
    });

    return `
      <div class="card">
        <div class="row between">
          <div>
            <h2 style="margin:0 0 6px 0">Purjehdukset</h2>
            <div class="muted">Ryhmitelty type-kent√§n perusteella. T√§ytt√∂aste ja kurssip√§iv√§t n√§kyv√§t listassa.</div>
          </div>
          <button class="btn primary" data-action="new-sailing">+ Lis√§√§</button>
        </div>

        <div class="hr"></div>

        <div class="groupbar">
          ${SAILING_GROUPS.map(g=>`
            <button class="groupbtn ${state.sailingGroup===g.id?"active":""}"
              data-action="set-sailing-group" data-id="${g.id}">
              ${esc(g.label)} (${countsByGroup[g.id]||0})
            </button>
          `).join("")}
        </div>

        <label>Haku</label>
        <input data-action="search-sailings" value="${esc(state.searchSailings||"")}" placeholder="Hae nimell√§ / tyypill√§ / p√§iv√§ll√§ (YYYY-MM-DD)">

        <div class="hr"></div>

        ${list.length===0 ? `<div class="muted">Ei purjehduksia.</div>` : `
          ${list.map(s=>{
            const booked = enrolledQty(s.id);
            const max = Number(s.maxPersons||0)||0;

            const sessions = Array.isArray(s.sessions) ? s.sessions : [];
            const sessionsUI = (s.type==="Kurssi") ? `
              <div class="sessionbox">
                <div class="sessionhead">
                  <div style="font-weight:900">Kurssip√§iv√§t</div>
                  <button class="btn secondary" data-action="add-session" data-id="${s.id}">+ Lis√§√§ p√§iv√§</button>
                </div>
                ${sessions.length===0 ? `<div class="muted">Ei p√§ivi√§ lis√§ttyn√§.</div>` : `
                  ${sessions.map((x,idx)=>`
                    <div class="sessionitem">
                      <div>
                        <div style="font-weight:900">
                          ${esc(x.date||"")}
                          ${x.start ? " klo "+esc(x.start) : ""}${x.end ? "‚Äì"+esc(x.end) : ""}
                        </div>
                        ${x.note ? `<div class="sessionmeta">${esc(x.note)}</div>` : ``}
                      </div>
                      <button class="btn danger" data-action="delete-session" data-id="${s.id}" data-idx="${idx}">Poista</button>
                    </div>
                  `).join("")}
                `}
              </div>
            ` : "";

            const attendeesUI = (state.openSailingId===s.id) ? `
              <div style="margin:8px 0 16px 0;padding:12px;background:#f8fafc;border-radius:12px;border:1px solid var(--line)">
                ${state.enrollments.filter(e=>e.eventId===s.id).length===0 ? `<div class="muted">Ei ilmoittautumisia</div>` : `
                  ${state.enrollments
                    .filter(e=>e.eventId===s.id)
                    .map(e=>{
                      const c = state.customers.find(x=>x.id===e.customerId);
                      const qty = Number(e.qty||1)||1;
                      const payer = payerLabel(e);
                      const isCompany = (e.payerType==="company");
                      return `
                        <div style="padding:8px 0;border-top:1px dashed #dbe2ea">
                          <div style="font-weight:900">${esc(c?c.name:"(Asiakas puuttuu)")} <span class="pill">${qty} hl√∂</span></div>
                          <div class="muted small">
                            Maksaja: ${esc(payer)}${isCompany ? " (yritys)" : " (asiakas)"}
                          </div>
                        </div>
                      `;
                    }).join("")
                `}
              </div>
            ` : "";

            return `
              <div class="item">
                <div style="flex:1">
                  <h3 style="margin:0 0 4px 0">
                    ${esc(s.name||"")}
                    <span class="pill">${esc(s.type||"")}</span>
                  </h3>
                  <div class="meta">
                    ${fmtDate(s.date)} ‚Ä¢ Max ${Number(s.maxPersons||0)} hl√∂ ‚Ä¢ ${Number(s.pricePerPerson||0).toFixed(2)} ‚Ç¨/hl√∂ (sis ALV)
                    ‚Ä¢ Ilmoittautuneet: ${booked}
                  </div>
                  ${fillUI(booked,max)}
                  ${sessionsUI}
                </div>

                <div class="row" style="align-items:flex-start">
                  <button class="btn secondary" data-action="toggle-sailing" data-id="${s.id}">
                    ${state.openSailingId===s.id ? "Piilota asiakkaat" : "N√§yt√§ asiakkaat"}
                  </button>
                  <button class="btn secondary" data-action="edit-sailing" data-id="${s.id}">Muokkaa</button>
                  <button class="btn danger" data-action="delete-sailing" data-id="${s.id}">Poista</button>
                </div>
              </div>
              ${attendeesUI}
            `;
          }).join("")}
        `}
      </div>
    `;
  }

  function renderInvoicing(){
    const sailingsSorted = state.sailings.slice().sort((a,b)=>(a.date||"").localeCompare(b.date||""));
    const selectedId = state.invoicingEventId || (sailingsSorted[0]?.id || "");
    const selected = state.sailings.find(s=>s.id===selectedId) || null;
    if(!state.invoicingEventId && selectedId) state.invoicingEventId = selectedId;

    const list = state.enrollments.filter(e=>e.eventId===selectedId);

    const groups = {};
    list.forEach(e=>{
      const k = payerKey(e);
      if(!groups[k]) groups[k]=[];
      groups[k].push(e);
    });
    const keys = Object.keys(groups);

    const header = `
      <div class="card">
        <div class="row between">
          <div>
            <h2 style="margin:0 0 6px 0">Laskutus</h2>
            <div class="muted">Ryhmittely maksajan mukaan. Hinnat sis√§lt√§v√§t ALV:n ‚Üí netto/ALV erotellaan.</div>
          </div>
          <div class="row">
            <button class="btn secondary" data-action="add-company">+ Lis√§√§ yritys</button>
            <button class="btn secondary" data-action="export-invoice-csv">‚¨áÔ∏è Vie CSV</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid2">
          <div>
            <label>Tapahtuma</label>
            <select data-action="set-invoice-event">
              ${sailingsSorted.map(s=>`
                <option value="${s.id}" ${s.id===selectedId?"selected":""}>
                  ${esc(s.name)} (${fmtDate(s.date)}) ‚Ä¢ ${esc(s.type||"")}
                </option>
              `).join("")}
            </select>
            <div class="muted small" style="margin-top:8px">
              ALV: Charter 13,5% ‚Ä¢ Muut 25,5% (hinnat sis√§lt√§v√§t ALV:n)
            </div>
          </div>
          <div class="note">
            <div style="font-weight:900">S√§√§nt√∂</div>
            <div class="muted small" style="margin-top:6px;line-height:1.4">
              Jos maksaja = yritys: brutosta v√§hennet√§√§n provisio (brutto) ja j√§ljelle j√§√§v√§st√§ lasketaan netto + ALV.
            </div>
          </div>
        </div>
      </div>
    `;

    if(!selectedId) return header + `<div class="card" style="margin-top:12px"><div class="muted">Ei purjehduksia.</div></div>`;
    if(!selected) return header + `<div class="card" style="margin-top:12px"><div class="muted">Valittua tapahtumaa ei l√∂ytynyt.</div></div>`;

    let totalGross=0,totalNet=0,totalVat=0,totalCommission=0,totalPayable=0;

    const body = `
      <div class="card" style="margin-top:12px">
        <div class="row between">
          <div>
            <div style="font-weight:900;font-size:16px">${esc(selected.name)} <span class="pill">${esc(selected.type||"")}</span></div>
            <div class="muted small">${fmtDate(selected.date)} ‚Ä¢ Ilmoittautumisia: ${list.length}</div>
          </div>
        </div>

        <div class="hr"></div>

        ${keys.length===0 ? `<div class="muted">Ei ilmoittautumisia valittuun tapahtumaan.</div>` : `
          ${keys.map(k=>{
            const rows = groups[k];

            let gGross=0,gNet=0,gVat=0,gComm=0,gPay=0;

            const rowsHtml = rows.map(e=>{
              const qty = Number(e.qty||1)||1;
              const unitGross = Number(e.unitPriceGross||0);
              const gross = unitGross * qty;

              const vatRate = (typeof e.vatRate === "number") ? e.vatRate : getVatRateByType(selected.type);
              const comm = (e.payerType==="company") ? calcCommissionGross(e) : 0;
              const payableGross = Math.max(0, gross - comm);
              const split = splitVatFromGross(payableGross, vatRate);

              gGross += gross;
              gComm  += comm;
              gPay   += payableGross;
              gNet   += split.net;
              gVat   += split.vat;

              const c = state.customers.find(x=>x.id===e.customerId);

              return `
                <div style="padding:10px 0;border-top:1px dashed #dbe2ea">
                  <div class="row between" style="align-items:flex-start">
                    <div>
                      <div style="font-weight:900">${esc(c?c.name:"(Asiakas puuttuu)")}</div>
                      <div class="muted small">
                        ${qty} √ó ${unitGross.toFixed(2)} ‚Ç¨ (sis ALV) = ${gross.toFixed(2)} ‚Ç¨
                        ${e.payerType==="company" ? ` ‚Ä¢ Provisio ${comm.toFixed(2)} ‚Ç¨` : ``}
                      </div>
                    </div>
                    <div style="text-align:right">
                      <div style="font-weight:900">${split.gross.toFixed(2)} ‚Ç¨</div>
                      <div class="muted small">Netto ${split.net.toFixed(2)} ‚Ä¢ ALV ${split.vat.toFixed(2)}</div>
                    </div>
                  </div>
                </div>
              `;
            }).join("");

            const label = payerLabel(rows[0]);

            totalGross += gGross;
            totalCommission += gComm;
            totalPayable += gPay;
            totalNet += gNet;
            totalVat += gVat;

            return `
              <div style="margin-bottom:14px">
                <div class="row between">
                  <div style="font-weight:900">${esc(label)}</div>
                  <div class="muted small">
                    Brutto ${round2(gGross).toFixed(2)} ‚Ç¨
                    ${gComm>0 ? ` ‚Ä¢ Provisio ${round2(gComm).toFixed(2)} ‚Ç¨` : ``}
                  </div>
                </div>

                <div style="margin-top:6px;border:1px solid var(--line);border-radius:12px;padding:10px;background:#f8fafc">
                  ${rowsHtml}
                  <div style="border-top:1px solid var(--line);margin-top:10px;padding-top:10px" class="row between">
                    <div class="muted small">Netto ${round2(gNet).toFixed(2)} ‚Ç¨ ‚Ä¢ ALV ${round2(gVat).toFixed(2)} ‚Ç¨</div>
                    <div style="font-weight:900">Laskutettava ${round2(gPay).toFixed(2)} ‚Ç¨</div>
                  </div>
                </div>
              </div>
            `;
          }).join("")}

          <div class="hr"></div>
          <div class="row between">
            <div style="font-weight:900">KOKO TAPAHTUMA</div>
            <div style="text-align:right">
              <div style="font-weight:900">Laskutettava ${round2(totalPayable).toFixed(2)} ‚Ç¨</div>
              <div class="muted small">
                Brutto ${round2(totalGross).toFixed(2)} ‚Ç¨
                ${totalCommission>0 ? ` ‚Ä¢ Provisio ${round2(totalCommission).toFixed(2)} ‚Ç¨` : ``}
                ‚Ä¢ Netto ${round2(totalNet).toFixed(2)} ‚Ç¨ ‚Ä¢ ALV ${round2(totalVat).toFixed(2)} ‚Ç¨
              </div>
            </div>
          </div>
        `}
      </div>
    `;

    return header + body;
  }

  function renderModal(){
    if(!state.modal) return "";

    if(state.modal==="customer"){
      const editing = !!state.editCustomerId;
      const c = editing ? state.customers.find(x=>x.id===state.editCustomerId) : null;

      // Esit√§yt√§
      const name  = c ? (c.name||"")  : "";
      const phone = c ? (c.phone||"") : "";
      const email = c ? (c.email||"") : "";

      // Uusi ilmoittautuminen (valinnainen)
      const sailingsSorted = state.sailings.slice().sort((a,b)=>(a.date||"").localeCompare(b.date||""));
      return `
        <div class="overlay" data-action="close-modal">
          <div class="modal" onclick="event.stopPropagation()">
            <header>
              <div class="row between">
                <h2>${editing ? "Muokkaa asiakasta" : "Uusi asiakas"}</h2>
                <button class="btn secondary" data-action="close-modal">Sulje</button>
              </div>
            </header>

            <div class="body">
              <div class="grid2">
                <div>
                  <label>Nimi *</label>
                  <input data-field="c_name" value="${esc(name)}" placeholder="Etunimi Sukunimi">
                </div>
                <div>
                  <label>Puhelin</label>
                  <input data-field="c_phone" value="${esc(phone)}" placeholder="0401234567">
                </div>
              </div>

              <div style="margin-top:12px">
                <label>Email</label>
                <input data-field="c_email" value="${esc(email)}" placeholder="nimi@esimerkki.fi">
              </div>

              <div class="hr"></div>

              <div class="note">
                <div style="font-weight:900;margin-bottom:8px">Ilmoittautuminen (valinnainen)</div>

                <div class="grid2">
                  <div>
                    <label>Purjehdus / tapahtuma</label>
                    <select data-field="e_eventId">
                      <option value="">-- Ei ilmoittautumista --</option>
                      ${sailingsSorted.map(s=>`
                        <option value="${s.id}">
                          ${esc(s.name)} (${fmtDate(s.date)}) ‚Ä¢ ${esc(s.type||"")}
                        </option>
                      `).join("")}
                    </select>
                  </div>

                  <div>
                    <label>M√§√§r√§ (hl√∂)</label>
                    <input type="number" min="1" step="1" value="1" data-field="e_qty">
                  </div>
                </div>

                <div class="grid2" style="margin-top:12px">
                  <div>
                    <label>Yksikk√∂hinta ‚Ç¨/hl√∂ (sis ALV)</label>
                    <input type="number" min="0" step="0.01" value="0" data-field="e_unitGross">
                    <div class="muted small" style="margin-top:6px">Jos j√§t√§t 0 ‚Üí k√§ytet√§√§n purjehduksen hinta/hl√∂.</div>
                  </div>

                  <div>
                    <label>Maksaja</label>
                    <select data-field="e_payerType">
                      <option value="customer">Asiakas</option>
                      <option value="company">Yritys</option>
                    </select>
                  </div>
                </div>

                <div class="grid2" style="margin-top:12px">
                  <div>
                    <label>Yritys (jos maksaja = yritys)</label>
                    <select data-field="e_companyId">
                      <option value="">-- Valitse yritys --</option>
                      ${state.companies.map(co=>`<option value="${co.id}">${esc(co.name)}</option>`).join("")}
                    </select>
                  </div>

                  <div>
                    <label>Provisio</label>
                    <div class="grid2" style="grid-template-columns:140px 1fr;gap:10px">
                      <select data-field="e_commType">
                        <option value="percent">%</option>
                        <option value="fixed">‚Ç¨</option>
                      </select>
                      <input type="number" min="0" step="0.01" value="0" data-field="e_commValue">
                    </div>
                    <div class="muted small" style="margin-top:6px">Provisio v√§hennet√§√§n brutosta ennen yrityslaskutusta.</div>
                  </div>
                </div>
              </div>

              <div class="row" style="justify-content:flex-end;margin-top:16px">
                <button class="btn primary" data-action="save-customer">${editing ? "Tallenna muutokset" : "Tallenna"}</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    if(state.modal==="sailing"){
      const editing = !!state.editSailingId;
      const s = editing ? state.sailings.find(x=>x.id===state.editSailingId) : null;

      const name = s ? (s.name||"") : "";
      const date = s ? (s.date||today()) : today();
      const type = s ? (s.type||SAILING_TYPES[0]) : SAILING_TYPES[0];
      const maxPersons = s ? Number(s.maxPersons||1) : 6;
      const price = s ? Number(s.pricePerPerson||0) : 0;

      return `
        <div class="overlay" data-action="close-modal">
          <div class="modal" onclick="event.stopPropagation()">
            <header>
              <div class="row between">
                <h2>${editing ? "Muokkaa purjehdusta" : "Uusi purjehdus"}</h2>
                <button class="btn secondary" data-action="close-modal">Sulje</button>
              </div>
            </header>

            <div class="body">
              <label>Nimi *</label>
              <input data-field="s_name" value="${esc(name)}" placeholder="esim. Iltapurjehdus Suomenlinna">

              <div class="grid2" style="margin-top:12px">
                <div>
                  <label>P√§iv√§ *</label>
                  <input type="date" data-field="s_date" value="${esc(date)}">
                </div>
                <div>
                  <label>Tyyppi *</label>
                  <select data-field="s_type">
                    ${SAILING_TYPES.map(t=>`<option value="${esc(t)}" ${t===type?"selected":""}>${esc(t)}</option>`).join("")}
                  </select>
                </div>
              </div>

              <div class="grid2" style="margin-top:12px">
                <div>
                  <label>Max hl√∂ *</label>
                  <input type="number" min="1" step="1" data-field="s_max" value="${maxPersons}">
                </div>
                <div>
                  <label>Hinta/hl√∂ (‚Ç¨) sis ALV *</label>
                  <input type="number" min="0" step="0.01" data-field="s_price" value="${price}">
                </div>
              </div>

              <div class="row" style="justify-content:flex-end;margin-top:16px">
                <button class="btn primary" data-action="save-sailing">${editing ? "Tallenna muutokset" : "Tallenna"}</button>
              </div>

              ${editing && String(type)==="Kurssi" ? `
                <div class="hr"></div>
                <div class="note">
                  <div style="font-weight:900">Kurssip√§iv√§t</div>
                  <div class="muted small" style="margin-top:6px">
                    Kurssip√§ivi√§ hallitaan Purjehdukset-listassa (Lis√§√§ p√§iv√§ / Poista).
                  </div>
                </div>
              ` : ``}
            </div>
          </div>
        </div>
      `;
    }

    return "";
  }

  function bind(){
    // tabit
    document.querySelectorAll("[data-tab]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        state.tab = btn.dataset.tab;
        render();
      });
    });

    // actionit (click)
    document.querySelectorAll("[data-action]").forEach(el=>{
      // restore-json on <input type=file> => k√§sitell√§√§n erikseen
      if(el.tagName==="INPUT" && el.type==="file" && el.dataset.action==="restore-json"){
        el.onchange = async (e)=>{
          const file = e.target.files && e.target.files[0];
          if(!file) return;

          try{
            const text = await file.text();
            const data = JSON.parse(text);

            if(!confirm("Palautetaanko varmuuskopio? T√§m√§ korvaa nykyiset tiedot t√§ss√§ laitteessa.")) return;

            state.customers   = Array.isArray(data.customers)   ? data.customers   : [];
            state.sailings    = Array.isArray(data.sailings)    ? data.sailings    : [];
            state.enrollments = Array.isArray(data.enrollments) ? data.enrollments : [];
            state.companies   = Array.isArray(data.companies)   ? data.companies   : [];

            save();
            render();
          }catch(err){
            alert("Varmuuskopion luku ep√§onnistui.");
          }finally{
            e.target.value = ""; // sama tiedosto voidaan valita uudelleen
          }
        };
        return;
      }

      el.onclick = ()=>{
        const a = el.dataset.action;
        const itemId = el.dataset.id;
        const idx = (typeof el.dataset.idx !== "undefined") ? Number(el.dataset.idx) : null;

        if(a==="new-customer"){ state.modal="customer"; state.editCustomerId=null; render(); return; }
        if(a==="new-sailing"){ state.modal="sailing"; state.editSailingId=null; render(); return; }
        if(a==="close-modal"){ state.modal=null; state.editCustomerId=null; state.editSailingId=null; render(); return; }

        if(a==="edit-customer"){ state.modal="customer"; state.editCustomerId=itemId; render(); return; }
        if(a==="edit-sailing"){ state.modal="sailing"; state.editSailingId=itemId; render(); return; }

        if(a==="set-sailing-group"){ state.sailingGroup=itemId || "all"; render(); return; }

        if(a==="toggle-sailing"){
          state.openSailingId = (state.openSailingId===itemId) ? null : itemId;
          render();
          return;
        }

        if(a==="add-company"){
          const name = (prompt("Yrityksen nimi:", "") || "").trim();
          if(!name) return;
          state.companies.push({ id: makeId("CO"), name });
          save(); render(); return;
        }

        if(a==="add-session"){
          const s = state.sailings.find(x=>x.id===itemId);
          if(!s) return;

          const date = prompt("Kurssip√§iv√§ (YYYY-MM-DD):", today());
          if(!date) return;
          const start = prompt("Aloitusaika (HH:MM), tyhj√§ sallittu:", "17:00") || "";
          const end = prompt("Lopetusaika (HH:MM), tyhj√§ sallittu:", "20:00") || "";
          const note = prompt("Lis√§huomio (valinnainen):", "") || "";

          if(!Array.isArray(s.sessions)) s.sessions=[];
          s.sessions.push({ date, start, end, note });

          save(); render(); return;
        }

        if(a==="delete-session"){
          const s = state.sailings.find(x=>x.id===itemId);
          if(!s || !Array.isArray(s.sessions)) return;
          if(idx===null || Number.isNaN(idx)) return;
          if(!confirm("Poistetaanko kurssip√§iv√§?")) return;
          s.sessions.splice(idx,1);
          save(); render(); return;
        }

        if(a==="delete-customer"){
          if(!confirm("Poistetaanko asiakas?")) return;
          state.customers = state.customers.filter(c=>c.id!==itemId);
          // poista my√∂s ilmoittautumiset
          state.enrollments = state.enrollments.filter(e=>e.customerId!==itemId);
          save(); render(); return;
        }

        if(a==="delete-sailing"){
          if(!confirm("Poistetaanko purjehdus?")) return;
          state.sailings = state.sailings.filter(s=>s.id!==itemId);
          // poista my√∂s ilmoittautumiset tapahtumaan
          state.enrollments = state.enrollments.filter(e=>e.eventId!==itemId);
          if(state.openSailingId===itemId) state.openSailingId=null;
          if(state.invoicingEventId===itemId) state.invoicingEventId="";
          save(); render(); return;
        }

        if(a==="backup-json"){
          const payload = {
            exportDate: new Date().toISOString(),
            customers: state.customers,
            sailings: state.sailings,
            enrollments: state.enrollments,
            companies: state.companies
          };
          const blob = new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "absolut37_backup_" + new Date().toISOString().slice(0,10) + ".json";
          link.click();
          URL.revokeObjectURL(url);
          return;
        }

        if(a==="export-invoice-csv"){
          const eventId = state.invoicingEventId;
          const s = state.sailings.find(x=>x.id===eventId);
          if(!s) return alert("Valitse ensin tapahtuma.");

          const rows = state.enrollments.filter(e=>e.eventId===eventId);

          const lines = [];
          lines.push([
            "Tapahtuma","P√§iv√§","Tyyppi",
            "Maksaja","Asiakas",
            "M√§√§r√§","Yksikk√∂hinta (sis ALV)","Brutto",
            "Provisio (brutto)","Laskutettava (brutto)",
            "Netto","ALV","ALV %"
          ].join(";"));

          rows.forEach(e=>{
            const cust = state.customers.find(x=>x.id===e.customerId);
            const payer = payerLabel(e);
            const qty = Number(e.qty||1)||1;
            const unitGross = Number(e.unitPriceGross||0);
            const gross = unitGross*qty;

            const vatRate = (typeof e.vatRate==="number") ? e.vatRate : getVatRateByType(s.type);
            const comm = (e.payerType==="company") ? calcCommissionGross(e) : 0;
            const payableGross = Math.max(0, gross - comm);
            const split = splitVatFromGross(payableGross, vatRate);

            lines.push([
              (s.name||""), (s.date||""), (s.type||""),
              payer, (cust?cust.name:""),
              qty,
              unitGross.toFixed(2).replace(".",","),
              gross.toFixed(2).replace(".",","),
              comm.toFixed(2).replace(".",","),
              payableGross.toFixed(2).replace(".",","),
              split.net.toFixed(2).replace(".",","),
              split.vat.toFixed(2).replace(".",","),
              (vatRate*100).toFixed(1).replace(".",",")
            ].map(x=>`"${String(x).replace(/"/g,'""')}"`).join(";"));
          });

          const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
          const url = URL.createObjectURL(blob);
          const a2 = document.createElement("a");
          a2.href = url;
          a2.download = "laskutus_"+(s.date||today())+"_"+(s.name||"tapahtuma").replace(/[^\w\-]+/g,"_")+".csv";
          a2.click();
          URL.revokeObjectURL(url);
          return;
        }

        // Save customer (create/edit + optional enrollment)
        if(a==="save-customer"){
          const name = (document.querySelector('[data-field="c_name"]')?.value || "").trim();
          if(!name) return alert("Nimi on pakollinen.");

          const phone = (document.querySelector('[data-field="c_phone"]')?.value || "").trim();
          const email = (document.querySelector('[data-field="c_email"]')?.value || "").trim();

          const eventId = (document.querySelector('[data-field="e_eventId"]')?.value || "").trim();
          const qty = Math.max(1, parseInt(document.querySelector('[data-field="e_qty"]')?.value,10) || 1);
          let unitGross = parseFloat(document.querySelector('[data-field="e_unitGross"]')?.value) || 0;

          const payerType = (document.querySelector('[data-field="e_payerType"]')?.value || "customer");
          const companyId = (document.querySelector('[data-field="e_companyId"]')?.value || "");
          const commType  = (document.querySelector('[data-field="e_commType"]')?.value || "percent");
          const commValue = parseFloat(document.querySelector('[data-field="e_commValue"]')?.value) || 0;

          let cid = state.editCustomerId;
          if(cid){
            const c = state.customers.find(x=>x.id===cid);
            if(!c) return alert("Asiakasta ei l√∂ytynyt.");
            c.name = name; c.phone = phone; c.email = email;
          }else{
            cid = makeId("C");
            state.customers.push({ id:cid, name, phone, email });
          }

          // Optional enrollment
          if(eventId){
            const s = state.sailings.find(x=>x.id===eventId);
            if(!s) return alert("Valittua tapahtumaa ei l√∂ytynyt.");

            // jos unitGross = 0, k√§yt√§ purjehduksen hintaa
            if(!(unitGross>0)) unitGross = Number(s.pricePerPerson||0) || 0;

            // kapasiteettitarkistus (est√§√§ ylibuukkauksen)
            const max = Number(s.maxPersons||0) || 0;
            const booked = enrolledQty(eventId);
            if(max>0 && (booked + qty) > max){
              return alert(`Purjehdus on t√§ynn√§ / ylittyy: ${booked}/${max}. Et voi lis√§t√§ ${qty} hl√∂.`);
            }

            // jos maksaja=yritys, vaadi yritys
            if(payerType==="company" && !companyId){
              return alert("Valitse yritys (maksaja = yritys).");
            }

            state.enrollments.push({
              id: makeId("E"),
              customerId: cid,
              eventId,
              qty,
              unitPriceGross: unitGross,
              payerType,
              payerCompanyId: companyId,
              commission: { type: commType, value: commValue }
            });
          }

          save();
          state.modal=null; state.editCustomerId=null;
          render();
          return;
        }

        // Save sailing (create/edit)
        if(a==="save-sailing"){
          const name = (document.querySelector('[data-field="s_name"]')?.value || "").trim();
          const date = (document.querySelector('[data-field="s_date"]')?.value || "").trim();
          const type = (document.querySelector('[data-field="s_type"]')?.value || "").trim();
          const maxPersons = Math.max(1, parseInt(document.querySelector('[data-field="s_max"]')?.value,10) || 1);
          const pricePerPerson = Math.max(0, parseFloat(document.querySelector('[data-field="s_price"]')?.value) || 0);

          if(!name || !date || !type) return alert("T√§yt√§ pakolliset kent√§t (nimi, p√§iv√§, tyyppi).");

          if(state.editSailingId){
            const s = state.sailings.find(x=>x.id===state.editSailingId);
            if(!s) return alert("Purjehdusta ei l√∂ytynyt.");
            s.name=name; s.date=date; s.type=type; s.maxPersons=maxPersons; s.pricePerPerson=pricePerPerson;
            if(!Array.isArray(s.sessions)) s.sessions=[];
          }else{
            state.sailings.push({
              id: makeId("S"),
              name, date, type,
              maxPersons, pricePerPerson,
              sessions:[]
            });
          }

          save();
          state.modal=null; state.editSailingId=null;
          render();
          return;
        }
      };
    });

    // Hakukent√§t
    const sc = document.querySelector('[data-action="search-customers"]');
    if(sc){
      sc.oninput = (e)=>{ state.searchCustomers = e.target.value; render(); };
      sc.onkeydown = (e)=>{ if(e.key==="Enter") e.preventDefault(); };
    }

    const ss = document.querySelector('[data-action="search-sailings"]');
    if(ss){
      ss.oninput = (e)=>{ state.searchSailings = e.target.value; render(); };
      ss.onkeydown = (e)=>{ if(e.key==="Enter") e.preventDefault(); };
    }

    // Laskutuksen tapahtumavalinta
    const invSel = document.querySelector('[data-action="set-invoice-event"]');
    if(invSel){
      invSel.onchange = (e)=>{ state.invoicingEventId = e.target.value; render(); };
    }
  }

  // init
  load();
  render();
})();
</script>
</body>
</html>
