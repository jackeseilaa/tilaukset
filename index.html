<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Absolut 37 — Tilaukset</title>

<style>
/* ========= PERUS ========= */
:root{
  --navy:#234c78;
  --bg:#f3f5f7;
  --card:#ffffff;
  --muted:#6b7280;
  --line:#e5e7eb;
  --btn:#1f4b7a;
  --btn2:#eef2f7;
  --danger-bg:#fde2e2;
  --danger:#991b1b;
  --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111827}
header{background:var(--navy);color:#fff;padding:18px 20px}
header h1{margin:0;font-size:32px}
header .sub{margin-top:6px;opacity:.85;font-size:14px}
nav{background:#fff;border-bottom:1px solid var(--line);display:flex}
nav button{
  flex:1;padding:12px;border:0;background:#fff;font-weight:800;color:#374151;
  border-bottom:3px solid transparent;cursor:pointer
}
nav button.active{border-bottom-color:var(--navy);color:#111827}
main{max-width:980px;margin:0 auto;padding:18px}
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:18px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.row.between{justify-content:space-between}
.btn{border:0;border-radius:10px;padding:10px 14px;font-weight:900;cursor:pointer}
.btn.primary{background:var(--btn);color:#fff}
.btn.secondary{background:var(--btn2)}
.btn.danger{background:var(--danger-bg);color:var(--danger)}
.muted{color:var(--muted)}
.hr{border-top:1px solid var(--line);margin:14px 0}
input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px}
label{display:block;font-size:13px;font-weight:900;margin-bottom:6px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-top:1px solid var(--line);padding:8px}
.table .r{text-align:right}
.invoiceBox{border:1px solid var(--line);border-radius:14px;padding:16px;background:#fff}
.noPrint{}
@media print{
  header,nav,.noPrint{display:none!important}
  body{background:#fff}
  .card{border:0}
  .invoiceBox{border:0}
}
</style>
</head>
<body>
<div id="app"></div>

<script>
(() => {

const STORAGE_KEY="absolut37_v2_2";
const ISSUER={name:"J Sailing",businessId:"1728993-9"};
function makeId(p){return p+Math.random().toString(16).slice(2,8).toUpperCase()}
function today(){return new Date().toISOString().slice(0,10)}
function esc(s){return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}

const state={
 tab:"invoicing",
 sailings:[],
 customers:[],
 companies:[],
 invoice:{mode:"customer",sailingId:"",customerId:"",companyId:"",invoiceNo:"",invoiceDate:today()}
};

function load(){
 const raw=localStorage.getItem(STORAGE_KEY);
 if(raw){
   const d=JSON.parse(raw);
   state.sailings=d.sailings||[];
   state.customers=d.customers||[];
   state.companies=d.companies||[];
 }
 if(!state.invoice.invoiceNo) state.invoice.invoiceNo="JS-"+today().replaceAll("-","");
}
function save(){
 localStorage.setItem(STORAGE_KEY,JSON.stringify({
   sailings:state.sailings,
   customers:state.customers,
   companies:state.companies
 }));
}

function vatRate(s){
 return s.type==="Charter"?0.135:0.255;
}

function render(){
 document.getElementById("app").innerHTML=
 `<header><h1>Absolut 37</h1><div class="sub">Laskutus</div></header>
  <main>${renderInvoicing()}</main>`;
 bind();
}

function renderInvoicing(){
 const s=state.sailings.find(x=>x.id===state.invoice.sailingId)||null;
 const rate=s?vatRate(s):0.255;
 const ratePct=(rate*100).toFixed(1);

 let payerName="",payerEmail="",lines=[],grossTotal=0;

 if(s){
   const price=Number(s.pricePerPerson||0);
   if(state.invoice.mode==="customer"){
     const c=state.customers.find(x=>x.id===state.invoice.customerId);
     if(c){
       payerName=c.name;
       payerEmail=c.email;
       lines.push({title:s.name,qty:1,unit:price,total:price});
       grossTotal=price;
     }
   }else{
     const co=state.companies.find(x=>x.id===state.invoice.companyId);
     if(co){
       payerName=co.name;
       payerEmail=co.email||"";
       const cust=state.customers.filter(c=>c.companyId===co.id&&c.sailingId===s.id);
       const gross=cust.length*price;
       lines.push({title:s.name,qty:cust.length,unit:price,total:gross});
       const commission=gross*(Number(co.commissionPct||0)/100);
       if(commission>0){
         lines.push({title:"Välitysprovisio",qty:1,unit:-commission,total:-commission});
       }
       grossTotal=gross-commission;
     }
   }
 }

 const net=grossTotal/(1+rate);
 const vat=grossTotal-net;

 return `
<div class="card">
<div class="row between noPrint">
 <div>
  <label>Tapahtuma</label>
  <select data-action="inv-sailing">
   ${state.sailings.map(x=>`<option value="${x.id}" ${x.id===state.invoice.sailingId?"selected":""}>${esc(x.name)}</option>`).join("")}
  </select>
 </div>
 <div>
  <label>Malli</label>
  <select data-action="inv-mode">
   <option value="customer" ${state.invoice.mode==="customer"?"selected":""}>Asiakaskohtainen</option>
   <option value="company" ${state.invoice.mode==="company"?"selected":""}>Yrityslasku</option>
  </select>
 </div>
</div>

<div class="invoiceBox" id="invoiceBox">
 <div class="row between">
  <div>
   <b>LASKU</b><br>
   ${ISSUER.name}<br>
   Y-tunnus ${ISSUER.businessId}
  </div>
  <div>
   Nro: ${state.invoice.invoiceNo}<br>
   Päivä: ${state.invoice.invoiceDate}
  </div>
 </div>

 <div class="hr"></div>

 <div>
  <b>Maksaja:</b><br>
  ${esc(payerName||"")}<br>
  ${payerEmail?`<a href="mailto:${esc(payerEmail)}">${esc(payerEmail)}</a>`:""}
 </div>

 <div class="hr"></div>

 <table class="table">
  <thead><tr><th>Kuvaus</th><th class="r">Määrä</th><th class="r">€/hlö</th><th class="r">Yht</th></tr></thead>
  <tbody>
   ${lines.map(l=>`
     <tr>
      <td>${esc(l.title)}</td>
      <td class="r">${l.qty}</td>
      <td class="r">${l.unit.toFixed(2)}</td>
      <td class="r">${l.total.toFixed(2)}</td>
     </tr>
   `).join("")}
  </tbody>
 </table>

 <div class="hr"></div>

 <table class="table">
  <tr><td>Netto</td><td class="r">${net.toFixed(2)} €</td></tr>
  <tr><td>ALV ${ratePct}%</td><td class="r">${vat.toFixed(2)} €</td></tr>
  <tr><td><b>Yhteensä</b></td><td class="r"><b>${grossTotal.toFixed(2)} €</b></td></tr>
 </table>
</div>

<div class="hr noPrint"></div>

<div class="row noPrint">
 <button class="btn primary" data-action="print">Tulosta / PDF</button>
 <button class="btn secondary" data-action="email">Lähetä sähköpostilla</button>
</div>

</div>
`;
}

function bind(){
 document.querySelectorAll("[data-action]").forEach(el=>{
  el.onclick=()=>{
   const a=el.dataset.action;
   if(a==="print") window.print();
   if(a==="email") sendEmail();
   if(a==="inv-sailing"){}
  };
 });
 document.querySelector('[data-action="inv-sailing"]')?.addEventListener("change",e=>{
   state.invoice.sailingId=e.target.value;
   render();
 });
 document.querySelector('[data-action="inv-mode"]')?.addEventListener("change",e=>{
   state.invoice.mode=e.target.value;
   render();
 });
}

function sendEmail(){
 const box=document.getElementById("invoiceBox");
 const text=box.innerText;
 const subject=encodeURIComponent("Lasku "+state.invoice.invoiceNo);
 const body=encodeURIComponent(text);
 window.location.href=`mailto:?subject=${subject}&body=${body}`;
}

load();
render();

})();
</script>
</body>
</html>
