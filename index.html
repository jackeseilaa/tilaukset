<!-- STABLE v2.0 ‚Äì customers+sailings+sessions+groups+edit + backup/restore + invoicing(print/PDF) -->
<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Absolut 37 ‚Äî Tilaukset</title>

<style>
:root{
  --navy:#234c78;
  --bg:#f3f5f7;
  --card:#ffffff;
  --muted:#6b7280;
  --line:#e5e7eb;
  --btn:#1f4b7a;
  --btn2:#eef2f7;
  --danger-bg:#fde2e2;
  --danger:#991b1b;
  --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111827}
header{background:var(--navy);color:#fff;padding:18px 20px}
header h1{margin:0;font-size:32px}
header .sub{margin-top:6px;opacity:.85;font-size:14px}
nav{background:#fff;border-bottom:1px solid var(--line);display:flex}
nav button{
  flex:1;padding:12px;border:0;background:#fff;font-weight:700;color:#374151;
  border-bottom:3px solid transparent;cursor:pointer
}
nav button.active{border-bottom-color:var(--navy);color:#111827}
main{max-width:980px;margin:0 auto;padding:18px}
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:18px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.row.between{justify-content:space-between}
.btn{border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--btn);color:#fff}
.btn.secondary{background:var(--btn2);color:#111827}
.btn.danger{background:var(--danger-bg);color:var(--danger)}
.muted{color:var(--muted)}
.hr{border-top:1px solid var(--line);margin:14px 0}
input,select,textarea{
  width:100%;padding:10px;border:1px solid var(--line);
  border-radius:10px;font-size:15px;background:#fff
}
label{display:block;font-size:13px;font-weight:900;margin-bottom:6px;color:#374151}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@media (max-width:800px){.grid2,.grid3{grid-template-columns:1fr}}
.item{display:flex;justify-content:space-between;gap:12px;padding:12px 0;border-top:1px solid var(--line)}
.item:first-child{border-top:0}
.item h3{margin:0 0 4px 0;font-size:18px}
.meta{font-size:14px;color:var(--muted)}
.pill{background:#eef2ff;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;margin-left:8px;color:#1e3a8a}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:18px}
.modal{background:#fff;border-radius:16px;border:1px solid var(--line);width:min(720px,100%);overflow:hidden}
.modal header{background:#fff;color:#111;border-bottom:1px solid var(--line);padding:16px}
.modal header h2{margin:0;font-size:18px}
.modal .body{padding:18px}
.small{font-size:12px}
.note{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:12px 14px}

/* T√§ytt√∂aste */
.fillrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:6px}
.fillbar{flex:1;min-width:140px;height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
.fillbar > div{height:100%}
.filltext{font-size:13px;color:var(--muted);font-weight:900;white-space:nowrap}

/* Kurssip√§iv√§t */
.sessionbox{margin:10px 0 16px 0;padding:12px;background:#f8fafc;border-radius:12px;border:1px solid var(--line)}
.sessionhead{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.sessionitem{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;padding:8px 0;border-top:1px dashed #dbe2ea}
.sessionitem:first-child{border-top:0;padding-top:0}
.sessionmeta{font-size:13px;color:var(--muted)}

/* Ryhm√§otsikot */
.groupgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:800px){.groupgrid{grid-template-columns:1fr}}
.groupbtn{
  text-align:left;background:#fff;border:1px solid var(--line);border-radius:14px;
  padding:14px 14px;cursor:pointer
}
.groupbtn .t{font-weight:950}
.groupbtn .s{color:var(--muted);margin-top:6px;font-size:13px}
.groupbtn.active{outline:3px solid rgba(35,76,120,.15);border-color:#cbd5e1}

/* Lasku */
.invoiceBox{border:1px solid var(--line);border-radius:14px;padding:14px;background:#fff}
.invoiceTitle{font-size:18px;font-weight:950}
.invGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:800px){.invGrid{grid-template-columns:1fr}}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-top:1px solid var(--line);padding:10px 8px;text-align:left;vertical-align:top}
.table th{font-size:13px;color:#374151}
.table td{font-size:14px}
.table .r{text-align:right;white-space:nowrap}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;font-size:14px}
.kv div:nth-child(odd){color:#374151;font-weight:900}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#f1f5f9;border:1px solid var(--line);font-size:12px;font-weight:900;color:#0f172a}

/* Print */
@media print{
  header, nav, .noPrint{display:none !important}
  main{max-width:none;padding:0}
  body{background:#fff}
  .card{border:0}
  .invoiceBox{border:0}
}
</style>
</head>

<body>
<div id="app"></div>

<script>
(() => {
  // Virheet ruudulle (iPad)
  window.onerror = function(msg, src, line, col, err){
    const el = document.getElementById("app");
    if (!el) return;
    el.innerHTML =
      "<pre style='padding:16px;color:#b00020;white-space:pre-wrap'>" +
      "JS ERROR:\\n" + msg + "\\n" +
      (src || "") + ":" + line + ":" + col + "\\n\\n" +
      (err && err.stack ? err.stack : "") +
      "</pre>";
  };

  const STORAGE_KEY="absolut37_stable_v2_0";

  // OMA YRITYS (laskun myyj√§)
  const ISSUER = {
    name: "J Sailing",
    businessId: "1728993-9"
  };

  // ALV: Charter 13,5 %, muut 25,5 %
  function vatRateForSailing(s){
    return (s && String(s.type||"") === "Charter") ? 0.135 : 0.255;
  }

  const SAILING_TYPES=[
    "Iltapurjehdus",
    "P√§iv√§purjehdus",
    "Charter",
    "Kurssi",
    "Yritystilaisuus",
    "Purjehdusretki",
    "Muu"
  ];

  // Ryhm√§t (minimimuutos: mapataan olemassa olevaan type-kentt√§√§n)
  const SAILING_GROUPS = [
    { id:"courses", label:"Purjehduskurssit", types:["Kurssi"] },
    { id:"charter", label:"Charter", types:["Charter"] },
    { id:"evening", label:"Iltapurjehdukset", types:["Iltapurjehdus"] },
    { id:"trips", label:"Purjehdusretket", types:["Purjehdusretki"] },
    { id:"othertraining", label:"Muu koulutus", types:["Yritystilaisuus","Muu"] },
    { id:"all", label:"Kaikki", types:null }
  ];

  const state={
    tab:"dashboard",
    customers:[],
    sailings:[],
    modal:null, // "customer" | "sailing" | null
    editCustomerId:null,
    editSailingId:null,
    searchCustomers:"",
    searchSailings:"",
    openSailingId:null,
    sailingGroup:"all",

    // Laskutus UI state
    invoice: {
      sailingId:"",
      mode:"company", // "company" | "customers"
      companyKey:"",  // companyName|businessId
      invoiceNo:"",
      invoiceDate:""
    }
  };

  function makeId(p){ return p + Math.random().toString(16).slice(2,8).toUpperCase(); }
  function esc(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }
  function today(){ return new Date().toISOString().slice(0,10); }
  function fmtDate(d){ return d ? new Date(d+"T00:00:00").toLocaleDateString("fi-FI") : ""; }

  function load(){
    try{
      const raw=localStorage.getItem(STORAGE_KEY);
      if(raw){
        const data=JSON.parse(raw);
        state.customers=Array.isArray(data.customers)?data.customers:[];
        state.sailings=Array.isArray(data.sailings)?data.sailings:[];
      }
    }catch(e){}

    if(!state.invoice.invoiceDate) state.invoice.invoiceDate = today();
    if(!state.invoice.invoiceNo) state.invoice.invoiceNo = genInvoiceNo();

    // Seed jos tyhj√§
    if(state.customers.length===0 && state.sailings.length===0){
      const sid = makeId("S");
      state.sailings.push({
        id:sid,
        name:"Iltapurjehdus Suomenlinna",
        date:today(),
        type:"Iltapurjehdus",
        maxPersons:6,
        pricePerPerson:120,
        sessions:[]
      });
      state.customers.push({
        id:makeId("C"),
        name:"Testi Seppo",
        phone:"04012345678",
        email:"joku@joku.net",
        sailingId:sid,
        payerType:"customer",       // "customer" | "company"
        companyName:"",
        companyBusinessId:"",
        commissionPct:0
      });
    }

    // Default laskutukseen: valitse ensimm√§inen purjehdus
    if(!state.invoice.sailingId && state.sailings[0]) state.invoice.sailingId = state.sailings[0].id;
  }

  function save(){
    localStorage.setItem(STORAGE_KEY,JSON.stringify({
      customers:state.customers,
      sailings:state.sailings
    }));
  }

  function enrolledCount(sailingId){
    return state.customers.filter(c => c.sailingId === sailingId).length;
  }

  function fillUI(booked, max){
    const m = Math.max(1, Number(max || 0) || 1);
    const b = Math.max(0, Number(booked || 0) || 0);
    const pct = Math.max(0, Math.min(100, Math.round((b / m) * 100)));
    const color = pct >= 100 ? "#ef4444" : (pct >= 67 ? "#f59e0b" : "#22c55e");
    return `
      <div class="fillrow">
        <div class="fillbar"><div style="width:${pct}%;background:${color}"></div></div>
        <div class="filltext">${b} / ${m} (${pct}%)</div>
      </div>
    `;
  }

  function genInvoiceNo(){
    // Yksinkertainen: JS-YYYYMMDD-XXXX
    const d = today().replaceAll("-","");
    const r = Math.random().toString(16).slice(2,6).toUpperCase();
    return `JS-${d}-${r}`;
  }

  // ============ RENDER ============
  function render(){
    // S√§ilyt√§ fokus+kursori (iPad/Safari)
    const ae=document.activeElement;
    const keep={
      action: ae && ae.dataset ? ae.dataset.action : null,
      field:  ae && ae.dataset ? ae.dataset.field  : null,
      pos:    (ae && typeof ae.selectionStart==="number") ? ae.selectionStart : null
    };

    document.getElementById("app").innerHTML =
      renderHeader()+renderNav()+
      "<main>"+renderTab()+"</main>"+
      renderModal();

    bind();

    const sel = keep.action ? `[data-action="${keep.action}"]` :
                keep.field  ? `[data-field="${keep.field}"]`  : null;

    if(sel){
      const el=document.querySelector(sel);
      if(el && typeof el.focus==="function"){
        el.focus();
        if(keep.pos!==null && typeof el.setSelectionRange==="function"){
          el.setSelectionRange(keep.pos, keep.pos);
        }
      }
    }
  }

  function renderHeader(){
    return `<header>
      <h1>Absolut 37</h1>
      <div class="sub">Tilauksen hallinta</div>
    </header>`;
  }

  function renderNav(){
    const tabs=[
      ["dashboard","Dashboard"],
      ["sailings","Purjehdukset"],
      ["customers","Asiakkaat"],
      ["invoicing","Laskutus"]
    ];
    return `<nav>`+
      tabs.map(([id,label])=>
        `<button data-tab="${id}" class="${state.tab===id?"active":""}">${label}</button>`
      ).join("")+
      `</nav>`;
  }

  function renderTab(){
    if(state.tab==="dashboard")return renderDashboard();
    if(state.tab==="customers")return renderCustomers();
    if(state.tab==="sailings")return renderSailings();
    if(state.tab==="invoicing")return renderInvoicing();
    return "";
  }

  // ============ DASHBOARD ============
  function renderDashboard(){
    return `<div class="card">
      <div class="row between">
        <div>
          <h2 style="margin:0 0 6px 0">Dashboard</h2>
          <div class="muted">Tallennus: localStorage (t√§h√§n laitteeseen).</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row" style="gap:18px">
        <div class="note">
          <div style="font-weight:950">Asiakkaita</div>
          <div style="font-size:28px;font-weight:950">${state.customers.length}</div>
        </div>
        <div class="note">
          <div style="font-weight:950">Purjehduksia</div>
          <div style="font-size:28px;font-weight:950">${state.sailings.length}</div>
        </div>
        <div class="note">
          <div style="font-weight:950">Myyj√§</div>
          <div class="muted">${esc(ISSUER.name)} ‚Ä¢ Y-tunnus ${esc(ISSUER.businessId)}</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row noPrint">
        <button class="btn secondary" data-action="backup-json">üíæ Lataa varmuuskopio (JSON)</button>
        <label class="btn secondary" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
          ‚ôªÔ∏è Palauta varmuuskopio (JSON)
          <input type="file" accept="application/json" data-action="restore-json" style="display:none">
        </label>
      </div>

      <div class="muted small" style="margin-top:10px">
        Vinkki: iPadilla varmuuskopio tallentuu Tiedostot-sovellukseen (Downloads tms).
      </div>
    </div>`;
  }

  // ============ CUSTOMERS ============
  function renderCustomers(){
    const term=(state.searchCustomers||"").toLowerCase().trim();
    const list=state.customers
      .slice()
      .sort((a,b)=>(a.name||"").localeCompare(b.name||""))
      .filter(c =>
        !term ||
        (c.name||"").toLowerCase().includes(term) ||
        (c.phone||"").toLowerCase().includes(term) ||
        (c.email||"").toLowerCase().includes(term) ||
        (c.companyName||"").toLowerCase().includes(term)
      );

    return `<div class="card">
      <div class="row between">
        <div>
          <h2 style="margin:0 0 6px 0">Asiakkaat</h2>
          <div class="muted">Lis√§√§, muokkaa ja poista. Asiakas voidaan liitt√§√§ purjehdukseen.</div>
        </div>
        <button class="btn primary" data-action="new-customer">+ Lis√§√§ asiakas</button>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <label>Haku</label>
          <input data-action="search-customers" value="${esc(state.searchCustomers)}" placeholder="Hae nimell√§ / puhelin / email / yritys">
          <div class="muted small" style="margin-top:8px">Yhteens√§: ${list.length}</div>
        </div>
        <div class="note">
          <div style="font-weight:950">Maksaja</div>
          <div class="muted small">Valitse maksaja asiakasta luodessa: Asiakas itse tai Yritys (v√§litt√§j√§) + provisio%.</div>
        </div>
      </div>

      <div class="hr"></div>

      ${list.length===0 ? `<div class="muted">Ei osumia.</div>` : `
        ${list.map(c=>{
          const s = c.sailingId ? state.sailings.find(x=>x.id===c.sailingId) : null;
          const payer = (c.payerType==="company" && (c.companyName||c.companyBusinessId))
            ? `Yritys: ${esc(c.companyName||"")} ${c.companyBusinessId?`(${esc(c.companyBusinessId)})`:``} ‚Ä¢ provisio ${Number(c.commissionPct||0)}%`
            : "Asiakas maksaa itse";
          return `
            <div class="item">
              <div style="flex:1">
                <h3>
                  ${esc(c.name||"")}
                  ${s ? `<span class="pill">${esc(s.name||"")}</span>` : ``}
                </h3>
                <div class="meta">
                  ${esc(c.phone||"")}${(c.phone&&c.email)?" ‚Ä¢ ":""}${esc(c.email||"")}
                  ${payer ? ` ‚Ä¢ <span class="badge">${payer}</span>` : ``}
                </div>
              </div>
              <div class="row">
                <button class="btn secondary" data-action="edit-customer" data-id="${c.id}">Muokkaa</button>
                <button class="btn danger" data-action="delete-customer" data-id="${c.id}">Poista</button>
              </div>
            </div>
          `;
        }).join("")}
      `}
    </div>`;
  }

  // ============ SAILINGS ============
  function renderSailings(){
    const grp = state.sailingGroup || "all";
    const g = SAILING_GROUPS.find(x=>x.id===grp) || SAILING_GROUPS[SAILING_GROUPS.length-1];

    const term = (state.searchSailings || "").toLowerCase().trim();
    const base = state.sailings.slice().sort((a,b)=>(a.date||"").localeCompare(b.date||""));

    const filteredByGroup = (g.types && Array.isArray(g.types))
      ? base.filter(s => g.types.includes(String(s.type||"")))
      : base;

    const list = filteredByGroup.filter(s =>
      !term ||
      (s.name||"").toLowerCase().includes(term) ||
      (s.type||"").toLowerCase().includes(term) ||
      (s.date||"").includes(term)
    );

    const counts = (types) => {
      if(!types) return state.sailings.length;
      return state.sailings.filter(s => types.includes(String(s.type||""))).length;
    };

    // Ryhm√§valikko: jos ryhm√§√§ ei ole valittu (tai halutaan aina n√§ytt√§√§), n√§ytet√§√§n aina ylh√§√§ll√§
    const groupsUI = `
      <div class="card" style="margin-bottom:14px">
        <h2 style="margin:0 0 10px 0">Kohteet</h2>
        <div class="groupgrid">
          ${SAILING_GROUPS.map(x=>`
            <button class="groupbtn ${state.sailingGroup===x.id?'active':''}" data-action="set-group" data-id="${x.id}">
              <div class="t">${esc(x.label)}</div>
              <div class="s">M√§√§r√§: ${counts(x.types)}</div>
            </button>
          `).join("")}
        </div>
        <div class="muted small" style="margin-top:10px">Valitse ryhm√§, niin listataan sen purjehdukset alapuolella.</div>
      </div>
    `;

    return `
      ${groupsUI}

      <div class="card">
        <div class="row between">
          <div>
            <h2 style="margin:0 0 6px 0">${esc(g.label)}</h2>
            <div class="muted">Lis√§√§, muokkaa ja poista. T√§ytt√∂aste n√§kyy palkkina.</div>
          </div>
          <button class="btn primary" data-action="new-sailing">+ Lis√§√§ purjehdus</button>
        </div>

        <div class="hr"></div>

        <div class="grid2">
          <div>
            <label>Haku</label>
            <input data-action="search-sailings" value="${esc(state.searchSailings||"")}" placeholder="Hae nimell√§ / tyypill√§ / p√§iv√§ll√§ (YYYY-MM-DD)">
            <div class="muted small" style="margin-top:8px">Yhteens√§: ${list.length}</div>
          </div>
          <div class="note">
            <div style="font-weight:950">ALV</div>
            <div class="muted small">Charter: 13,5% ‚Ä¢ Muut: 25,5% ‚Ä¢ Hinnat sis√§lt√§v√§t ALV:n.</div>
          </div>
        </div>

        <div class="hr"></div>

        ${list.length===0 ? `<div class="muted">Ei purjehduksia.</div>` : `
          ${list.map(s => {
            const booked = enrolledCount(s.id);
            const max = Number(s.maxPersons || 0) || 0;

            const sessions = Array.isArray(s.sessions) ? s.sessions : [];
            const sessionsUI = (String(s.type||"")==="Kurssi")
              ? `
                <div class="sessionbox">
                  <div class="sessionhead">
                    <div style="font-weight:950">Kurssip√§iv√§t</div>
                    <button class="btn secondary" data-action="add-session" data-id="${s.id}">+ Lis√§√§ p√§iv√§</button>
                  </div>

                  ${sessions.length === 0 ? `<div class="muted">Ei p√§ivi√§ lis√§ttyn√§.</div>` : `
                    ${sessions.map((x, idx) => `
                      <div class="sessionitem">
                        <div>
                          <div style="font-weight:900">
                            ${esc(x.date || "")}
                            ${x.start ? " klo "+esc(x.start) : ""}${x.end ? "‚Äì"+esc(x.end) : ""}
                          </div>
                          ${x.note ? `<div class="sessionmeta">${esc(x.note)}</div>` : ``}
                        </div>
                        <button class="btn danger" data-action="delete-session" data-id="${s.id}" data-idx="${idx}">Poista</button>
                      </div>
                    `).join("")}
                  `}
                </div>
              `
              : "";

            const attendeesUI = (state.openSailingId === s.id)
              ? `
                <div style="margin:8px 0 16px 0;padding:12px;background:#f8fafc;border-radius:12px;border:1px solid var(--line)">
                  ${state.customers
                    .filter(c => c.sailingId === s.id)
                    .map(c => `<div style="padding:6px 0;border-top:1px dashed #dbe2ea">${esc(c.name||"")}</div>`)
                    .join("") || `<div class="muted">Ei ilmoittautuneita</div>`}
                </div>
              `
              : "";

            return `
              <div class="item">
                <div style="flex:1">
                  <h3>
                    ${esc(s.name||"")}
                    <span class="pill">${esc(s.type||"")}</span>
                  </h3>

                  <div class="meta">
                    ${fmtDate(s.date)} ‚Ä¢ Max ${Number(s.maxPersons||0)} hl√∂ ‚Ä¢ ${Number(s.pricePerPerson||0).toFixed(2)} ‚Ç¨/hl√∂
                    ‚Ä¢ Ilmoittautuneet: ${booked}
                  </div>

                  ${fillUI(booked, max)}
                  ${sessionsUI}
                </div>

                <div class="row" style="align-items:flex-start">
                  <button class="btn secondary" data-action="toggle-sailing" data-id="${s.id}">
                    ${state.openSailingId === s.id ? "Piilota asiakkaat" : "N√§yt√§ asiakkaat"}
                  </button>
                  <button class="btn secondary" data-action="edit-sailing" data-id="${s.id}">Muokkaa</button>
                  <button class="btn danger" data-action="delete-sailing" data-id="${s.id}">Poista</button>
                </div>
              </div>

              ${attendeesUI}
            `;
          }).join("")}
        `}
      </div>
    `;
  }

  // ============ INVOICING ============
  function renderInvoicing(){
    const sailing = state.sailings.find(s=>s.id===state.invoice.sailingId) || null;
    const rate = vatRateForSailing(sailing);
    const ratePct = Math.round(rate*1000)/10;

    // Ker√§√§ maksajat (yritykset) valitusta tapahtumasta
    const customersForSailing = sailing
      ? state.customers.filter(c => c.sailingId === sailing.id)
      : [];

    const companyMap = new Map(); // key => {companyName,businessId,commissionPct, customers:[]}
    for(const c of customersForSailing){
      if(c.payerType==="company" && (c.companyName || c.companyBusinessId)){
        const key = `${String(c.companyName||"").trim()}|${String(c.companyBusinessId||"").trim()}`;
        if(!companyMap.has(key)){
          companyMap.set(key, {
            companyName: String(c.companyName||"").trim(),
            businessId: String(c.companyBusinessId||"").trim(),
            commissionPct: Number(c.commissionPct||0) || 0,
            customers: []
          });
        }
        companyMap.get(key).customers.push(c);
      }
    }
    const companies = Array.from(companyMap.entries()).map(([key,val])=>({key, ...val}));

    // Jos companyKey puuttuu mutta l√∂ytyy yrityksi√§, valitse ensimm√§inen
    if(state.invoice.mode==="company" && companies.length>0 && !state.invoice.companyKey){
      state.invoice.companyKey = companies[0].key;
    }
    // Jos valittu companyKey ei en√§√§ l√∂ydy, nollaa
    if(state.invoice.mode==="company" && state.invoice.companyKey && !companyMap.has(state.invoice.companyKey)){
      state.invoice.companyKey = companies[0]?.key || "";
    }

    const selectedCompany = state.invoice.mode==="company" && state.invoice.companyKey
      ? companies.find(x=>x.key===state.invoice.companyKey) || null
      : null;

    // Laskurivit
    const unitGross = sailing ? (Number(sailing.pricePerPerson||0) || 0) : 0;

    let lines = [];
    if(sailing){
      if(state.invoice.mode==="company" && selectedCompany){
        const qty = selectedCompany.customers.length;
        const gross = qty * unitGross;
        lines.push({
          title: `${sailing.name} (${fmtDate(sailing.date)})`,
          qty,
          unitGross,
          gross
        });

        const pct = Math.max(0, Number(selectedCompany.commissionPct||0) || 0);
        const commissionGross = gross * (pct/100);
        if(pct>0 && commissionGross>0){
          lines.push({
            title: `V√§litysprovisio ${pct}%`,
            qty: 1,
            unitGross: -commissionGross,
            gross: -commissionGross
          });
        }
      } else if(state.invoice.mode==="customers"){
        // Yksitt√§isten asiakkaiden summa (tapahtumakohtainen)
        // T√§ss√§ yksinkertaisesti: laskutetaan kaikki asiakkaat, jotka maksaa itse
        const selfPay = customersForSailing.filter(c => (c.payerType||"customer")!=="company");
        const qty = selfPay.length;
        const gross = qty * unitGross;
        lines.push({
          title: `${sailing.name} (${fmtDate(sailing.date)}) ‚Äì asiakasmaksut`,
          qty,
          unitGross,
          gross
        });
      }
    }

    const grossTotal = lines.reduce((sum,l)=>sum+(Number(l.gross)||0),0);
    const netTotal = rate>0 ? (grossTotal / (1+rate)) : grossTotal;
    const vatTotal = grossTotal - netTotal;

    const payerBlock = (()=>{
      if(state.invoice.mode==="company"){
        if(!selectedCompany){
          return `<div class="note">
            <div style="font-weight:950">Yrityslasku</div>
            <div class="muted small">Valitulla purjehduksella ei ole yrityksen kautta tulevia asiakkaita (payerType=company).</div>
          </div>`;
        }
        const nm = selectedCompany.companyName || "(Nimi puuttuu)";
        const y = selectedCompany.businessId ? `Y-tunnus ${selectedCompany.businessId}` : "Y-tunnus puuttuu";
        return `<div class="note">
          <div style="font-weight:950">Maksaja</div>
          <div class="muted">${esc(nm)} ‚Ä¢ ${esc(y)}</div>
          <div class="muted small">Asiakkaita t√§ss√§ yrityksess√§: ${selectedCompany.customers.length} ‚Ä¢ provisio ${Number(selectedCompany.commissionPct||0)}%</div>
        </div>`;
      }
      // customers
      return `<div class="note">
        <div style="font-weight:950">Maksaja</div>
        <div class="muted">Yksitt√§iset asiakkaat (maksaa itse)</div>
        <div class="muted small">T√§ss√§ vaiheessa koonti on yhteenveto. Seuraavassa vaiheessa tehd√§√§n asiakaskohtaiset laskut.</div>
      </div>`;
    })();

    const invoiceHtml = `
      <div class="invoiceBox" id="invoiceBox">
        <div class="row between" style="align-items:flex-start">
          <div>
            <div class="invoiceTitle">Lasku</div>
            <div class="muted small">Hinnat sis√§lt√§v√§t ALV:n ‚Ä¢ ALV-kanta: ${ratePct}%</div>
          </div>
          <div class="kv" style="min-width:260px">
            <div>Laskun nro</div><div><b>${esc(state.invoice.invoiceNo||"")}</b></div>
            <div>P√§iv√§ys</div><div><b>${esc(state.invoice.invoiceDate||"")}</b></div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="invGrid">
          <div>
            <div style="font-weight:950;margin-bottom:6px">Myyj√§</div>
            <div class="kv">
              <div>Nimi</div><div>${esc(ISSUER.name)}</div>
              <div>Y-tunnus</div><div>${esc(ISSUER.businessId)}</div>
            </div>
          </div>
          <div>
            ${payerBlock}
          </div>
        </div>

        <div class="hr"></div>

        <div style="font-weight:950;margin-bottom:6px">Rivit</div>
        <table class="table">
          <thead>
            <tr>
              <th>Kuvaus</th>
              <th class="r">M√§√§r√§</th>
              <th class="r">‚Ç¨/hl√∂ (sis. ALV)</th>
              <th class="r">Yhteens√§ (sis. ALV)</th>
            </tr>
          </thead>
          <tbody>
            ${lines.length===0 ? `<tr><td colspan="4" class="muted">Valitse purjehdus ja maksaja.</td></tr>` : `
              ${lines.map(l=>`
                <tr>
                  <td>${esc(l.title)}</td>
                  <td class="r">${Number(l.qty||0)}</td>
                  <td class="r">${Number(l.unitGross||0).toFixed(2)}</td>
                  <td class="r">${Number(l.gross||0).toFixed(2)}</td>
                </tr>
              `).join("")}
            `}
          </tbody>
        </table>

        <div class="hr"></div>

        <div class="invGrid">
          <div class="note">
            <div style="font-weight:950">Erittely</div>
            <div class="muted small">Netto = Brutto / (1 + ALV%)</div>
            <div class="kv" style="margin-top:10px">
              <div>Netto</div><div>${netTotal.toFixed(2)} ‚Ç¨</div>
              <div>ALV (${ratePct}%)</div><div>${vatTotal.toFixed(2)} ‚Ç¨</div>
              <div>Brutto</div><div><b>${grossTotal.toFixed(2)} ‚Ç¨</b></div>
            </div>
          </div>
          <div class="note">
            <div style="font-weight:950">Huomio</div>
            <div class="muted small">
              Yrityslaskussa provisio v√§hennet√§√§n miinusrivin√§. T√§m√§ pit√§√§ ALV-erittelyn johdonmukaisena t√§ss√§ yksinkertaisessa mallissa (yksi ALV-kanta per tapahtuma).
            </div>
          </div>
        </div>
      </div>
    `;

    return `<div class="card">
      <div class="row between">
        <div>
          <h2 style="margin:0 0 6px 0">Laskutus</h2>
          <div class="muted">Valitse purjehdus ja maksaja. Tulosta PDF:ksi iPadilla Tulosta ‚Üí tallenna PDF.</div>
        </div>
        <div class="row noPrint">
          <button class="btn secondary" data-action="new-invoice-no">Uusi laskun nro</button>
          <button class="btn primary" data-action="print-invoice">Tulosta / PDF</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid3 noPrint">
        <div>
          <label>Tapahtuma</label>
          <select data-action="invoice-sailing">
            ${state.sailings.slice().sort((a,b)=>(a.date||"").localeCompare(b.date||"")).map(s=>`
              <option value="${s.id}" ${state.invoice.sailingId===s.id?"selected":""}>
                ${esc(s.name)} (${fmtDate(s.date)}) ‚Ä¢ ${esc(s.type||"")}
              </option>
            `).join("")}
          </select>
        </div>

        <div>
          <label>Malli</label>
          <select data-action="invoice-mode">
            <option value="company" ${state.invoice.mode==="company"?"selected":""}>Laskuta yrityst√§ (v√§litt√§j√§)</option>
            <option value="customers" ${state.invoice.mode==="customers"?"selected":""}>Koonti: asiakkaat maksaa itse</option>
          </select>
        </div>

        <div>
          <label>P√§iv√§ys</label>
          <input type="date" data-action="invoice-date" value="${esc(state.invoice.invoiceDate||today())}">
        </div>
      </div>

      ${state.invoice.mode==="company" ? `
        <div class="hr noPrint"></div>
        <div class="grid2 noPrint">
          <div>
            <label>Yritys</label>
            <select data-action="invoice-company">
              <option value="">-- Valitse yritys --</option>
              ${companies.map(co=>`
                <option value="${esc(co.key)}" ${state.invoice.companyKey===co.key?"selected":""}>
                  ${esc(co.companyName || "(Nimi puuttuu)")} ${co.businessId?`(${esc(co.businessId)})`:``} ‚Ä¢ asiakkaita ${co.customers.length}
                </option>
              `).join("")}
            </select>
            <div class="muted small" style="margin-top:8px">
              Yrityslistaus tulee asiakaskortilta (maksaja=Yritys).
            </div>
          </div>
          <div class="note">
            <div style="font-weight:950">Miten yritys n√§kyy laskulla?</div>
            <div class="muted small">
              Yrityksen nimi + Y-tunnus haetaan asiakkaiden maksajatiedoista (companyName, companyBusinessId).
              Jos n√§m√§ puuttuvat, t√§ydenn√§ asiakkaalta.
            </div>
          </div>
        </div>
      ` : ``}

      <div class="hr"></div>

      ${invoiceHtml}

      <div class="hr noPrint"></div>

      <div class="row noPrint">
        <button class="btn secondary" data-action="copy-invoice-text">Kopioi laskuteksti</button>
      </div>
      <div class="muted small noPrint" style="margin-top:10px">
        Seuraavassa vaiheessa: asiakaskohtaiset laskut + yrityslaskun rivien erittely asiakkaittain + laskuhistoria.
      </div>
    </div>`;
  }

  // ============ MODALS ============
  function renderModal(){
    if(!state.modal) return "";

    if(state.modal==="customer"){
      const editing = !!state.editCustomerId;
      const c = editing ? state.customers.find(x=>x.id===state.editCustomerId) : null;

      const name = c ? (c.name||"") : "";
      const phone = c ? (c.phone||"") : "";
      const email = c ? (c.email||"") : "";
      const sailingId = c ? (c.sailingId||"") : "";

      const payerType = c ? (c.payerType||"customer") : "customer";
      const companyName = c ? (c.companyName||"") : "";
      const companyBusinessId = c ? (c.companyBusinessId||"") : "";
      const commissionPct = c ? (Number(c.commissionPct||0) || 0) : 0;

      return `<div class="overlay" data-action="close-modal">
        <div class="modal" onclick="event.stopPropagation()">
          <header>
            <div class="row between">
              <h2>${editing ? "Muokkaa asiakasta" : "Uusi asiakas"}</h2>
              <button class="btn secondary" data-action="close-modal">Sulje</button>
            </div>
          </header>
          <div class="body">
            <div class="grid2">
              <div>
                <label>Nimi *</label>
                <input data-field="name" value="${esc(name)}" placeholder="Etunimi Sukunimi">
              </div>
              <div>
                <label>Purjehdus</label>
                <select data-field="sailingId">
                  <option value="">-- Ei valittu --</option>
                  ${state.sailings.slice().sort((a,b)=>(a.date||"").localeCompare(b.date||"")).map(s=>`
                    <option value="${s.id}" ${sailingId===s.id?"selected":""}>
                      ${esc(s.name)} (${fmtDate(s.date)}) ‚Ä¢ ${esc(s.type||"")}
                    </option>
                  `).join("")}
                </select>
              </div>
            </div>

            <div class="grid2" style="margin-top:12px">
              <div>
                <label>Puhelin</label>
                <input data-field="phone" value="${esc(phone)}" placeholder="0401234567">
              </div>
              <div>
                <label>Email</label>
                <input data-field="email" value="${esc(email)}" placeholder="nimi@esimerkki.fi">
              </div>
            </div>

            <div class="hr"></div>

            <div class="grid2">
              <div>
                <label>Maksaja</label>
                <select data-field="payerType">
                  <option value="customer" ${payerType==="customer"?"selected":""}>Asiakas maksaa itse</option>
                  <option value="company" ${payerType==="company"?"selected":""}>Yritys (v√§litt√§j√§)</option>
                </select>
                <div class="muted small" style="margin-top:8px">Jos valitset Yritys, t√§yt√§ yrityksen tiedot ja provisio%.</div>
              </div>
              <div class="note">
                <div style="font-weight:950">Ylibuukkaus</div>
                <div class="muted small">Jos purjehdus on t√§ynn√§, asiakasta ei voi tallentaa siihen.</div>
              </div>
            </div>

            <div class="grid2" style="margin-top:12px">
              <div>
                <label>Yrityksen nimi</label>
                <input data-field="companyName" value="${esc(companyName)}" placeholder="Yritys Oy">
              </div>
              <div>
                <label>Yrityksen Y-tunnus</label>
                <input data-field="companyBusinessId" value="${esc(companyBusinessId)}" placeholder="1234567-8">
              </div>
            </div>

            <div style="margin-top:12px">
              <label>Provisio % (vain yritykselle)</label>
              <input type="number" min="0" step="0.1" data-field="commissionPct" value="${esc(String(commissionPct))}">
            </div>

            <div class="row" style="justify-content:flex-end;margin-top:16px">
              <button class="btn primary" data-action="save-customer">${editing ? "Tallenna muutokset" : "Tallenna"}</button>
            </div>
          </div>
        </div>
      </div>`;
    }

    if(state.modal==="sailing"){
      const editing = !!state.editSailingId;
      const s = editing ? state.sailings.find(x=>x.id===state.editSailingId) : null;

      const name = s ? (s.name||"") : "";
      const date = s ? (s.date||today()) : today();
      const type = s ? (s.type||SAILING_TYPES[0]) : SAILING_TYPES[0];
      const maxPersons = s ? (Number(s.maxPersons||1)||1) : 6;
      const pricePerPerson = s ? (Number(s.pricePerPerson||0)||0) : 0;

      return `<div class="overlay" data-action="close-modal">
        <div class="modal" onclick="event.stopPropagation()">
          <header>
            <div class="row between">
              <h2>${editing ? "Muokkaa purjehdusta" : "Uusi purjehdus"}</h2>
              <button class="btn secondary" data-action="close-modal">Sulje</button>
            </div>
          </header>
          <div class="body">
            <label>Nimi *</label>
            <input data-field="name" value="${esc(name)}" placeholder="esim. Iltapurjehdus Suomenlinna">

            <div class="grid2" style="margin-top:12px">
              <div>
                <label>P√§iv√§ *</label>
                <input type="date" data-field="date" value="${esc(date)}">
              </div>
              <div>
                <label>Tyyppi *</label>
                <select data-field="type">
                  ${SAILING_TYPES.map(t=>`<option value="${esc(t)}" ${type===t?"selected":""}>${esc(t)}</option>`).join("")}
                </select>
              </div>
            </div>

            <div class="grid2" style="margin-top:12px">
              <div>
                <label>Max hl√∂ *</label>
                <input type="number" min="1" step="1" data-field="maxPersons" value="${esc(String(maxPersons))}">
              </div>
              <div>
                <label>Hinta/hl√∂ (‚Ç¨) sis. ALV *</label>
                <input type="number" min="0" step="0.01" data-field="pricePerPerson" value="${esc(String(pricePerPerson))}">
              </div>
            </div>

            <div class="row" style="justify-content:flex-end;margin-top:16px">
              <button class="btn primary" data-action="save-sailing">${editing ? "Tallenna muutokset" : "Tallenna"}</button>
            </div>

            ${editing ? `<div class="muted small" style="margin-top:10px">Kurssip√§ivi√§ muokataan Purjehdukset-listauksessa (Kurssi-tyypill√§).</div>` : ``}
          </div>
        </div>
      </div>`;
    }

    return "";
  }

  // ============ ACTIONS / BIND ============
  function bind(){
    // Tabit
    document.querySelectorAll("[data-tab]").forEach(b=>{
      b.onclick=()=>{ state.tab=b.dataset.tab; render(); };
    });

    // Kaikki data-action click
    document.querySelectorAll("[data-action]").forEach(el=>{
      const a = el.dataset.action;

      // Restore JSON on change (file input)
      if(a==="restore-json"){
        el.onchange = async (e)=>{
          const file = e.target.files && e.target.files[0];
          if(!file) return;
          try{
            const txt = await file.text();
            const data = JSON.parse(txt);
            if(!data || !Array.isArray(data.customers) || !Array.isArray(data.sailings)){
              alert("Varmuuskopio ei ole oikeassa muodossa.");
              return;
            }
            if(!confirm("Palautetaanko varmuuskopio? T√§m√§ korvaa nykyiset tiedot t√§ss√§ laitteessa.")) return;
            state.customers = data.customers;
            state.sailings = data.sailings;
            save();
            alert("Palautus valmis.");
            render();
          }catch(err){
            alert("Palautus ep√§onnistui: " + (err?.message || String(err)));
          }finally{
            e.target.value = "";
          }
        };
        return;
      }

      el.onclick=()=>{
        const itemId = el.dataset.id || "";
        const idx = (typeof el.dataset.idx !== "undefined") ? Number(el.dataset.idx) : null;

        // Dashboard
        if(a==="backup-json"){
          const blob = new Blob([JSON.stringify({
            exportDate: new Date().toISOString(),
            customers: state.customers,
            sailings: state.sailings
          },null,2)],{type:"application/json"});
          const url = URL.createObjectURL(blob);
          const x = document.createElement("a");
          x.href=url; x.download=`absolut37_backup_${today()}.json`; x.click();
          URL.revokeObjectURL(url);
          return;
        }

        // Ryhm√§
        if(a==="set-group"){
          state.sailingGroup = itemId || "all";
          render();
          return;
        }

        // Purjehdukset: listan toggle
        if(a==="toggle-sailing"){
          state.openSailingId = (state.openSailingId===itemId) ? null : itemId;
          render();
          return;
        }

        // Modaalit
        if(a==="new-customer"){
          state.modal="customer";
          state.editCustomerId=null;
          render();
          return;
        }
        if(a==="edit-customer"){
          state.modal="customer";
          state.editCustomerId=itemId;
          render();
          return;
        }
        if(a==="new-sailing"){
          state.modal="sailing";
          state.editSailingId=null;
          render();
          return;
        }
        if(a==="edit-sailing"){
          state.modal="sailing";
          state.editSailingId=itemId;
          render();
          return;
        }
        if(a==="close-modal"){
          state.modal=null;
          state.editCustomerId=null;
          state.editSailingId=null;
          render();
          return;
        }

        // Kurssip√§iv√§t
        if(a==="add-session"){
          const s = state.sailings.find(x => x.id === itemId);
          if(!s) return;
          const date = prompt("Kurssip√§iv√§ (YYYY-MM-DD):", today());
          if(!date) return;
          const start = prompt("Aloitusaika (HH:MM), tyhj√§ sallittu:", "17:00") || "";
          const end = prompt("Lopetusaika (HH:MM), tyhj√§ sallittu:", "20:00") || "";
          const note = prompt("Lis√§huomio (valinnainen):", "") || "";
          if(!Array.isArray(s.sessions)) s.sessions = [];
          s.sessions.push({ date, start, end, note });
          save();
          render();
          return;
        }
        if(a==="delete-session"){
          const s = state.sailings.find(x => x.id === itemId);
          if(!s || !Array.isArray(s.sessions)) return;
          if(idx===null || Number.isNaN(idx)) return;
          if(!confirm("Poistetaanko kurssip√§iv√§?")) return;
          s.sessions.splice(idx, 1);
          save();
          render();
          return;
        }

        // Tallenna asiakas (uusi/muokkaus)
        if(a==="save-customer"){
          const name = (document.querySelector('[data-field="name"]')?.value || "").trim();
          if(!name) return alert("Nimi pakollinen");

          const phone = (document.querySelector('[data-field="phone"]')?.value || "").trim();
          const email = (document.querySelector('[data-field="email"]')?.value || "").trim();
          const sailingId = (document.querySelector('[data-field="sailingId"]')?.value || "").trim();

          const payerType = (document.querySelector('[data-field="payerType"]')?.value || "customer").trim();
          const companyName = (document.querySelector('[data-field="companyName"]')?.value || "").trim();
          const companyBusinessId = (document.querySelector('[data-field="companyBusinessId"]')?.value || "").trim();
          const commissionPct = parseFloat(document.querySelector('[data-field="commissionPct"]')?.value) || 0;

          // EST√Ñ YLIBUUKKAUS: jos purjehdus valittu ja t√§ynn√§ (huom: muokkauksessa huomioidaan oma paikka)
          if (sailingId) {
            const s = state.sailings.find(x => x.id === sailingId);
            if (s) {
              const max = Number(s.maxPersons || 0) || 0;
              let booked = enrolledCount(sailingId);

              // jos muokataan ja asiakas oli jo t√§ss√§ purjehduksessa, √§l√§ laske itse√§√§n mukaan
              if(state.editCustomerId){
                const old = state.customers.find(x=>x.id===state.editCustomerId);
                if(old && old.sailingId === sailingId) booked = Math.max(0, booked - 1);
              }

              if (max > 0 && booked >= max) {
                return alert(`Purjehdus on t√§ynn√§ (${booked}/${max}). Valitse toinen purjehdus tai j√§t√§ tyhj√§ksi.`);
              }
            }
          }

          const payload = {
            name, phone, email, sailingId,
            payerType: (payerType==="company" ? "company" : "customer"),
            companyName: (payerType==="company" ? companyName : ""),
            companyBusinessId: (payerType==="company" ? companyBusinessId : ""),
            commissionPct: (payerType==="company" ? Math.max(0, commissionPct) : 0)
          };

          if(state.editCustomerId){
            const i = state.customers.findIndex(x=>x.id===state.editCustomerId);
            if(i>=0){
              state.customers[i] = { ...state.customers[i], ...payload };
            }
          } else {
            state.customers.push({ id: makeId("C"), ...payload });
          }

          save();
          state.modal=null;
          state.editCustomerId=null;
          render();
          return;
        }

        // Tallenna purjehdus (uusi/muokkaus)
        if(a==="save-sailing"){
          const name = (document.querySelector('[data-field="name"]')?.value || "").trim();
          const date = (document.querySelector('[data-field="date"]')?.value || "").trim();
          const type = (document.querySelector('[data-field="type"]')?.value || "").trim();
          const maxPersons = parseInt(document.querySelector('[data-field="maxPersons"]')?.value, 10) || 1;
          const pricePerPerson = parseFloat(document.querySelector('[data-field="pricePerPerson"]')?.value) || 0;

          if(!name || !date || !type) return alert("T√§yt√§ pakolliset kent√§t (nimi, p√§iv√§, tyyppi).");

          if(state.editSailingId){
            const i = state.sailings.findIndex(x=>x.id===state.editSailingId);
            if(i>=0){
              const keepSessions = Array.isArray(state.sailings[i].sessions) ? state.sailings[i].sessions : [];
              state.sailings[i] = {
                ...state.sailings[i],
                name, date, type,
                maxPersons: Math.max(1, maxPersons),
                pricePerPerson: Math.max(0, pricePerPerson),
                sessions: keepSessions
              };
            }
          } else {
            state.sailings.push({
              id: makeId("S"),
              name, date, type,
              maxPersons: Math.max(1, maxPersons),
              pricePerPerson: Math.max(0, pricePerPerson),
              sessions: []
            });
          }

          save();
          state.modal=null;
          state.editSailingId=null;
          // jos laskutuksessa ei ole valintaa, valitse t√§m√§
          if(!state.invoice.sailingId) state.invoice.sailingId = state.sailings[state.sailings.length-1].id;
          render();
          return;
        }

        // Poistot
        if(a==="delete-customer"){
          if(!confirm("Poistetaanko asiakas?")) return;
          state.customers = state.customers.filter(c=>c.id!==itemId);
          save();
          render();
          return;
        }

        if(a==="delete-sailing"){
          if(!confirm("Poistetaanko purjehdus?")) return;
          state.sailings = state.sailings.filter(s=>s.id!==itemId);
          if(state.openSailingId===itemId) state.openSailingId=null;
          // asiakkaiden sailingId j√§tet√§√§n ennalleen (n√§kyy tyhj√§n√§ jos purjehdus poistuu)
          save();
          render();
          return;
        }

        // Laskutus ‚Äì toiminnot
        if(a==="new-invoice-no"){
          state.invoice.invoiceNo = genInvoiceNo();
          render();
          return;
        }

        if(a==="print-invoice"){
          window.print();
          return;
        }

        if(a==="copy-invoice-text"){
          const sailing = state.sailings.find(s=>s.id===state.invoice.sailingId) || null;
          const rate = vatRateForSailing(sailing);
          const ratePct = Math.round(rate*1000)/10;

          const box = document.getElementById("invoiceBox");
          // Lyhyt teksti (ei koko HTML)
          const txtParts = [];
          txtParts.push(`LASKU ${state.invoice.invoiceNo} (${state.invoice.invoiceDate})`);
          txtParts.push(`Myyj√§: ${ISSUER.name}, Y-tunnus ${ISSUER.businessId}`);
          if(sailing) txtParts.push(`Tapahtuma: ${sailing.name} (${fmtDate(sailing.date)}) ‚Ä¢ ${sailing.type}`);
          txtParts.push(`ALV: ${ratePct}% (hinnat sis. ALV)`);
          txtParts.push(`‚Äî`);
          // Kaiva rivit taulukosta n√§kyv√§n√§ tekstin√§ (varmistaa ett√§ vastaa n√§ytt√∂√§)
          if(box){
            const rows = Array.from(box.querySelectorAll("table.table tbody tr"));
            for(const r of rows){
              const cols = Array.from(r.querySelectorAll("td")).map(x=>x.innerText.trim());
              if(cols.length===4) txtParts.push(`${cols[0]} | ${cols[1]} | ${cols[2]} | ${cols[3]}`);
            }
            // Erittely (netto/alv/brutto)
            const kv = Array.from(box.querySelectorAll(".note .kv div")).map(x=>x.innerText.trim());
            // kv on paritettu: label,value,label,value...
            if(kv.length>=6){
              txtParts.push(`‚Äî`);
              for(let i=0;i<kv.length;i+=2){
                txtParts.push(`${kv[i]}: ${kv[i+1]||""}`);
              }
            }
          }
          const text = txtParts.join("\n");
          navigator.clipboard?.writeText(text).then(
            ()=>alert("Laskuteksti kopioitu leikep√∂yd√§lle."),
            ()=>alert("Kopiointi ep√§onnistui (Safari-asetus). Voit my√∂s ottaa kuvakaappauksen tai k√§ytt√§√§ tulostusta.")
          );
          return;
        }
      };
    });

    // Hakukent√§t
    const sc=document.querySelector('[data-action="search-customers"]');
    if(sc){
      sc.oninput=e=>{ state.searchCustomers=e.target.value; render(); };
      sc.onkeydown=e=>{ if(e.key==="Enter") e.preventDefault(); };
    }

    const ss=document.querySelector('[data-action="search-sailings"]');
    if(ss){
      ss.oninput=e=>{ state.searchSailings=e.target.value; render(); };
      ss.onkeydown=e=>{ if(e.key==="Enter") e.preventDefault(); };
    }

    // Laskutus selectit
    const invS = document.querySelector('[data-action="invoice-sailing"]');
    if(invS){
      invS.onchange = (e)=>{ state.invoice.sailingId = e.target.value; state.invoice.companyKey=""; render(); };
    }
    const invM = document.querySelector('[data-action="invoice-mode"]');
    if(invM){
      invM.onchange = (e)=>{ state.invoice.mode = e.target.value; render(); };
    }
    const invC = document.querySelector('[data-action="invoice-company"]');
    if(invC){
      invC.onchange = (e)=>{ state.invoice.companyKey = e.target.value; render(); };
    }
    const invD = document.querySelector('[data-action="invoice-date"]');
    if(invD){
      invD.onchange = (e)=>{ state.invoice.invoiceDate = e.target.value || today(); render(); };
    }
  }

  // init
  load();
  render();
})();
</script>
</body>
</html>
