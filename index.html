
<!-- STABLE v2.0 ‚Äì enrollments (ilmoittautumiset) + migraatio + varmuuskopio + palautus -->
<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Absolut 37 ‚Äî Tilaukset</title>

<style>
:root{
  --navy:#234c78;
  --bg:#f3f5f7;
  --card:#ffffff;
  --muted:#6b7280;
  --line:#e5e7eb;
  --btn:#1f4b7a;
  --btn2:#eef2f7;
  --danger-bg:#fde2e2;
  --danger:#991b1b;
  --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111827}
header{background:var(--navy);color:#fff;padding:18px 20px}
header h1{margin:0;font-size:32px}
header .sub{margin-top:6px;opacity:.85;font-size:14px}
nav{background:#fff;border-bottom:1px solid var(--line);display:flex;flex-wrap:wrap}
nav button{
  flex:1;min-width:140px;padding:12px;border:0;background:#fff;font-weight:700;
  border-bottom:3px solid transparent;cursor:pointer;color:#374151
}
nav button.active{border-bottom-color:var(--navy);color:#111827}
main{max-width:980px;margin:0 auto;padding:18px}
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:18px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.row.between{justify-content:space-between}
.btn{border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--btn);color:#fff}
.btn.secondary{background:var(--btn2);color:#111827}
.btn.danger{background:var(--danger-bg);color:var(--danger)}
.muted{color:var(--muted)}
.hr{border-top:1px solid var(--line);margin:14px 0}
input,select{
  width:100%;padding:10px;border:1px solid var(--line);
  border-radius:10px;font-size:15px;background:#fff
}
label{display:block;font-size:13px;font-weight:800;margin-bottom:6px;color:#374151}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:800px){.grid2{grid-template-columns:1fr}}
.item{display:flex;justify-content:space-between;gap:12px;padding:12px 0;border-top:1px solid var(--line)}
.item:first-child{border-top:0}
.item h3{margin:0 0 4px 0;font-size:18px}
.meta{font-size:14px;color:var(--muted)}
.pill{background:#eef2ff;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;margin-left:8px;display:inline-block}

/* T√§ytt√∂aste */
.fillrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:6px}
.fillbar{flex:1;min-width:140px;height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
.fillbar > div{height:100%}
.filltext{font-size:13px;color:var(--muted);font-weight:900;white-space:nowrap}

/* Modal */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:18px}
.modal{background:#fff;border-radius:16px;border:1px solid var(--line);width:min(680px,100%);overflow:hidden}
.modal header{background:#fff;color:#111;border-bottom:1px solid var(--line);padding:16px}
.modal header h2{margin:0;font-size:18px}
.modal .body{padding:18px}

/* Kurssip√§iv√§t */
.sessionbox{margin:10px 0 16px 0;padding:12px;background:#f8fafc;border-radius:12px;border:1px solid var(--line)}
.sessionhead{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.sessionitem{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;padding:8px 0;border-top:1px dashed #dbe2ea}
.sessionitem:first-child{border-top:0;padding-top:0}
.sessionmeta{font-size:13px;color:var(--muted)}
.small{font-size:12px}
.note{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:12px 14px}
</style>
</head>
<body>

<div id="app"></div>

<script>
(() => {
  // N√§yt√§ virheet ruudulla (helpottaa iPadilla)
  window.onerror = function(msg, src, line, col, err){
    const el = document.getElementById("app");
    if (!el) return;
    el.innerHTML =
      "<pre style='padding:16px;color:#b00020;white-space:pre-wrap'>" +
      "JS ERROR:\n" + msg + "\n" +
      (src || "") + ":" + line + ":" + col + "\n\n" +
      (err && err.stack ? err.stack : "") +
      "</pre>";
  };

  const APP_VERSION = "2.0";
  const STORAGE_KEY = "absolut37_stable_v2_0";

  // Lis√§√§ tarvittaessa uusia tyyppej√§
  const SAILING_TYPES = ["Iltapurjehdus","P√§iv√§purjehdus","Charter","Kurssi","Yritystilaisuus","Muu","Purjehdusretki"];

  const state = {
    tab: "dashboard",
    customers: [],
    sailings: [],
    enrollments: [],   // UUSI: ilmoittautumiset
    companies: [],     // valmiina my√∂hemp√§√§ varten
    modal: null,       // "customer" | "sailing" | null
    searchCustomers: "",
    searchSailings: "",
    openSailingId: null
  };

  function id(p){ return p + Math.random().toString(16).slice(2,8).toUpperCase(); }

  function esc(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }

  function today(){ return new Date().toISOString().slice(0,10); }

  function fmtDate(d){ return d ? new Date(d+"T00:00:00").toLocaleDateString("fi-FI") : ""; }

  function getVatRateByType(type){
    return (String(type||"").toLowerCase() === "charter") ? 0.135 : 0.255;
  }

  function ensureSailingVatRate(s){
    if (!s) return;
    if (typeof s.vatRate !== "number") s.vatRate = getVatRateByType(s.type);
  }

  function enrolledCount(eventId){
    return state.enrollments.filter(e => e.eventId === eventId).length;
  }

  function fillUI(booked, max){
    const m = Math.max(1, Number(max || 0) || 1);
    const b = Math.max(0, Number(booked || 0) || 0);
    const pct = Math.max(0, Math.min(100, Math.round((b / m) * 100)));
    const color = pct >= 100 ? "#ef4444" : (pct >= 67 ? "#f59e0b" : "#22c55e");

    return `
      <div class="fillrow">
        <div class="fillbar"><div style="width:${pct}%;background:${color}"></div></div>
        <div class="filltext">${b} / ${m} (${pct}%)</div>
      </div>
    `;
  }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      version: APP_VERSION,
      customers: state.customers,
      sailings: state.sailings,
      enrollments: state.enrollments,
      companies: state.companies
    }));
  }

  // Migraatio: jos vanha data sis√§lt√§√§ customer.sailingId, tehd√§√§n siit√§ enrollment
  function migrateOldCustomerLinksToEnrollments(){
    let changed = false;

    // varmista vatRate jokaiselle purjehdukselle
    state.sailings.forEach(s => {
      if (typeof s.vatRate !== "number") { s.vatRate = getVatRateByType(s.type); changed = true; }
      if (!Array.isArray(s.sessions)) { s.sessions = []; changed = true; }
    });

    state.customers.forEach(c => {
      if (c && c.sailingId) {
        const eventId = c.sailingId;
        const s = state.sailings.find(x => x.id === eventId);

        // luo enrollment vain jos ei jo ole (varmistus)
        const already = state.enrollments.some(e => e.customerId === c.id && e.eventId === eventId);
        if (!already) {
          const unitGross = s ? Number(s.pricePerPerson || s.pricePerPersonGross || 0) : 0;
          const vatRate = s ? (typeof s.vatRate === "number" ? s.vatRate : getVatRateByType(s.type)) : 0.255;

          state.enrollments.push({
            id: id("E"),
            eventId,
            customerId: c.id,
            qty: 1,
            payerType: "customer",
            payerCompanyId: null,
            unitPriceGross: unitGross,
            vatRate: vatRate,
            commission: { type:"percent", value: 0 },
            commissionAppliedGross: 0,
            notes: "",
            createdAtISO: new Date().toISOString()
          });
          changed = true;
        }

        // poista vanha linkki
        delete c.sailingId;
        changed = true;
      }
    });

    if (changed) save();
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const data = JSON.parse(raw);
        state.customers   = Array.isArray(data.customers) ? data.customers : [];
        state.sailings    = Array.isArray(data.sailings) ? data.sailings : [];
        state.enrollments = Array.isArray(data.enrollments) ? data.enrollments : [];
        state.companies   = Array.isArray(data.companies) ? data.companies : [];
      }
    }catch(e){}

    // Seed jos tyhj√§
    if(state.customers.length===0 && state.sailings.length===0 && state.enrollments.length===0){
      const sid = id("S");
      const sail = {
        id:sid,
        name:"Iltapurjehdus Suomenlinna",
        date:today(),
        type:"Iltapurjehdus",
        maxPersons:6,
        pricePerPerson:120,       // brutto
        vatRate: getVatRateByType("Iltapurjehdus"),
        sessions:[]
      };
      state.sailings.push(sail);

      const cid = id("C");
      state.customers.push({
        id: cid,
        name:"Testi Seppo",
        phone:"04012345678",
        email:"joku@joku.net"
      });

      state.enrollments.push({
        id: id("E"),
        eventId: sid,
        customerId: cid,
        qty: 1,
        payerType: "customer",
        payerCompanyId: null,
        unitPriceGross: Number(sail.pricePerPerson||0),
        vatRate: sail.vatRate,
        commission: { type:"percent", value: 0 },
        commissionAppliedGross: 0,
        notes: "",
        createdAtISO: new Date().toISOString()
      });

      save();
    }

    // varmistukset + migraatio
    migrateOldCustomerLinksToEnrollments();
  }

  function render(){
    // s√§ilyt√§ fokus+kursori kun render√∂id√§√§n (iPad/Safari)
    const ae = document.activeElement;
    const keep = {
      action: ae && ae.dataset ? ae.dataset.action : null,
      field:  ae && ae.dataset ? ae.dataset.field  : null,
      pos:    (ae && typeof ae.selectionStart==="number") ? ae.selectionStart : null
    };

    document.getElementById("app").innerHTML =
      renderHeader() + renderNav() +
      "<main>" + renderTab() + "</main>" +
      renderModal() +
      renderHiddenFileInput();

    bind();

    const sel = keep.action ? `[data-action="${keep.action}"]` :
                keep.field  ? `[data-field="${keep.field}"]`  : null;

    if(sel){
      const el = document.querySelector(sel);
      if(el && typeof el.focus==="function"){
        el.focus();
        if(keep.pos!==null && typeof el.setSelectionRange==="function"){
          el.setSelectionRange(keep.pos, keep.pos);
        }
      }
    }
  }

  function renderHeader(){
    return `<header>
      <h1>Absolut 37</h1>
      <div class="sub">Tilauksen hallinta</div>
    </header>`;
  }

  function renderNav(){
    const tabs = [
      ["dashboard","Dashboard"],
      ["sailings","Purjehdukset"],
      ["customers","Asiakkaat"]
    ];
    return `<nav>` +
      tabs.map(([id,label]) =>
        `<button data-tab="${id}" class="${state.tab===id?"active":""}">${label}</button>`
      ).join("") +
      `</nav>`;
  }

  function renderTab(){
    if(state.tab==="dashboard") return renderDashboard();
    if(state.tab==="customers") return renderCustomers();
    if(state.tab==="sailings")  return renderSailings();
    return "";
  }

  function renderDashboard(){
    return `<div class="card">
      <div class="row between">
        <div>
          <h2 style="margin:0 0 6px 0">Dashboard</h2>
          <div class="muted">V2: Ilmoittautumiset (enrollments) k√§yt√∂ss√§.</div>
        </div>
        <div class="row">
          <button class="btn secondary" data-action="backup-json">üíæ Varmuuskopio (JSON)</button>
          <button class="btn secondary" data-action="restore-json">‚Ü©Ô∏è Palauta (JSON)</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row" style="gap:18px">
        <div class="note">
          <div style="font-weight:900">Asiakkaita</div>
          <div style="font-size:28px;font-weight:950">${state.customers.length}</div>
        </div>
        <div class="note">
          <div style="font-weight:900">Purjehduksia</div>
          <div style="font-size:28px;font-weight:950">${state.sailings.length}</div>
        </div>
        <div class="note">
          <div style="font-weight:900">Ilmoittautumisia</div>
          <div style="font-size:28px;font-weight:950">${state.enrollments.length}</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="muted small">
        Tallennus: localStorage (t√§h√§n laitteeseen). Varmuuskopio sis√§lt√§√§: customers, sailings, enrollments, companies.
      </div>
    </div>`;
  }

  function renderCustomers(){
    const term = (state.searchCustomers||"").toLowerCase().trim();

    const list = state.customers
      .filter(c =>
        !term ||
        (c.name||"").toLowerCase().includes(term) ||
        (c.phone||"").toLowerCase().includes(term) ||
        (c.email||"").toLowerCase().includes(term)
      );

    // viimeisin enrollment per asiakas (vain n√§ytt√∂√∂n)
    function latestEnrollmentForCustomer(cid){
      const arr = state.enrollments.filter(e => e.customerId === cid);
      if (arr.length === 0) return null;
      arr.sort((a,b) => String(b.createdAtISO||"").localeCompare(String(a.createdAtISO||"")));
      return arr[0];
    }

    return `<div class="card">
      <div class="row between">
        <div>
          <h2 style="margin:0 0 6px 0">Asiakkaat</h2>
          <div class="muted">Asiakkaan liitt√§minen purjehdukseen tehd√§√§n ilmoittautumisella.</div>
        </div>
        <button class="btn primary" data-action="new-customer">+ Lis√§√§ asiakas</button>
      </div>

      <div class="hr"></div>

      <label>Haku</label>
      <input data-action="search-customers" value="${esc(state.searchCustomers)}" placeholder="Hae nimell√§ / puhelin / email">

      <div class="hr"></div>

      ${list.length===0 ? `<div class="muted">Ei osumia.</div>` : `
        ${list.map(c=>{
          const e = latestEnrollmentForCustomer(c.id);
          const s = e ? state.sailings.find(x=>x.id===e.eventId) : null;
          return `
            <div class="item">
              <div>
                <h3>
                  ${esc(c.name||"")}
                  ${s ? `<span class="pill">${esc(s.name||"")}</span>` : ""}
                </h3>
                <div class="meta">${esc(c.phone||"")}${(c.phone&&c.email)?" ‚Ä¢ ":""}${esc(c.email||"")}</div>
              </div>
              <button class="btn danger" data-action="delete-customer" data-id="${c.id}">Poista</button>
            </div>
          `;
        }).join("")}
      `}
    </div>`;
  }

  function renderSailings(){
    const term = (state.searchSailings || "").toLowerCase().trim();

    const list = state.sailings
      .slice()
      .sort((a,b)=>(a.date||"").localeCompare(b.date||""))
      .filter(s =>
        !term ||
        (s.name||"").toLowerCase().includes(term) ||
        (s.type||"").toLowerCase().includes(term) ||
        (s.date||"").includes(term)
      );

    return `<div class="card">
      <div class="row between">
        <div>
          <h2 style="margin:0 0 6px 0">Purjehdukset</h2>
          <div class="muted">T√§ytt√∂aste ja ilmoittautuneet lasketaan enrollments-taulusta.</div>
        </div>
        <button class="btn primary" data-action="new-sailing">+ Lis√§√§</button>
      </div>

      <div class="hr"></div>

      <label>Haku</label>
      <input data-action="search-sailings" value="${esc(state.searchSailings||"")}" placeholder="Hae nimell√§ / tyypill√§ / p√§iv√§ll√§">

      <div class="hr"></div>

      ${list.map(s => {
        ensureSailingVatRate(s);

        const booked = enrolledCount(s.id);
        const max = Number(s.maxPersons || 0) || 0;

        const sessions = Array.isArray(s.sessions) ? s.sessions : [];
        const sessionsUI = (s.type === "Kurssi")
          ? `
            <div class="sessionbox">
              <div class="sessionhead">
                <div style="font-weight:950">Kurssip√§iv√§t</div>
                <button class="btn secondary" data-action="add-session" data-id="${s.id}">+ Lis√§√§ p√§iv√§</button>
              </div>

              ${sessions.length === 0 ? `<div class="muted">Ei p√§ivi√§ lis√§ttyn√§.</div>` : `
                ${sessions.map((x, idx) => `
                  <div class="sessionitem">
                    <div>
                      <div style="font-weight:900">
                        ${esc(x.date || "")}
                        ${x.start ? " klo "+esc(x.start) : ""}${x.end ? "‚Äì"+esc(x.end) : ""}
                      </div>
                      ${x.note ? `<div class="sessionmeta">${esc(x.note)}</div>` : ``}
                    </div>
                    <button class="btn danger" data-action="delete-session" data-id="${s.id}" data-idx="${idx}">Poista</button>
                  </div>
                `).join("")}
              `}
            </div>
          `
          : "";

        const attendeesUI = (state.openSailingId === s.id)
          ? `
            <div style="margin:8px 0 16px 0;padding:12px;background:#f8fafc;border-radius:12px;border:1px solid var(--line)">
              ${state.enrollments
                .filter(e => e.eventId === s.id)
                .map(e => {
                  const c = state.customers.find(x => x.id === e.customerId);
                  return `<div style="padding:6px 0;border-top:1px dashed #dbe2ea">${esc(c ? c.name : ("(puuttuva asiakas) "+e.customerId))}</div>`;
                })
                .join("") || `<div class="muted">Ei ilmoittautuneita</div>`}
            </div>
          `
          : "";

        const gross = Number(s.pricePerPerson || 0);
        const vatPct = Math.round((Number(s.vatRate||0) * 1000))/10; // esim 25.5

        return `
          <div class="item">
            <div style="flex:1">
              <h3>
                ${esc(s.name||"")}
                <span class="pill">${esc(s.type||"")}</span>
              </h3>

              <div class="meta">
                ${fmtDate(s.date)} ‚Ä¢ Max ${Number(s.maxPersons||0)} hl√∂
                ‚Ä¢ ${gross.toFixed(2)} ‚Ç¨/hl√∂ (ALV ${vatPct}%)
                ‚Ä¢ Ilmoittautuneet: ${booked}
              </div>

              ${fillUI(booked, max)}
              ${sessionsUI}
            </div>

            <div class="row" style="align-items:flex-start">
              <button class="btn secondary" data-action="toggle-sailing" data-id="${s.id}">
                ${state.openSailingId === s.id ? "Piilota asiakkaat" : "N√§yt√§ asiakkaat"}
              </button>
              <button class="btn danger" data-action="delete-sailing" data-id="${s.id}">Poista</button>
            </div>
          </div>

          ${attendeesUI}
        `;
      }).join("")}
    </div>`;
  }

  function renderModal(){
    if(!state.modal) return "";

    if(state.modal==="customer"){
      // T√§ss√§ vaiheessa: luodaan asiakas + (valinnainen) ilmoittautuminen
      return `<div class="overlay" data-action="close-modal">
        <div class="modal" onclick="event.stopPropagation()">
          <header>
            <div class="row between">
              <h2>Uusi asiakas</h2>
              <button class="btn secondary" data-action="close-modal">Sulje</button>
            </div>
          </header>
          <div class="body">
            <div class="grid2">
              <div>
                <label>Nimi *</label>
                <input data-field="name" value="" placeholder="Etunimi Sukunimi">
              </div>
              <div>
                <label>Puhelin</label>
                <input data-field="phone" value="" placeholder="0401234567">
              </div>
            </div>

            <div style="margin-top:12px">
              <label>Email</label>
              <input data-field="email" value="" placeholder="nimi@esimerkki.fi">
            </div>

            <div style="margin-top:12px">
              <label>Liit√§ purjehdukseen (valinnainen)</label>
              <select data-field="eventId">
                <option value="">-- Ei valittu --</option>
                ${state.sailings
                  .slice()
                  .sort((a,b)=>(a.date||"").localeCompare(b.date||""))
                  .map(s=>`<option value="${s.id}">${esc(s.name)} (${fmtDate(s.date)})</option>`)
                  .join("")}
              </select>
              <div class="muted small" style="margin-top:6px">
                Jos valitset purjehduksen, j√§rjestelm√§ luo samalla ilmoittautumisen.
              </div>
            </div>

            <div class="row" style="justify-content:flex-end;margin-top:14px">
              <button class="btn primary" data-action="save-customer">Tallenna</button>
            </div>
          </div>
        </div>
      </div>`;
    }

    if(state.modal==="sailing"){
      return `<div class="overlay" data-action="close-modal">
        <div class="modal" onclick="event.stopPropagation()">
          <header>
            <div class="row between">
              <h2>Uusi purjehdus</h2>
              <button class="btn secondary" data-action="close-modal">Sulje</button>
            </div>
          </header>
          <div class="body">
            <label>Nimi *</label>
            <input data-field="name" value="" placeholder="esim. Iltapurjehdus Suomenlinna">

            <div class="grid2" style="margin-top:12px">
              <div>
                <label>P√§iv√§ *</label>
                <input type="date" data-field="date" value="${today()}">
              </div>
              <div>
                <label>Tyyppi *</label>
                <select data-field="type">
                  ${SAILING_TYPES.map(t=>`<option value="${esc(t)}">${esc(t)}</option>`).join("")}
                </select>
              </div>
            </div>

            <div class="grid2" style="margin-top:12px">
              <div>
                <label>Max hl√∂ *</label>
                <input type="number" data-field="maxPersons" value="6" min="1" step="1">
              </div>
              <div>
                <label>Hinta/hl√∂ (sis. ALV) *</label>
                <input type="number" data-field="pricePerPerson" value="0" min="0" step="0.01">
              </div>
            </div>

            <div class="muted small" style="margin-top:8px">
              ALV: Charter 13,5% ‚Ä¢ muut 25,5% (lasketaan tyypin perusteella).
            </div>

            <div class="row" style="justify-content:flex-end;margin-top:14px">
              <button class="btn primary" data-action="save-sailing">Tallenna</button>
            </div>
          </div>
        </div>
      </div>`;
    }

    return "";
  }

  function renderHiddenFileInput(){
    return `<input id="restoreFile" type="file" accept="application/json" style="display:none" data-action="restore-file" />`;
  }

  function bind(){
    // tabit
    document.querySelectorAll("[data-tab]").forEach(b=>{
      b.onclick=()=>{ state.tab=b.dataset.tab; render(); };
    });

    // click-actionit
    document.querySelectorAll("[data-action]").forEach(el=>{
      el.onclick=()=>{
        const a = el.dataset.action;
        const itemId = el.dataset.id;
        const idx = (typeof el.dataset.idx !== "undefined") ? Number(el.dataset.idx) : null;

        if(a==="new-customer"){ state.modal="customer"; render(); return; }
        if(a==="new-sailing"){ state.modal="sailing"; render(); return; }
        if(a==="close-modal"){ state.modal=null; render(); return; }

        if(a==="toggle-sailing"){
          state.openSailingId = (state.openSailingId===itemId) ? null : itemId;
          render();
          return;
        }

        if(a==="add-session"){
          const s = state.sailings.find(x => x.id === itemId);
          if(!s) return;

          const date = prompt("Kurssip√§iv√§ (YYYY-MM-DD):", today());
          if(!date) return;

          const start = prompt("Aloitusaika (HH:MM), tyhj√§ sallittu:", "17:00") || "";
          const end = prompt("Lopetusaika (HH:MM), tyhj√§ sallittu:", "20:00") || "";
          const note = prompt("Lis√§huomio (valinnainen):", "") || "";

          if(!Array.isArray(s.sessions)) s.sessions = [];
          s.sessions.push({ date, start, end, note });

          save();
          render();
          return;
        }

        if(a==="delete-session"){
          const s = state.sailings.find(x => x.id === itemId);
          if(!s || !Array.isArray(s.sessions)) return;
          if(idx===null || Number.isNaN(idx)) return;

          if(!confirm("Poistetaanko kurssip√§iv√§?")) return;

          s.sessions.splice(idx, 1);
          save();
          render();
          return;
        }

        if(a==="save-customer"){
          const name = (document.querySelector('[data-field="name"]')?.value || "").trim();
          if(!name) return alert("Nimi pakollinen");

          const phone = (document.querySelector('[data-field="phone"]')?.value || "").trim();
          const email = (document.querySelector('[data-field="email"]')?.value || "").trim();
          const eventId = (document.querySelector('[data-field="eventId"]')?.value || "");

          // luo asiakas
          const cid = id("C");
          state.customers.push({ id: cid, name, phone, email });

          // valinnainen: luo enrollment
          if (eventId) {
            const s = state.sailings.find(x => x.id === eventId);
            if (s) {
              ensureSailingVatRate(s);

              // EST√Ñ YLIBUUKKAUS
              const max = Number(s.maxPersons || 0) || 0;
              const booked = enrolledCount(eventId);
              if (max > 0 && booked >= max) {
                // perutaan enrollment, mutta asiakas j√§√§ rekisteriin
                alert(`Purjehdus on t√§ynn√§ (${booked}/${max}). Asiakas luotiin, mutta ilmoittautumista ei tehty.`);
              } else {
                state.enrollments.push({
                  id: id("E"),
                  eventId: eventId,
                  customerId: cid,
                  qty: 1,
                  payerType: "customer",
                  payerCompanyId: null,
                  unitPriceGross: Number(s.pricePerPerson || 0),
                  vatRate: typeof s.vatRate === "number" ? s.vatRate : getVatRateByType(s.type),
                  commission: { type:"percent", value: 0 },
                  commissionAppliedGross: 0,
                  notes: "",
                  createdAtISO: new Date().toISOString()
                });
              }
            }
          }

          save();
          state.modal=null;
          render();
          return;
        }

        if(a==="save-sailing"){
          const name = (document.querySelector('[data-field="name"]')?.value || "").trim();
          const date = (document.querySelector('[data-field="date"]')?.value || "").trim();
          const type = (document.querySelector('[data-field="type"]')?.value || "").trim();
          const maxPersons = parseInt(document.querySelector('[data-field="maxPersons"]')?.value, 10) || 1;
          const pricePerPerson = parseFloat(document.querySelector('[data-field="pricePerPerson"]')?.value) || 0;

          if(!name || !date || !type) return alert("T√§yt√§ pakolliset kent√§t (nimi, p√§iv√§, tyyppi).");

          const vatRate = getVatRateByType(type);

          state.sailings.push({
            id: id("S"),
            name,
            date,
            type,
            maxPersons,
            pricePerPerson, // brutto
            vatRate,
            sessions: []
          });

          save();
          state.modal=null;
          render();
          return;
        }

        if(a==="delete-customer"){
          const cid = itemId;
          if(!confirm("Poistetaanko asiakas? (My√∂s h√§nen ilmoittautumisensa poistetaan)")) return;

          state.customers = state.customers.filter(c=>c.id!==cid);
          state.enrollments = state.enrollments.filter(e=>e.customerId!==cid);

          save();
          render();
          return;
        }

        if(a==="delete-sailing"){
          const sid = itemId;
          if(!confirm("Poistetaanko purjehdus? (Ilmoittautumiset t√§h√§n purjehdukseen poistetaan)")) return;

          state.sailings = state.sailings.filter(s=>s.id!==sid);
          state.enrollments = state.enrollments.filter(e=>e.eventId!==sid);

          if(state.openSailingId===sid) state.openSailingId=null;

          save();
          render();
          return;
        }

        if(a==="backup-json"){
          const data = {
            app: "Absolut37",
            version: APP_VERSION,
            exportDate: new Date().toISOString(),
            customers: state.customers,
            sailings: state.sailings,
            enrollments: state.enrollments,
            companies: state.companies
          };

          const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
          const url = URL.createObjectURL(blob);
          const x = document.createElement("a");
          x.href = url;
          x.download = "absolut37_backup_" + new Date().toISOString().slice(0,10) + ".json";
          x.click();
          URL.revokeObjectURL(url);
          return;
        }

        if(a==="restore-json"){
          // avaa tiedoston valinta
          const inp = document.getElementById("restoreFile");
          if (inp) inp.click();
          return;
        }
      };
    });

    // Palautus: tiedoston luku
    const restoreInp = document.getElementById("restoreFile");
    if (restoreInp) {
      restoreInp.onchange = async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        try{
          const text = await file.text();
          const data = JSON.parse(text);

          // minimivalidointi
          const customers = Array.isArray(data.customers) ? data.customers : null;
          const sailings = Array.isArray(data.sailings) ? data.sailings : null;
          const enrollments = Array.isArray(data.enrollments) ? data.enrollments : [];
          const companies = Array.isArray(data.companies) ? data.companies : [];

          if (!customers || !sailings) {
            alert("Palautus ep√§onnistui: JSON ei sis√§ll√§ customers + sailings -listoja.");
            restoreInp.value = "";
            return;
          }

          if (!confirm("Palautetaanko varmuuskopio? T√§m√§ korvaa t√§m√§n laitteen nykyiset tiedot.")) {
            restoreInp.value = "";
            return;
          }

          state.customers = customers;
          state.sailings = sailings;
          state.enrollments = enrollments;
          state.companies = companies;

          // varmista kentti√§ + migraatio
          migrateOldCustomerLinksToEnrollments();
          save();

          alert("Palautus valmis.");
          state.tab = "dashboard";
          state.modal = null;
          state.openSailingId = null;
          render();

        }catch(err){
          alert("Palautus ep√§onnistui: " + (err && err.message ? err.message : String(err)));
        } finally {
          restoreInp.value = "";
        }
      };
    }

    // hakukent√§t
    const sc = document.querySelector('[data-action="search-customers"]');
    if(sc){
      sc.oninput = e => { state.searchCustomers = e.target.value; render(); };
      sc.onkeydown = e => { if(e.key==="Enter") e.preventDefault(); };
    }

    const ss = document.querySelector('[data-action="search-sailings"]');
    if(ss){
      ss.oninput = e => { state.searchSailings = e.target.value; render(); };
      ss.onkeydown = e => { if(e.key==="Enter") e.preventDefault(); };
    }
  }

  // init
  load();
  render();

})();
</script>
</body>
</html>
